<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="henry">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/05/11/angr-学习笔记/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="Reference： https:&#x2F;&#x2F;arttnba3.cn&#x2F;2022&#x2F;11&#x2F;24&#x2F;ANGR-0X00-ANGR_CTF&#x2F;  angr_ctf 笔记一、环境搭建安装依赖： 1sudo apt-get install gcc-multilib    安装angr： 1sudo pip3 install angr    题目环境： 1git clone https:&#x2F;&#x2F;github.com&#x2F;jakes">
<meta property="og:type" content="article">
<meta property="og:title" content="angr 学习笔记">
<meta property="og:url" content="http://example.com/2024/05/11/angr-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Reference： https:&#x2F;&#x2F;arttnba3.cn&#x2F;2022&#x2F;11&#x2F;24&#x2F;ANGR-0X00-ANGR_CTF&#x2F;  angr_ctf 笔记一、环境搭建安装依赖： 1sudo apt-get install gcc-multilib    安装angr： 1sudo pip3 install angr    题目环境： 1git clone https:&#x2F;&#x2F;github.com&#x2F;jakes">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_01-07-13.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_01-42-01.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_01-40-56.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_02-02-27.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_02-03-26.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_02-04-28.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_02-04-35.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_02-06-51.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_11-31-24.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_11-38-09.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_11-40-22.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_16-48-12.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_17-32-49.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_17-37-17.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_17-52-49.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-07_17-55-37.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-08_01-00-55.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-08_01-14-49.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-08_01-28-11.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-08_02-01-02.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-08_01-59-50.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_15-17-39.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_15-19-59.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_15-23-46.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_15-32-17.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_17-38-16.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_17-48-10.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_22-50-56.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_22-51-50.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_22-58-37.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_23-27-47.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-10_23-32-19.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_13-32-55.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_13-52-54.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_15-07-28.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_15-20-03.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_15-20-26.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_15-43-57.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_15-45-02.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_16-12-32.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_17-15-46.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_17-17-02.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_17-30-38.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_17-59-16.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_21-03-31.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-05-11_22-24-45.png">
<meta property="article:published_time" content="2024-05-11T14:42:25.677Z">
<meta property="article:modified_time" content="2024-05-11T14:47:59.398Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="angr">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Snipaste_2024-05-07_01-07-13.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/icon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/icon.png">
    <!--- Page Info-->
    
    <title>
        
            angr 学习笔记 -
        
        Henry Martin
    </title>
    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-we3z86.webp","dark":"/images/wallhaven-6degr6.webp"},"title":"Welcome To Henry's Blog","subtitle":{"text":["a pwner from polaris"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/henrymartin262","instagram":"https://instagram.com","zhihu":"https://www.zhihu.com/","twitter":"https://twitter.com","email":"1551022913@qq.cmo"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":true,"type":"fixed","audios":[{"name":"Something Just Like This","artist":"Coldplay","url":"https://evan.beee.top/music/Something%20Just%20Like%20This%20-%20The%20Chainsmokers%E3%80%81Coldplay.mp3","cover":"https://evan.beee.top/music/covers/Something_Just_Like_This.png"}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.5.6","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories/","icon":"fa-regular fa-folder"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Links":"/links/","Github":"https://github.com/henrymartin262","Blog":"https://henrymartin262.github.io"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/11/24 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Henry Martin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories/"  >
                                    
                                        
                                            <i class="fa-regular fa-folder"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-regular fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/links/">LINKS
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer w-full absolute top-0 left-0 bg-background-color">
        <ul class="drawer-navbar-list flex flex-col justify-start items-center">
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/categories/"  >
                             
                                
                                    <i class="fa-regular fa-folder"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/tags"  >
                             
                                
                                    <i class="fa-regular fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="group-hover:rotate-180 transition-transform fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" href="/links/">LINKS</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color text-4xl md:text-6xl font-bold px-2 sm:px-6 md:px-8 py-3">angr 学习笔记</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/henry.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">henry</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-05-11 22:42:25</span>
        <span class="mobile">2024-05-11 22:42:25</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-05-11 22:47:59</span>
            <span class="mobile">2024-05-11 22:47:59</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/angr/">angr</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/angr/angr-CTF/">angr-CTF</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/angr/">angr</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <p><strong>Reference：</strong></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/" >https://arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h1 id="angr-ctf-笔记"><a href="#angr-ctf-笔记" class="headerlink" title="angr_ctf 笔记"></a>angr_ctf 笔记</h1><h2 id="一、环境搭建"><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h2><p>安装依赖：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc-multilib</span><br></pre></td></tr></table></figure></div>



<p>安装angr：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install angr</span><br></pre></td></tr></table></figure></div>



<p>题目环境：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/jakespringer/angr_ctf.git</span><br></pre></td></tr></table></figure></div>



<p>使用说明：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd 00_angr_find/</span><br><span class="line">sudo python3 generate.py</span><br><span class="line">	Usage: ./generate.py [seed] [output_file]</span><br><span class="line">sudo python3 generate.py 654123 00_angr_find</span><br></pre></td></tr></table></figure></div>





<h2 id="二、angr-基本用法"><a href="#二、angr-基本用法" class="headerlink" title="二、angr-基本用法"></a>二、angr-基本用法</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>project = angr.Project(path_to_file)	<span class="comment">#第一步就是创建一个 angr.Project 类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>project.arch			<span class="comment">#返回程序使用的指令架构</span></span><br><span class="line"><span class="comment"># &lt;Arch X86 (LE)&gt;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(project.entry)		<span class="comment">#返回程序入口点</span></span><br><span class="line"><span class="string">&#x27;0x80490b0&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>project.filename		<span class="comment">#返回程序名</span></span><br><span class="line"><span class="string">&#x27;./00_angr_find&#x27;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="factory-实用类工厂"><a href="#factory-实用类工厂" class="headerlink" title="factory-实用类工厂"></a><strong>factory-实用类工厂</strong></h3><p>project.factory 提供了一些类的构造器</p>
<p><strong>（1）block</strong></p>
<p>angr 以基本块为单位分析代码，可以通过 <code>project.factory.block(address)</code> 获取给定地址所在的<strong>基本块，</strong>一个 <code>Block</code> 类实例：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>block = project.factory.block(project.entry)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>block</span><br><span class="line">&lt;Block <span class="keyword">for</span> <span class="number">0x80490b0</span>, <span class="number">20</span> <span class="built_in">bytes</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>block.pp()</span><br><span class="line">         _start:</span><br><span class="line">80490b0  endbr32 </span><br><span class="line">80490b4  xor     ebp, ebp</span><br><span class="line">80490b6  pop     esi</span><br><span class="line">80490b7  mov     ecx, esp</span><br><span class="line">80490b9  <span class="keyword">and</span>     esp, <span class="number">0xfffffff0</span></span><br><span class="line">80490bc  push    eax</span><br><span class="line">80490bd  push    esp</span><br><span class="line">80490be  push    edx</span><br><span class="line">80490bf  call    <span class="number">0x80490dd</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>block.instructions		<span class="comment">#指令个数</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>block.instruction_addrs</span><br><span class="line">(<span class="number">134516912</span>, <span class="number">134516916</span>, <span class="number">134516918</span>, <span class="number">134516919</span>, <span class="number">134516921</span>, <span class="number">134516924</span>, <span class="number">134516925</span>, <span class="number">134516926</span>, <span class="number">134516927</span>)					<span class="comment">#指令对应地址</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br></pre></td></tr></table></figure></div>



<p><strong>（2）state - 模拟执行状态</strong></p>
<p>angr 使用 <code>SimState</code> 类表示一个 <strong>模拟的程序状态</strong> （simulated program state），各种操作实际上是由一个 state 步进到另一个 state 的过程</p>
<p> <code>project.factory.entry_state()</code> ：获取一个程序的<strong>初始执行状态</strong></p>
<p><code>project.factory.blank_state(addr)</code> ：获取一个程序<strong>从指定地址开始执行的空白状态</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_01-07-13.png"
                      alt="nipaste_2024-05-07_01-07-1"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>state = project.factory.entry_state()	<span class="comment">#获得程序初始执行状态</span></span><br><span class="line"><span class="comment"># 寄存器状态组，可以通过寄存器名称来访问对应的寄存器</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.regs</span><br><span class="line">&lt;angr.state_plugins.view.SimRegNameView <span class="built_in">object</span> at <span class="number">0x7fe6a3cccd00</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.regs.esp			<span class="comment"># visit esp		</span></span><br><span class="line">&lt;BV32 <span class="number">0x7ffeffac</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.regs.ebp			<span class="comment"># visit ebp		</span></span><br><span class="line">&lt;BV32 <span class="number">0x0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.regs.eip			<span class="comment"># visit eip</span></span><br><span class="line">&lt;BV32 <span class="number">0x80490b0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.mem[<span class="number">0x80490B0</span>].long	<span class="comment"># 通过 state.mem[addr].type 完成内存访问</span></span><br><span class="line">&lt;long (<span class="number">32</span> bits) &lt;BV32 <span class="number">0xfb1e0ff3</span>&gt; at <span class="number">0x80490b0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.memory.load(<span class="number">0x80490b0</span>, <span class="number">8</span>) <span class="comment"># 获取该地址上指定大小的位向量</span></span><br><span class="line">&lt;BV64 <span class="number">0xf30f1efb31ed5e89</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>state.posix						<span class="comment"># POSIX 相关的环境接口</span></span><br><span class="line">&lt;angr.state_plugins.posix.SimSystemPosix <span class="built_in">object</span> at <span class="number">0x7fe6a3ccca60</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p><code>state.regs</code>：<strong>寄存器状态组</strong>，其中每个寄存器都为一个 <strong>位向量</strong> （BitVector），可以通过寄存器名称来访问对应的寄存器（例如 <code>state.regs.esp -= 12</code> ）</p>
<p><code>state.mem</code>：<strong>该状态的内存访问接口</strong>，可以直接通过 <code>state.mem[addr].type</code> 完成内存访问（例如 <code>state.mem[0x1000].long = 4</code> ，对于读而言还需指定 <code>.resolved</code> 或 <code>.concrete</code> 表示位向量或是实际值，例如 <code>state.mem[0x1000].long.concrete</code>）</p>
<p><code>state.memory</code>：<strong>另一种形式的内存访问接口</strong>：</p>
<ul>
<li><code>state.memory.load(addr, size_in_bytes)</code> ：<strong>获取该地址上指定大小</strong>的位向量</li>
<li><code>state.memory.store(addr, bitvector)</code> ：将一个位向量<strong>存储到指定地址</strong></li>
</ul>
<p><code>state.posix</code>：<strong>POSIX 相关的环境接口</strong>，例如 <code>state.posix.dumps(fileno)</code> 获取对应文件描述符上的流</p>
<p><strong>（3）simulation_manager - 模拟执行器</strong></p>
<p>angr 将一个状态的执行方法独立成一个 <code>SimulationManager</code> 类，以下两种写法等效：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; simgr = project.factory.simgr(state)</span><br><span class="line">&gt;&gt;&gt; simgr = project.factory.simulation_manager(state)</span><br></pre></td></tr></table></figure></div>

<p><code>simgr.step()</code>：<strong>以基本块为单位</strong>的单步执行</p>
<p><code>simgr.explore(addr)</code>：路径探索，即<strong>执行到指定地址</strong>并进行约束求解，将执行完成的状态放在 <code>simgr.found</code> </p>
<p><code>simgr.found</code> ：若无法求解则该列表为空</p>
<h4 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_01-42-01.png"
                      alt="nipaste_2024-05-07_01-42-0"
                ></p>
<p>源程序中会对我们输入的s1进行简单的加密（complex_function），使得加密后的结果需要等于 “RIMNUAWT”，所以我们通过 angr <strong>路径探索</strong>，直接将目的地址设置为 puts(“Good Job.”)，然后求解即可。</p>
<p>最终效果如下所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_01-40-56.png"
                      alt="nipaste_2024-05-07_01-40-5"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">path_to_file = <span class="string">&#x27;./00_angr_find&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># Create an Angr project, subsequent operations are built upon it</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># these two options make angr&#x27;s result more efficient and accurate</span></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create a simulation manager initialized with the starting state. </span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># input addr we want to reach</span></span><br><span class="line">    print_good_address = <span class="number">0x80492F8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># This function will keep executing until it either finds a solution or it </span></span><br><span class="line">    <span class="comment"># has explored every possible path through the executable.</span></span><br><span class="line">    simulation.explore(find = print_good_address)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that we have found a solution</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        <span class="comment"># The explore method stops after it finds a single state that arrives at the</span></span><br><span class="line">        <span class="comment"># target address.</span></span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># Print the string that Angr wrote to stdin to follow solution_state. This </span></span><br><span class="line">        <span class="comment"># is our solution.</span></span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>





<h4 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h4><p>相较于前一题，这题增加了 avoid 参数的使用</p>
<p>通常使用模拟器的 <code>.explore()</code> 方法来进行路径探索，传入的<strong>默认参数</strong>为 find：</p>
<p> <code>find</code> 参数：一个&#x2F;一组令模拟器<strong>终止运行的地址</strong>，符合的执行状态结果会被放到 <code>.found</code> 列表中</p>
<p> <code>avoid</code> 参数：模拟器运行中应当要<strong>避开</strong>的地址，当一个状态执行到这样的地址时，其会被放在 <code>.avoided</code> 列表中并不再往后执行</p>
<p><code>num_find</code> 参数：指定需要<strong>寻找的解状态的数量</strong>，若未指定则会在 <code>.found</code> 列表中存储所有的解状态</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_02-02-27.png"
                      alt="nipaste_2024-05-07_02-02-2"
                ></p>
<p>main函数过大不能反编译，但可以通过汇编找到关键逻辑<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_02-03-26.png"
                      alt="nipaste_2024-05-07_02-03-2"
                ></p>
<p>后面会发现有很多调用 avoid_me 的函数调用，</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_02-04-28.png"
                      alt="nipaste_2024-05-07_02-04-2"
                ></p>
<p>为使我们能够输出 Good Job，因此 should_succeed 应该为 1，而 avoid_me 会将该值置为 0，所以这里我们需要避免执行 avoid_me 函数。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_02-04-35.png"
                      alt="nipaste_2024-05-07_02-04-3"
                ></p>
<p>在前一题的基础上加上如下代码即可：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">avoid_path_address = <span class="number">0x08049243</span></span><br><span class="line">simulation.explore(find = print_good_address, avoid = avoid_path_address)</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_02-06-51.png"
                      alt="nipaste_2024-05-07_02-06-5"
                ></p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">path_to_file = <span class="string">&#x27;./01_avoid&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state()</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    print_good_address = <span class="number">0x08049280</span></span><br><span class="line">    avoid_path_address = <span class="number">0x08049243</span></span><br><span class="line">    simulation.explore(find = print_good_address, avoid = avoid_path_address)</span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>



<h4 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h4><p>explore 中的参数 find 和 avoid 可以不只是目标地址，而且还可以是<strong>自定义函数，参数为模拟状态，返回值为判定条件的布尔值</strong>。</p>
<p>若要寻找一条输出指定字符串的路径，可以选择通过判断该字符串是否在输出中的方式，可以通过 <code>state.posix.dumps(文件描述符)</code> 来获取对应文件描述符上的字符流：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">simulation.explore(find = find_path, avoid = avoid_path)</span><br></pre></td></tr></table></figure></div>



<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_11-31-24.png"
                      alt="nipaste_2024-05-07_11-31-2"
                ></p>
<p>与第一题类似，但是从反汇编可以看到有很多的路径</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_11-38-09.png"
                      alt="nipaste_2024-05-07_11-38-0"
                ></p>
<p>这导致我们想要依靠指定一个目标地址，然后探索出对应的路径并不现实，所以这里我们就需要通过自定义函数来设置路径探索条件。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_11-40-22.png"
                      alt="nipaste_2024-05-07_11-40-2"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">path_to_file = <span class="string">&#x27;./02_find_condition&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state()</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    <span class="comment"># print_good_address = 0x08049280</span></span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>









<h2 id="三、angr-符号化"><a href="#三、angr-符号化" class="headerlink" title="三、angr-符号化"></a>三、angr-符号化</h2><h3 id="Claripy-angr-的求解引擎"><a href="#Claripy-angr-的求解引擎" class="headerlink" title="Claripy - angr 的求解引擎"></a>Claripy - angr 的求解引擎</h3><p><strong>（1）bitvector - 位向量</strong></p>
<p><strong>位向量</strong>（bitvector）是 angr 求解引擎中的一个重要部分，其表示了 <strong>一组位</strong> （a sequence of bits）</p>
<p>可以通过 <code>claripy.BVV(int_value, size_in_bits)</code> 或 <code>claripy.BVV(string_value)</code> 创建带有具体值（concrete value）的指定长度的位向量值（bitvector value）：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> claripy</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="string">b&#x27;bsd_crow&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv</span><br><span class="line">&lt;BV64 <span class="number">0x6273645f63726f77</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="number">0xdeadbeef</span>, <span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv</span><br><span class="line">&lt;BV32 <span class="number">0xdeadbeef</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>相同长度的位向量可以进行运算，对于不同长度的位向量则可以通过</p>
<p> <code>.zero_extend(extended_bits)</code> ：完成<strong>位扩展</strong>（0填充）后进行运算，<strong>位运算也会存在溢出</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="string">b&#x27;bsd_crow&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv2 = claripy.BVV(<span class="number">0xdeadbeef</span>, <span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv2 = bvv2.zero_extend(<span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv + bvv</span><br><span class="line">&lt;BV64 <span class="number">0xc4e6c8bec6e4deee</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv + bvv2</span><br><span class="line">&lt;BV64 <span class="number">0x6273646042202e66</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv * bvv2</span><br><span class="line">&lt;BV64 <span class="number">0x1aecf1db4bfb6219</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>位向量除了代表具体值（concrete value）的 <code>bitvector value</code> 外，还有代表<strong>符号变量</strong>（symbolic variable）的 <code>bitvector symbol</code></p>
<p><code>claripy.BVS(name, size_in_bits)</code> ：创建带名字的指定长度的位向量符号（bitvector symbol）</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="string">&#x27;x&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvs2 = claripy.BVS(<span class="string">&#x27;y&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvs + bvs2</span><br><span class="line">&lt;BV32 x_0_32 + y_1_32&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>(bvs - bvs2)/bvs</span><br><span class="line">&lt;BV32 (x_0_32 - y_1_32) / x_0_32&gt;</span><br></pre></td></tr></table></figure></div>

<p>可以通过 <code>.op</code> 与 <code>.args</code> 获得位向量的运算类型与参数：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv.op</span><br><span class="line"><span class="string">&#x27;BVV&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvs.op</span><br><span class="line"><span class="string">&#x27;BVS&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvs.args</span><br><span class="line">(<span class="string">&#x27;x_0_32&#x27;</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">None</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bvv.args</span><br><span class="line">(<span class="number">7094124198891777911</span>, <span class="number">64</span>)</span><br></pre></td></tr></table></figure></div>



<p><strong>state.solver - 状态的求解接口</strong></p>
<p>在对位向量符号进行具体值求解的时候，可以将位向量符号放到状态内存或寄存器中，在完成路径探索后，就可以使用 <code>solution_state.solver.eval</code> 来获取对应状态下的值。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set the init_state&#x27;s register to corresponding symbolic variables</span></span><br><span class="line">initial_state.regs.eax = password_0</span><br><span class="line"></span><br><span class="line">solution_0 = solution_state.solver.<span class="built_in">eval</span>(password_0)</span><br></pre></td></tr></table></figure></div>



<h4 id="03-angr-symbolic-register"><a href="#03-angr-symbolic-register" class="headerlink" title="03_angr_symbolic_register"></a>03_angr_symbolic_register</h4><p>符号化寄存器</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.regs.eax = password_0</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_16-48-12.png"
                      alt="nipaste_2024-05-07_16-48-1"
                ></p>
<p>创建一个从 get_user_input 之后开始执行的空白状态，将对应的寄存器设置为位向量符号，然后求解并获取对应符号变量值。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">path_to_file = <span class="string">&#x27;./03_symbolic_registers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    start_addr = <span class="number">0x0804958A</span>	<span class="comment"># set addr after get_user_input</span></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># initial_state = project.factory.blank_state(addr = start_addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">    password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_1 = claripy.BVS(<span class="string">&#x27;password_1&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_2 = claripy.BVS(<span class="string">&#x27;password_2&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># set the init_state&#x27;s register to corresponding symbolic variables</span></span><br><span class="line">    initial_state.regs.eax = password_0</span><br><span class="line">    initial_state.regs.ebx = password_1</span><br><span class="line">    initial_state.regs.edx = password_2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># solve question</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check result</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># get answer from solver.eval</span></span><br><span class="line">        solution_0 = solution_state.solver.<span class="built_in">eval</span>(password_0)</span><br><span class="line">        solution_1 = solution_state.solver.<span class="built_in">eval</span>(password_1)</span><br><span class="line">        solution_2 = solution_state.solver.<span class="built_in">eval</span>(password_2)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(solution_0)))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_1 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(solution_1)))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_2 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(solution_2)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>



<h4 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h4><p>如题目所示这道题需要我们将栈设置为符号变量进行求解</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.stack_push(password_0)</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_17-32-49.png"
                      alt="nipaste_2024-05-07_17-32-4"
                ></p>
<p>程序还是很简单的，输入两个数进行约束求解，虽然用前面的方法也能进行解决，但是这道题我们主要学习如何将<strong>栈空间设置为符号变量</strong>，需要注意的是当我们通过下面命令<strong>创建一个空白状态时</strong>，在<strong>必要时</strong>我们需要<strong>自行设置当前状态环境</strong>，以便符号执行。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.blank_state(addr = start_addr)</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_17-37-17.png"
                      alt="nipaste_2024-05-07_17-37-1"
                ></p>
<p>假设我们这里需要从 scanf 后的 <code>add     esp, 10h</code> 开始符号执行，那我们就相当于跳过了 scanf 的执行，需要我们设置一下当前的栈空间。</p>
<p>关于这一点源文件 scanfold04 中做了详细介绍，我这里就简单说明一下</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We are jumping into the middle of a function! Therefore, we need to account</span></span><br><span class="line"><span class="comment"># for how the function constructs the stack. The second instruction of the</span></span><br><span class="line"><span class="comment"># function is:</span></span><br><span class="line"><span class="comment">#   mov    %esp,%ebp</span></span><br><span class="line"><span class="comment"># At which point it allocates the part of the stack frame we plan to target:</span></span><br><span class="line"><span class="comment">#   sub    $0x18,%esp</span></span><br><span class="line"><span class="comment"># Note the value of esp relative to ebp. The space between them is (usually)</span></span><br><span class="line"><span class="comment"># the stack space. Since esp was decreased by 0x18</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        /-------- The stack --------\</span></span><br><span class="line"><span class="comment"># ebp -&gt; |                           |</span></span><br><span class="line"><span class="comment">#        |---------------------------|</span></span><br><span class="line"><span class="comment">#        |                           |</span></span><br><span class="line"><span class="comment">#        |---------------------------|</span></span><br><span class="line"><span class="comment">#         . . . (total of 0x18 bytes)</span></span><br><span class="line"><span class="comment">#         . . . Somewhere in here is</span></span><br><span class="line"><span class="comment">#         . . . the data that stores</span></span><br><span class="line"><span class="comment">#         . . . the result of scanf.</span></span><br><span class="line"><span class="comment"># esp -&gt; |                           |</span></span><br><span class="line"><span class="comment">#        \---------------------------/</span></span><br></pre></td></tr></table></figure></div>

<p>因为我们将 start_addr 直接设置到了 main 函数中间，所以我们需要从分析 main 开始设置正确的栈空间排布，</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:08049385 89 E5                         mov     ebp, esp</span><br><span class="line">.text:08049387 83 EC 18                      sub     esp, 18h</span><br></pre></td></tr></table></figure></div>

<p>从 start_addr 开始时，对应的栈排布为</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#            /-------- The stack --------\</span></span><br><span class="line"><span class="comment"># ebp -&gt;     |          padding          |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment"># ebp - 0x01 |       more padding        |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment"># ebp - 0x02 |     even more padding     |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment">#                        . . .               &lt;- How much padding? Hint: how</span></span><br><span class="line"><span class="comment">#            |---------------------------|      many bytes is password0?</span></span><br><span class="line"><span class="comment"># ebp - 0x0b |   password0, second byte  |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment"># ebp - 0x0c |   password0, first byte   |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment"># ebp - 0x0d |   password1, last byte    |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment">#                        . . .</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment"># ebp - 0x10 |   password1, first byte   |</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment">#                        . . .</span></span><br><span class="line"><span class="comment">#            |---------------------------|</span></span><br><span class="line"><span class="comment"># esp -&gt;     |                           |</span></span><br><span class="line"><span class="comment">#            \---------------------------/</span></span><br></pre></td></tr></table></figure></div>

<p>我们这里需要准确找到两个变量的正确位置，从而来设置符号变量</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_17-52-49.png"
                      alt="nipaste_2024-05-07_17-52-4"
                ></p>
<p>反应在 angr 中的代码为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Since we are starting after scanf, we are skipping this stack construction</span></span><br><span class="line"><span class="comment"># step. To make up for this, we need to construct the stack ourselves.</span></span><br><span class="line">initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line"></span><br><span class="line"><span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">password_1 = claripy.BVS(<span class="string">&#x27;password_1&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line"><span class="comment"># As you can see, the call to scanf looks like this:</span></span><br><span class="line"><span class="comment"># scanf(  0x80489c3,   ebp - 0xc,   ebp - 0x10  )</span></span><br><span class="line"><span class="comment">#      format_string    password0    password1</span></span><br><span class="line"><span class="comment"># From this, we can construct our new</span></span><br><span class="line"><span class="comment"># that&#x27;s why we decrease the esp 0x8</span></span><br><span class="line">initial_state.regs.esp -= <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set the init_state&#x27;s stack to correspond symbolic variables</span></span><br><span class="line">initial_state.stack_push(password_0)</span><br><span class="line">initial_state.stack_push(password_1)</span><br><span class="line"><span class="comment"># restore esp </span></span><br><span class="line">initial_state.regs.esp -= <span class="number">0x18</span>   <span class="comment"># equal sub rsp, 18h after the instruction of add  esp, 10h</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-07_17-55-37.png"
                      alt="nipaste_2024-05-07_17-55-3"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">path_to_file = <span class="string">&#x27;./04_symbolic_stack&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    start_addr = <span class="number">0x0804939F</span></span><br><span class="line">    initial_state = project.factory.blank_state(addr = start_addr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Since we are starting after scanf,we are skipping this stack construction</span></span><br><span class="line">    <span class="comment"># step. To make up for this, we need to construct the stack ourselves.</span></span><br><span class="line">    initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">    password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_1 = claripy.BVS(<span class="string">&#x27;password_1&#x27;</span>, <span class="number">32</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># As you can see, the call to scanf looks like this:</span></span><br><span class="line">    <span class="comment"># scanf(  0x80489c3,   ebp - 0xc,   ebp - 0x10  )</span></span><br><span class="line">    <span class="comment">#      format_string    password0    password1</span></span><br><span class="line">    <span class="comment"># From this, we can construct our new</span></span><br><span class="line">    <span class="comment"># that&#x27;s why we decrease the esp 0x8</span></span><br><span class="line">    initial_state.regs.esp -= <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># set the init_state&#x27;s stack to correspond symbolic variables</span></span><br><span class="line">    initial_state.stack_push(password_0)</span><br><span class="line">    initial_state.stack_push(password_1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># restore esp </span></span><br><span class="line">    initial_state.regs.esp -= <span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># solve question</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check result</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># get answer from solver.eval</span></span><br><span class="line">        solution_0 = solution_state.solver.<span class="built_in">eval</span>(password_0)</span><br><span class="line">        solution_1 = solution_state.solver.<span class="built_in">eval</span>(password_1)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_0))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_1 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_1))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>





<h4 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h4><p>顾名思义即符号化内存，可以使用 <code>state.memory</code> 的对应接口进行操作：</p>
<ul>
<li><code>state.memory.load(addr, size_in_bytes)</code> ：获取该地址上指定大小的位向量</li>
<li><code>state.memory.store(addr, bitvector)</code> ：<strong>将一个位向量存储到指定地址</strong></li>
<li><code>solution_state.solver.eval(bitvector, cast_to=bytes).decode()</code>：获取指定符号的值</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-08_01-00-55.png"
                      alt="nipaste_2024-05-08_01-00-5"
                ></p>
<p>要求输入四个值，每个值占 8 个字节。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-08_01-14-49.png"
                      alt="nipaste_2024-05-08_01-14-4"
                ></p>
<p>这里唯一需要注意的一点是，要将 start_addr 设置为紧接着 scanf 之后的一条指令的地址</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">path_to_file = <span class="string">&#x27;./05_symbolic_memory&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    start_addr = <span class="number">0x08049299</span> <span class="comment"># first insn after scanf()</span></span><br><span class="line">    initial_state = project.factory.blank_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state(addr = start_addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">    password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_1 = claripy.BVS(<span class="string">&#x27;password_1&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_2 = claripy.BVS(<span class="string">&#x27;password_2&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_3 = claripy.BVS(<span class="string">&#x27;password_3&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># set symbolic memory variable</span></span><br><span class="line">    initial_state.memory.store(<span class="number">0x0957F640</span>, password_0)</span><br><span class="line">    initial_state.memory.store(<span class="number">0x0957F648</span>, password_1)</span><br><span class="line">    initial_state.memory.store(<span class="number">0x0957F650</span>, password_2)</span><br><span class="line">    initial_state.memory.store(<span class="number">0x0957F658</span>, password_3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># solve question</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check result</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># get answer from solver.eval</span></span><br><span class="line">        solution_0 = solution_state.solver.<span class="built_in">eval</span>(password_0, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">        solution_1 = solution_state.solver.<span class="built_in">eval</span>(password_1, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">        solution_2 = solution_state.solver.<span class="built_in">eval</span>(password_2, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">        solution_3 = solution_state.solver.<span class="built_in">eval</span>(password_3, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_0))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_1 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_1))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_2 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_2))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_3 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_3))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>



<h4 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-08_01-28-11.png"
                      alt="nipaste_2024-05-08_01-28-1"
                ></p>
<p>与上一题类似但是这题将值保存在了堆中，虽然我们不知道堆地址但是无妨，因为符号执行压根不会去执行程序，因此我们这里直接设置一个 fake 地址，也没有任何关系，buffer0 指针依旧是在 bss 上的，我们链接起来就好</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buf0_addr = <span class="number">0x9CECEA8</span></span><br><span class="line">fake_chunk0 = <span class="number">0xdeadbee0</span></span><br><span class="line"><span class="comment"># set buf_addr ==&gt; fake_chunk0, because the program will not excute really</span></span><br><span class="line">initial_state.memory.store(buf0_addr, fake_chunk0, endness=project.arch.memory_endness)</span><br><span class="line"><span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set symbolic memory variable</span></span><br><span class="line">initial_state.memory.store(fake_chunk0, password_0)</span><br></pre></td></tr></table></figure></div>

<p><strong>注意事项：</strong>试想如果我们这里 buffer0 是在栈上怎么办，那么 04 就可以派上用场，依旧能解决问题。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./06_symbolic_dynamic_memory&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    </span><br><span class="line">    start_addr = <span class="number">0x08049299</span> <span class="comment"># first insn after scanf()</span></span><br><span class="line">    initial_state = project.factory.blank_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state(addr = start_addr)</span></span><br><span class="line">    buf0_addr = <span class="number">0x9CECEA8</span></span><br><span class="line">    buf1_addr = <span class="number">0x9CECEAC</span></span><br><span class="line">    fake_chunk0 = <span class="number">0xdeadbee0</span></span><br><span class="line">    fake_chunk1 = <span class="number">0xdeadbef0</span></span><br><span class="line">    <span class="comment"># set buf_addr ==&gt; fake_chunk0, because the program will not excute really</span></span><br><span class="line">    initial_state.memory.store(buf0_addr, fake_chunk0, endness=project.arch.memory_endness)</span><br><span class="line">    initial_state.memory.store(buf1_addr, fake_chunk1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">    password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line">    password_1 = claripy.BVS(<span class="string">&#x27;password_1&#x27;</span>, <span class="number">64</span>) <span class="comment"># 32-bit registers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># set symbolic memory variable</span></span><br><span class="line">    initial_state.memory.store(fake_chunk0, password_0)</span><br><span class="line">    initial_state.memory.store(fake_chunk1, password_1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># solve question</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check result</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># get answer from solver.eval</span></span><br><span class="line">        solution_0 = solution_state.solver.<span class="built_in">eval</span>(password_0, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">        solution_1 = solution_state.solver.<span class="built_in">eval</span>(password_1, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_0))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_1 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_1))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>





<h4 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h4><p>即符号化文件，关键代码如下：</p>
<p><code>angr.SimFile()</code>：来创建一个模拟文件</p>
<p><code>state.fs.insert(sim_file)</code> ：将 SimFile 插入到一个状态的文件系统中</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">symbolic_file_size_bytes = <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>) <span class="comment"># 0x40 file_size</span></span><br><span class="line">filename = <span class="string">&#x27;EZJXEZBK.txt&#x27;</span></span><br><span class="line">password_file = angr.storage.SimFile(filename, password_0, size = symbolic_file_size_bytes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># load the SimFile</span></span><br><span class="line">initial_state.fs.insert(filename, password_file)</span><br></pre></td></tr></table></figure></div>

<p>通过上面的代码可以通过 angr 创建一个模拟文件，从而用来符号执行</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-08_02-01-02.png"
                      alt="nipaste_2024-05-08_02-01-0"
                ></p>
<p>ignore_me 会将输入的 buffer 内容读入到文件中，我们这里所做的就是需要模拟这个文件，start_addr 我们设置在 ignore_me 的后一条汇编指令。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-08_01-59-50.png"
                      alt="nipaste_2024-05-08_01-59-5"
                ></p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./07_symbolic_file&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    </span><br><span class="line">    start_addr = <span class="number">0x0804946C</span> <span class="comment"># first insn returned from ignoreme()</span></span><br><span class="line">    initial_state = project.factory.blank_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state(addr = start_addr)</span></span><br><span class="line">    symbolic_file_size_bytes = <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create symbolic variables with claripy</span></span><br><span class="line">    password_0 = claripy.BVS(<span class="string">&#x27;password_0&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>) <span class="comment"># 0x40 file_size</span></span><br><span class="line">    filename = <span class="string">&#x27;EZJXEZBK.txt&#x27;</span></span><br><span class="line">    password_file = angr.storage.SimFile(filename, password_0, size = symbolic_file_size_bytes)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># load the SimFile</span></span><br><span class="line">    initial_state.fs.insert(filename, password_file)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># solve question</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check result</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># get answer from solver.eval</span></span><br><span class="line">        solution_0 = solution_state.solver.<span class="built_in">eval</span>(password_0, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_0))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>









<h2 id="四、angr-约束条件"><a href="#四、angr-约束条件" class="headerlink" title="四、angr-约束条件"></a>四、angr-约束条件</h2><h4 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_15-17-39.png"
                      alt="nipaste_2024-05-10_15-17-3"
                ></p>
<p>乍一看这道题跟前面的题目都差不多（实际上确实差不多），但是如果使用前面路径探索的代码会<strong>发现长时间跑不出结果</strong>，原因就在于 <strong>check_equals 中暗藏玄机</strong>，</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_15-19-59.png"
                      alt="nipaste_2024-05-10_15-19-5"
                ></p>
<p>这里逐个判断每个字符是否相等，若相同时会让计数器 v3 加 1，但这里实际存在一个分支路径爆炸的问题，来看看汇编进行理解。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_15-23-46.png"
                      alt="nipaste_2024-05-10_15-23-4"
                ></p>
<p>由于总共有16个字符，所以<strong>要进行16分支判断</strong>，也就是说我们的符号执行过程中需要<strong>保存 2^16 &#x3D; 65536</strong> 个分支，所以这会导致执行起来的效果变得异常慢，由于每次判断时都是与固定字符串进行比较，所以我们这里可以通过添加约束条件，从而在<strong>执行 check_equals 函数前</strong>，就把我们需要的<strong>正确的输入值 buffer 给拿到。</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solution_state.add_constraints(constrain_parameter_bitvector == <span class="string">b&#x27;BOIKVOJYEZJXEZBK&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p><strong>注意事项：</strong></p>
<ul>
<li>需要知道的是，在添加完约束条件后，angr 会调用 z3 完成对满足约束条件的值的求解</li>
<li>探索路径 addr_to_check_constraint 设置在 check_equals 之前的一行指令地址</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_15-32-17.png"
                      alt="nipaste_2024-05-10_15-32-1"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./08_constraints&#x27;</span></span><br><span class="line">    proj = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    start_addr = <span class="number">0x080492ED</span>     <span class="comment"># first instruction after scanf</span></span><br><span class="line">    init_state = proj.factory.blank_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create symbolic varialble</span></span><br><span class="line">    buffer_addr = <span class="number">0x0804C034</span></span><br><span class="line">    buffer_size = <span class="number">0x10</span></span><br><span class="line">    buffer = claripy.BVS(<span class="string">&#x27;buffer&#x27;</span>, buffer_size*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set addr to correspond var</span></span><br><span class="line">    init_state.memory.store(buffer_addr, buffer)</span><br><span class="line"></span><br><span class="line">    addr_to_check_constraint = <span class="number">0x08049339</span>  <span class="comment"># first instruction before check_equals</span></span><br><span class="line">    simulation = proj.factory.simgr(init_state)</span><br><span class="line">    simulation.explore(find = addr_to_check_constraint)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check result</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get encoded buffer content</span></span><br><span class="line">        constrain_parameter_bitvector = solution_state.memory.load(buffer_addr, buffer_size)</span><br><span class="line">        <span class="comment"># add constrain condition</span></span><br><span class="line">        solution_state.add_constraints(constrain_parameter_bitvector == <span class="string">b&#x27;BOIKVOJYEZJXEZBK&#x27;</span>)</span><br><span class="line">        solution = solution_state.solver.<span class="built_in">eval</span>(buffer, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">        <span class="built_in">print</span>(solution)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    solve()</span><br></pre></td></tr></table></figure></div>





<h2 id="五、angr-函数操作"><a href="#五、angr-函数操作" class="headerlink" title="五、angr-函数操作"></a>五、angr-函数操作</h2><h3 id="project-hook-函数钩子"><a href="#project-hook-函数钩子" class="headerlink" title="project.hook(): 函数钩子"></a>project.hook(): 函数钩子</h3><p>在实际需求中，angr 还可以使用 <code>project.hook(addr = call_insn_addr, hook = my_function, length = n)</code> 来 hook 掉对应的 call 指令，其中</p>
<p><code>call_insn_addr</code> ：为 call 指令的地址</p>
<p><code>my_function</code>： 为我们的自定义函数 </p>
<p><code>length</code>： 为 call 指令的长度：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method 1</span></span><br><span class="line"><span class="meta">@project.hook(<span class="params"><span class="number">0x1234</span>, length=<span class="number">5</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_hook_func</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># do something, this is an example</span></span><br><span class="line">    state.regs.eax = <span class="number">0xdeadbeef</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># method 2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_hook_func2</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># do something, this is an example</span></span><br><span class="line">    state.regs.eax = <span class="number">0xdeadbeef</span></span><br><span class="line">proj.hook(addr = <span class="number">0x5678</span>, hook = my_hook_func2, length = <span class="number">5</span>)</span><br></pre></td></tr></table></figure></div>



<h4 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_17-38-16.png"
                      alt="nipaste_2024-05-10_17-38-1"
                ></p>
<p>这题相当于第 8 题，多了一个将 password 进行加密后，在输入一次，判断输入是否和加密后的 password 相同，可以发现用第 8 题的脚本，仍然可以跑出第一部分结果，但是这道题我们要用hook来模拟 <code>check_equals</code>。</p>
<p>但在这道题中我们可以学习到<strong>连续状态的路径探索</strong>，以往我们都是一个状态 explore 一次，在这道题中我们会 explore 两次。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore(find = addr_to_check_constraint) <span class="comment"># 第一次</span></span><br><span class="line"><span class="comment"># step.1 compute first solution</span></span><br><span class="line"><span class="keyword">if</span> simulation.found == <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;could not find solution&quot;</span>)</span><br><span class="line"></span><br><span class="line">check_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># add constrain condition</span></span><br><span class="line">check_state.add_constraints(check_state.regs.eax == <span class="number">1</span>)</span><br><span class="line">solution = check_state.solver.<span class="built_in">eval</span>(buffer, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;solution ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line"></span><br><span class="line"><span class="comment"># step.2 compute second solution</span></span><br><span class="line">simulation = project.factory.simgr(check_state)</span><br><span class="line">simulation.explore(find = <span class="number">0x080493A3</span>)       <span class="comment">#  # 第二次</span></span><br><span class="line"><span class="keyword">if</span> simulation.found == <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;could not find solution&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>由于这里依然存在路径爆炸的问题，所以我们这里使用 hook 来解决这一问题。</p>
<p><strong>注意事项：</strong>这里使用 <code>claripy.If()</code> 创建一个比较并将值给到 <strong>eax 寄存器</strong>作为返回值，最后就是常规的内存符号化后求解即可</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_17-48-10.png"
                      alt="nipaste_2024-05-10_17-48-1"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./09_hooks&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    password_str = <span class="string">b&#x27;BOIKVOJYEZJXEZBK&#x27;</span></span><br><span class="line"></span><br><span class="line">    start_addr = <span class="number">0x080492FD</span>    <span class="comment"># first instruction after scanf</span></span><br><span class="line">    init_state = project.factory.blank_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    buffer_addr = <span class="number">0x0804C038</span></span><br><span class="line">    buffer_size = <span class="number">0x10</span></span><br><span class="line">    buffer = claripy.BVS(<span class="string">&#x27;buffer&#x27;</span>, buffer_size * <span class="number">8</span>)</span><br><span class="line">    <span class="comment"># store symbolic var</span></span><br><span class="line">    init_state.memory.store(buffer_addr, buffer)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># since we skip qmemcpy for password, we have to write origianl content into its addr</span></span><br><span class="line">    password_addr = <span class="number">0x0804C04C</span></span><br><span class="line">    password_size = <span class="number">0x10</span></span><br><span class="line">    password = claripy.BVV(<span class="built_in">int</span>.from_bytes(password_str, <span class="string">&quot;big&quot;</span>), password_size * <span class="number">8</span>)</span><br><span class="line">    init_state.memory.store(password_addr, password)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set hook function to replace check_equals</span></span><br><span class="line">    first_check_equals_addr = <span class="number">0x804934E</span></span><br><span class="line"><span class="meta">    @project.hook(<span class="params">first_check_equals_addr, length=<span class="number">5</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">my_hook_func</span>(<span class="params">state</span>):</span><br><span class="line">        buffer = state.memory.load(buffer_addr, buffer_size)</span><br><span class="line">        state.regs.eax = claripy.If(buffer == password_str, <span class="comment">#constraint</span></span><br><span class="line">                                    <span class="comment"># if success return 1, else return 0</span></span><br><span class="line">                                    claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># explore path</span></span><br><span class="line">    addr_to_check_constraint = <span class="number">0x08049353</span>    <span class="comment"># Attention：first instruction after check_equals</span></span><br><span class="line">    simulation = project.factory.simgr(init_state)</span><br><span class="line">    simulation.explore(find = addr_to_check_constraint)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step.1 compute first solution</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;could not find solution&quot;</span>)</span><br><span class="line"></span><br><span class="line">    check_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># add constrain condition</span></span><br><span class="line">    check_state.add_constraints(check_state.regs.eax == <span class="number">1</span>)</span><br><span class="line">    solution = check_state.solver.<span class="built_in">eval</span>(buffer, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;solution ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step.2 compute second solution</span></span><br><span class="line">    simulation = project.factory.simgr(check_state)</span><br><span class="line">    simulation.explore(find = <span class="number">0x080493A3</span>)       <span class="comment"># last instruction before scanf</span></span><br><span class="line">    <span class="keyword">if</span> simulation.found == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;could not find solution&quot;</span>)</span><br><span class="line"></span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    password = solution_state.memory.load(password_addr, password_size)</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;solution2 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    solve()</span><br></pre></td></tr></table></figure></div>





<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="angr-SimProcedure-模拟函数（过程）"><a href="#angr-SimProcedure-模拟函数（过程）" class="headerlink" title="angr.SimProcedure - 模拟函数（过程）"></a>angr.SimProcedure - 模拟函数（过程）</h3><p>在 angr 中 <code>angr.SimProcedure</code> 类用来表示<strong>在一个状态上的一个运行过程</strong>——即函数实际上是一个 SimPrecedure</p>
<p>可以通过创建一个继承自 <code>angr.SimProcedure</code> 的类并重写 <code>run()</code> 方法的方式来表示一个自定义函数，其中 <code>run()</code> 方法的参数为<strong>该函数所接收的参数</strong>：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyProcedure</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, arg1, arg2</span>):</span><br><span class="line">        <span class="comment"># do something, this&#x27;s an example</span></span><br><span class="line">        <span class="keyword">return</span> self.state.memory.load(arg1, arg2)</span><br></pre></td></tr></table></figure></div>

<p>自定义函数会对文件中原有函数进行替换，angr 默认会用内置的一些 SimProcedure 去替换一些库函数。</p>
<p>在已经有该二进制文件的符号表，可以直接使用 <code>project.hook_symbol(symbol_str, sim_procedure_instance)</code> 来自动 hook 掉文件中所有的对应符号，其中 <code>run()</code> 方法的<strong>参数为被替换函数所接收的参数</strong>：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyProcedure</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, arg1, arg2</span>):</span><br><span class="line">        <span class="comment"># do something, this&#x27;s an example</span></span><br><span class="line">        <span class="keyword">return</span> self.state.memory.load(arg1, arg2)</span><br><span class="line"></span><br><span class="line">proj = angr.Project(<span class="string">&#x27;./test&#x27;</span>)</span><br><span class="line">proj.hook_symbol(<span class="string">&#x27;func_to_hook&#x27;</span>, MyProcedure())</span><br></pre></td></tr></table></figure></div>

<p>在 SimProcedure 的 <code>run()</code> 过程中也可以使用一些有用的成员函数：</p>
<ul>
<li><code>ret(expr)</code>: 函数返回</li>
<li><code>jump(addr)</code>: 跳转到指定地址</li>
<li><code>exit(code)</code>: 终止程序</li>
<li><code>call(addr, args, continue_at)</code>: 调用文件中的函数</li>
<li><code>inline_call(procedure, *args)</code>: 内联地调用另一个 SimProcedure</li>
</ul>
<h4 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h4><p>这道题有点反编译出来的效果不是很好，可以看汇编代码来进行理解。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_22-50-56.png"
                      alt="nipaste_2024-05-10_22-50-5"
                ></p>
<p>在执行完 complex_function 之后，下面会有非常多的伪路径，其中每个都包含 <code>check_equals</code> 函数调用，而且我们前面也知道每个 check_equals 中都会存在路径爆炸，尤其在有这么多伪路径的情况下，我们不可能在像第9题那样<strong>挨个去为每个调用点设置 hook 函数</strong>。</p>
<p>所以这时候我们可以通过 <strong>simprocedures</strong> 为所有函数 <code>	check_equals</code> 设置 hook。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_22-51-50.png"
                      alt="nipaste_2024-05-10_22-51-5"
                ></p>
<p>方法跟上一题 hook 函数类似，但是这里我们用类代替写 hook。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReplacementCheckEquals</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, buffer_addr, buffer_len</span>):</span><br><span class="line">        buffer = self.state.memory.load(buffer_addr, buffer_len)</span><br><span class="line">        compared_str = <span class="string">b&#x27;BOIKVOJYEZJXEZBK&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> claripy.If(buffer == compared_str, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line">project.hook_symbol(<span class="string">&#x27;check_equals_BOIKVOJYEZJXEZBK&#x27;</span>, ReplacementCheckEquals())</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_22-58-37.png"
                      alt="nipaste_2024-05-10_22-58-3"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReplacementCheckEquals</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, buffer_addr, buffer_len</span>):</span><br><span class="line">        buffer = self.state.memory.load(buffer_addr, buffer_len)</span><br><span class="line">        compared_str = <span class="string">b&#x27;BOIKVOJYEZJXEZBK&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> claripy.If(buffer == compared_str, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./10_simprocedures&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set context environment</span></span><br><span class="line">    initial_state = project.factory. entry_state(</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># hook the check_equals()</span></span><br><span class="line">    project.hook_symbol(<span class="string">&#x27;check_equals_BOIKVOJYEZJXEZBK&#x27;</span>, ReplacementCheckEquals())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># begin to explore path</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>





<h4 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_23-27-47.png"
                      alt="nipaste_2024-05-10_23-27-4"
                ></p>
<p>反编译出来的效果依然不尽人意，程序中存在<strong>很多 scanf 的伪路径</strong>，这一题我们可以直接用第2题的脚本跑通，但是我们需要通过这一题来对前面学到的 <strong>simprocedure</strong> 对 <strong>scanf 函数进行模拟</strong>，关键代码如下。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmt_str, buffer0_addr, buffer1_addr</span>):</span><br><span class="line">        buffer0 = claripy.BVS(<span class="string">&#x27;buffer0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">        buffer1 = claripy.BVS(<span class="string">&#x27;buffer1&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">        self.state.memory.store(buffer0_addr, buffer0)</span><br><span class="line">        self.state.memory.store(buffer1_addr, buffer1)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_0&#x27;</span>] = buffer0</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_1&#x27;</span>] = buffer1</span><br><span class="line">        </span><br><span class="line"><span class="comment"># hook the check_equals()</span></span><br><span class="line">project.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, MyScanfProcedure())</span><br><span class="line">buffer0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_0&#x27;</span>]</span><br><span class="line">password0 = solution_state.solver.<span class="built_in">eval</span>(buffer0, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;password0: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(password0, <span class="string">&#x27;little&#x27;</span>)))</span><br></pre></td></tr></table></figure></div>

<p><strong>注意事项：</strong>若是在 <code>run()</code> 方法内创建 BVS ，则可以通过将其储存到 <code>state.globals</code> 列表的方式以便<strong>后续取用</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-10_23-32-19.png"
                      alt="nipaste_2024-05-10_23-32-1"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmt_str, buffer0_addr, buffer1_addr</span>):</span><br><span class="line">        buffer0 = claripy.BVS(<span class="string">&#x27;buffer0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">        buffer1 = claripy.BVS(<span class="string">&#x27;buffer1&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">        self.state.memory.store(buffer0_addr, buffer0)</span><br><span class="line">        self.state.memory.store(buffer1_addr, buffer1)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_0&#x27;</span>] = buffer0</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_1&#x27;</span>] = buffer1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./11_sim_scanf&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set context environment</span></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># hook the check_equals()</span></span><br><span class="line">    project.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, MyScanfProcedure())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># begin to explore path</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># get value method1</span></span><br><span class="line">        <span class="comment"># buffer0 = solution_state.memory.load(0x80605C4, 4)</span></span><br><span class="line">        <span class="comment"># buffer1 = solution_state.memory.load(0x8057274, 4)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># get value method2</span></span><br><span class="line">        buffer0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_0&#x27;</span>]</span><br><span class="line">        buffer1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;buffer_1&#x27;</span>]</span><br><span class="line">        password0 = solution_state.solver.<span class="built_in">eval</span>(buffer0, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">        password1 = solution_state.solver.<span class="built_in">eval</span>(buffer1, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password0: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(password0, <span class="string">&#x27;little&#x27;</span>)))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password1: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(password1, <span class="string">&#x27;little&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>







<h2 id="六、angr-路径合并"><a href="#六、angr-路径合并" class="headerlink" title="六、angr-路径合并"></a>六、angr-路径合并</h2><h4 id="12-angr-veritesting"><a href="#12-angr-veritesting" class="headerlink" title="12_angr_veritesting"></a>12_angr_veritesting</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_13-32-55.png"
                      alt="nipaste_2024-05-11_13-32-5"
                ></p>
<p>这道题与前面不一样的是，在边执行 <strong>complex_function</strong> 的时候，边进行 <strong>逐个字符检查</strong>，会导致路径爆炸。</p>
<p>在angr中可以通过在创建 simgr 时指定参数 <code>veritesting=True</code>，这样 angr 就会在运行过程中进行路径合并，缓解路径爆炸的问题。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_13-52-54.png"
                      alt="nipaste_2024-05-11_13-52-5"
                ></p>
<p>不知道这道题的成功率为什么忽高忽低，偶尔会很快，偶尔又比较慢。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./12_veritesting&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set context environment</span></span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># begin to explore path</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state, veritesting = <span class="literal">True</span>)</span><br><span class="line">    simulation.explore(find = <span class="number">0x80492FF</span>, avoid = <span class="number">0x8049311</span>)   </span><br><span class="line">    <span class="comment"># simulation.explore(find = find_path, avoid = avoid_path) </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;solution ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.posix.dumps(sys.stdin.fileno())))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>





<h2 id="七、angr-库操作"><a href="#七、angr-库操作" class="headerlink" title="七、angr-库操作"></a>七、angr-库操作</h2><h4 id="13-angr-static-binary"><a href="#13-angr-static-binary" class="headerlink" title="13_angr_static_binary"></a>13_angr_static_binary</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_15-07-28.png"
                      alt="nipaste_2024-05-11_15-07-2"
                ></p>
<p>与之前的题目不一样的是，这道题采用的是<strong>静态编译</strong>，我们之前都做的是动态编译的题目，这两者之间的区别是后者在执行时，angr 会自动通过 <strong>SimProcedures</strong> 去替换标准库函数，因为这样的效率会更快，而在<strong>静态编译的题目</strong>中，angr 并不会自动去替换，而是需要我们<strong>手动设置 hook 函数</strong>。样例如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]</span><br><span class="line">angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]</span><br><span class="line">angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;exit&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<p>同样的我们还是可以使用前面的 project.hook 的方法去进行设置 hook 函数：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.hook(malloc_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;malloc&#x27;</span>]())</span><br></pre></td></tr></table></figure></div>

<p>需要注意的是 <code>__libc_start_main</code> 需要采用下面的方法去进行替换，如果不用 <strong>SimProcedures</strong> hook 掉这个函数，angr 的执行时间将会变得很长。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">project.hook_symbol(<span class="string">&#x27;__libc_start_main&#x27;</span>, </span><br><span class="line">                        angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br></pre></td></tr></table></figure></div>

<p><strong>注意事项：</strong>在上面比如说我们要 hook 掉 puts 函数，不像前面的题那样，在 call 处进行 hook ，而是在该函数静态编译后的代码实现处</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_15-20-03.png"
                      alt="nipaste_2024-05-11_15-20-0"
                ></p>
<p>最后效果如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_15-20-26.png"
                      alt="nipaste_2024-05-11_15-20-2"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">avoid_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./13_static_binary&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set context environment</span></span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># hook function</span></span><br><span class="line">    project.hook(<span class="number">0x08051F00</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">    project.hook(<span class="number">0x08051EB0</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]())</span><br><span class="line">    project.hook(<span class="number">0x0805EED0</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">    project.hook(<span class="number">0x0806D8C0</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]())</span><br><span class="line">    project.hook_symbol(<span class="string">&#x27;__libc_start_main&#x27;</span>, </span><br><span class="line">                        angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = find_path, avoid = avoid_path) </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;solution ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.posix.dumps(sys.stdin.fileno())))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>





<h4 id="14-angr-shared-library"><a href="#14-angr-shared-library" class="headerlink" title="14_angr_shared_library"></a>14_angr_shared_library</h4><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 generate.py 123654 14__shared_library</span><br><span class="line">/usr/bin/ld: cannot find 14__shared_library: No such file or directory</span><br><span class="line">/usr/bin/ld: cannot find -l14__shared_library: No such file or directory</span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br></pre></td></tr></table></figure></div>

<p>编译的时候会报错，修改为下面的命令即可</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 generate.py 123654 ./14__shared_library</span><br></pre></td></tr></table></figure></div>

<p>虽然这题我们可以通过前面第一题的脚本直接暴力出，但是这一题我们需要学习的是模拟<strong>动态库的符号执行</strong>，也就是对 .so 文件进行符号执行，源程序中会调用 <code>lib14__shared_library.so</code> 中的 validate 函数。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_15-43-57.png"
                      alt="nipaste_2024-05-11_15-43-5"
                ></p>
<p>这是具体的实现</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_15-45-02.png"
                      alt="nipaste_2024-05-11_15-45-0"
                ></p>
<p>需要注意的是动态库开了 PIE，所以我们需要为程序手动随机<strong>设置一个基地址</strong>，设置方法如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">base_addr = <span class="number">0x400000</span></span><br><span class="line">project = angr.Project(path_to_file, load_options = &#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;custom_base_addr&#x27;</span>: base_addr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>

<p>将符号执行模拟地址设置于 validate 函数开始，并我们提前向栈里面传递参数（32位），来模拟调用 validate 时的状态。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># emulate validate func ==&gt; validate(password, 8)</span></span><br><span class="line">initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line">initial_state.stack_push(<span class="number">8</span>)</span><br><span class="line">initial_state.stack_push(password_addr)</span><br><span class="line">initial_state.stack_push(<span class="number">0xdeadbeef</span>) <span class="comment"># ret addr</span></span><br></pre></td></tr></table></figure></div>

<p>最后效果如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_16-12-32.png"
                      alt="nipaste_2024-05-11_16-12-3"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./lib14__shared_library.so&#x27;</span></span><br><span class="line">    base_addr = <span class="number">0x400000</span></span><br><span class="line">    project = angr.Project(path_to_file, load_options = &#123;</span><br><span class="line">        <span class="string">&#x27;main_opts&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;custom_base_addr&#x27;</span>: base_addr</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    start_addr = base_addr + <span class="number">0x0001244</span> <span class="comment"># addr of validate</span></span><br><span class="line">    initial_state = project.factory.blank_state(</span><br><span class="line">        addr = start_addr,</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    password_addr = base_addr + <span class="number">0x100000</span></span><br><span class="line">    password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">8</span> * <span class="number">8</span>)</span><br><span class="line">    initial_state.memory.store(password_addr, password)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># emulate validate func ==&gt; validate(password, 8)</span></span><br><span class="line">    initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line">    initial_state.stack_push(<span class="number">8</span>)</span><br><span class="line">    initial_state.stack_push(password_addr)</span><br><span class="line">    initial_state.stack_push(<span class="number">0xdeadbeef</span>) <span class="comment"># ret addr</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># initial_state = project.factory.entry_state()</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    find_path = base_addr + <span class="number">0x000012ED</span></span><br><span class="line">    simulation.explore(find = find_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        solution_state.add_constraints(solution_state.regs.eax == <span class="number">1</span>)</span><br><span class="line">        solution = solution_state.solver.<span class="built_in">eval</span>(password, cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">        <span class="built_in">print</span>(solution)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find the solution!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>





<h2 id="八、angr-漏洞利用"><a href="#八、angr-漏洞利用" class="headerlink" title="八、angr-漏洞利用"></a>八、angr-漏洞利用</h2><h4 id="15-angr-arbitrary-read"><a href="#15-angr-arbitrary-read" class="headerlink" title="15_angr_arbitrary_read"></a>15_angr_arbitrary_read</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_17-15-46.png"
                      alt="nipaste_2024-05-11_17-15-4"
                ></p>
<p>程序中存在一个溢出，我们的任务是让程序输出 <code>Good Job.</code>，从pwn的角度来说这个实现非常简单，但是我们这里要学习如何使用 angr 来进行漏洞利用。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_17-17-02.png"
                      alt="nipaste_2024-05-11_17-17-0"
                ></p>
<p>源程序中调用的关键函数主要有两个，一个是 <strong>scanf 用来接受字符串</strong>，一个是 <strong>puts 用于输出字符串。</strong></p>
<p>（1）为了<strong>获取到我们输入到 scanf 中的字符串</strong>，我们将该函数进行 hook，下面代码参考 a3 师傅。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MySimScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmt_str, key_addr, chr_arr_addr</span>):</span><br><span class="line">        key_bvs = claripy.BVS(<span class="string">&#x27;key&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">        chr_arr_bvs = claripy.BVS(<span class="string">&#x27;chr_arr&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> chr_arr_bvs.chop(bits = <span class="number">8</span>):</span><br><span class="line">            self.state.add_constraints(ch &gt;= <span class="string">&#x27;0&#x27;</span>, ch &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">        self.state.memory.store(key_addr, key_bvs,</span><br><span class="line">                                endness = project.arch.memory_endness)</span><br><span class="line">        self.state.memory.store(chr_arr_addr, chr_arr_bvs)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password_0&#x27;</span>] = key_bvs</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password_1&#x27;</span>] = chr_arr_bvs</span><br></pre></td></tr></table></figure></div>

<p><strong>注意事项：</strong>上面代码使用 <code>BVS.chop(bits=n)</code> 来将符号位向量按照一定尺寸进行分割，将字符限制在了 ‘0’-‘z’ 之间。</p>
<p>（2）为了检查 puts 输出的字符串是否是 ‘Good Job.’，我们在设置一个自定义函数进行判断。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_success</span>(<span class="params">state</span>):</span><br><span class="line">    puts_plt_addr = <span class="number">0x08049060</span></span><br><span class="line">    <span class="keyword">if</span> state.addr != puts_plt_addr:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    good_str_addr = <span class="number">0x424F494B</span></span><br><span class="line">    puts_param = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">                                endness = project.arch.memory_endness)</span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(puts_param):</span><br><span class="line">        copy_state = state.copy()</span><br><span class="line">        copy_state.add_constraints(puts_param == good_str_addr)</span><br><span class="line">        <span class="keyword">if</span> copy_state.satisfiable():</span><br><span class="line">            state.add_constraints(puts_param == good_str_addr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure></div>

<p>其中检查的地址设在了 puts_plt 处的位置，并通过获取字符串地址，在设置约束条件之后即可，求解出正确的输入，下面是对上面代码中的一些关键函数进行说明。</p>
<ul>
<li>使用 <code>state.memory.load()</code> 将 <code>puts()</code> 的参数提取出来</li>
<li>使用 <code>state.solver.symbolic()</code> 判断 <code>puts()</code> 的参数是否是我们的 BVS</li>
<li>使用 <code>state.copy()</code> 获取当前状态的副本，之后在该副本上添加约束以避免影响到原状态</li>
<li>使用 <code>state.satisfiable()</code> 判断是否满足约束，若是则添加到原状态中求解即可</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_17-30-38.png"
                      alt="nipaste_2024-05-11_17-30-3"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./15_arbitrary_read&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MySimScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmt_str, key_addr, chr_arr_addr</span>):</span><br><span class="line">            key_bvs = claripy.BVS(<span class="string">&#x27;key&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">            chr_arr_bvs = claripy.BVS(<span class="string">&#x27;chr_arr&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span> ch <span class="keyword">in</span> chr_arr_bvs.chop(bits = <span class="number">8</span>):</span><br><span class="line">                self.state.add_constraints(ch &gt;= <span class="string">&#x27;0&#x27;</span>, ch &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">            self.state.memory.store(key_addr, key_bvs,</span><br><span class="line">                                    endness = project.arch.memory_endness)</span><br><span class="line">            self.state.memory.store(chr_arr_addr, chr_arr_bvs)</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password_0&#x27;</span>] = key_bvs</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password_1&#x27;</span>] = chr_arr_bvs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_success</span>(<span class="params">state</span>):</span><br><span class="line">        puts_plt_addr = <span class="number">0x08049060</span></span><br><span class="line">        <span class="keyword">if</span> state.addr != puts_plt_addr:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        good_str_addr = <span class="number">0x424F494B</span></span><br><span class="line">        puts_param = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">                                    endness = project.arch.memory_endness)</span><br><span class="line">        <span class="keyword">if</span> state.solver.symbolic(puts_param):</span><br><span class="line">            copy_state = state.copy()</span><br><span class="line">            copy_state.add_constraints(puts_param == good_str_addr)</span><br><span class="line">            <span class="keyword">if</span> copy_state.satisfiable():</span><br><span class="line">                state.add_constraints(puts_param == good_str_addr)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># hook scanf func</span></span><br><span class="line">    project.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = is_success)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;found&quot;</span>)</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;password_0&#x27;</span>])))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_1 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;password_1&#x27;</span>], cast_to = <span class="built_in">bytes</span>)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not found solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>





<h4 id="16-angr-arbitrary-write"><a href="#16-angr-arbitrary-write" class="headerlink" title="16_angr_arbitrary_write"></a>16_angr_arbitrary_write</h4><p>跟上一题类似，不过这一题要做的就是修改把路径探索条件设置在 strcpy 那里进行条件检查：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_success</span>(<span class="params">state</span>):</span><br><span class="line">    strcpy_plt_addr = <span class="number">0x08049080</span></span><br><span class="line">    <span class="keyword">if</span> state.addr != strcpy_plt_addr:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    good_str_addr = <span class="number">0x0804A031</span></span><br><span class="line">    dest_param1 = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">                                endness = project.arch.memory_endness)</span><br><span class="line">    s_param2 = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>,</span><br><span class="line">                                endness = project.arch.memory_endness)</span><br><span class="line">    compared_str = state.memory.load(s_param2, <span class="number">8</span>)</span><br><span class="line">    password_addr = <span class="number">0x44414D48</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(dest_param1) <span class="keyword">and</span> state.solver.symbolic(compared_str):</span><br><span class="line">        copy_state = state.copy()</span><br><span class="line">        copy_state.add_constraints(dest_param1 == password_addr)</span><br><span class="line">        copy_state.add_constraints(compared_str == <span class="string">b&quot;VMHNNFKL&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> copy_state.satisfiable():</span><br><span class="line">            state.add_constraints(dest_param1 == password_addr)</span><br><span class="line">            state.add_constraints(compared_str == <span class="string">b&quot;VMHNNFKL&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_17-59-16.png"
                      alt="nipaste_2024-05-11_17-59-1"
                ></p>
<p>一开始这题我没有设置 is_success 检查，直接暴力探索，但是好像跑不出来结果</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./16_arbitrary_write&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MySimScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmt_str, key_addr, chr_arr_addr</span>):</span><br><span class="line">            key_bvs = claripy.BVS(<span class="string">&#x27;key&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">            chr_arr_bvs = claripy.BVS(<span class="string">&#x27;chr_arr&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span> ch <span class="keyword">in</span> chr_arr_bvs.chop(bits = <span class="number">8</span>):</span><br><span class="line">                self.state.add_constraints(ch &gt;= <span class="string">&#x27;0&#x27;</span>, ch &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">            self.state.memory.store(key_addr, key_bvs,</span><br><span class="line">                                    endness = project.arch.memory_endness)</span><br><span class="line">            self.state.memory.store(chr_arr_addr, chr_arr_bvs)</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password_0&#x27;</span>] = key_bvs</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password_1&#x27;</span>] = chr_arr_bvs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_success</span>(<span class="params">state</span>):</span><br><span class="line">        strcpy_plt_addr = <span class="number">0x08049080</span></span><br><span class="line">        <span class="keyword">if</span> state.addr != strcpy_plt_addr:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        good_str_addr = <span class="number">0x0804A031</span></span><br><span class="line">        dest_param1 = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">                                    endness = project.arch.memory_endness)</span><br><span class="line">        s_param2 = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>,</span><br><span class="line">                                    endness = project.arch.memory_endness)</span><br><span class="line">        compared_str = state.memory.load(s_param2, <span class="number">8</span>)</span><br><span class="line">        password_addr = <span class="number">0x44414D48</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> state.solver.symbolic(dest_param1) <span class="keyword">and</span> state.solver.symbolic(compared_str):</span><br><span class="line">            copy_state = state.copy()</span><br><span class="line">            copy_state.add_constraints(dest_param1 == password_addr)</span><br><span class="line">            copy_state.add_constraints(compared_str == <span class="string">b&quot;VMHNNFKL&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> copy_state.satisfiable():</span><br><span class="line">                state.add_constraints(dest_param1 == password_addr)</span><br><span class="line">                state.add_constraints(compared_str == <span class="string">b&quot;VMHNNFKL&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># hook scanf func</span></span><br><span class="line">    project.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    simulation.explore(find = is_success)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;found&quot;</span>)</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;password_0&#x27;</span>])))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_1 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;password_1&#x27;</span>], cast_to = <span class="built_in">bytes</span>)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not found solution&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>





<h2 id="17-angr-arbitrary-jump"><a href="#17-angr-arbitrary-jump" class="headerlink" title="17_angr_arbitrary_jump"></a>17_angr_arbitrary_jump</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_21-03-31.png"
                      alt="nipaste_2024-05-11_21-03-3"
                ></p>
<p>上面的 read_input 存在栈溢出</p>
<h3 id="stash-类型"><a href="#stash-类型" class="headerlink" title="stash 类型"></a>stash 类型</h3><p>在 angr 有以下几种 stash：</p>
<ul>
<li><code>simgr.active</code>：活跃的状态列表。在未指定替代的情况下会被模拟器默认执行</li>
<li><code>simgr.deadended</code>：死亡的状态列表。当一个状态无法再被继续执行时（例如没有有效指令、无效的指令指针、不满足其所有的后继（successors））便会被归入该列表</li>
<li><code>simgr.pruned</code>：被剪枝的状态列表。在指定了 <code>LAZY_SOLVES</code> 时，状态仅在必要时检查可满足性，当一个状态在指定了 <code>LAZY_SOLVES</code> 时被发现是不可满足的（unsat），状态层（state hierarchy）将会被遍历以确认在其历史中最初变为不满足的时间，该点及其所有后代都会被 <em>剪枝</em> （pruned）并放入该列表</li>
<li><code>simgr.unconstrained</code>：不受约束的状态列表。当创建 <code>SimulationManager</code> 时指定了 <code>save_unconstrained=True</code>，则被认为<strong>不受约束的</strong>（unconstrained，即指令指针被用户数据或其他来源的符号化数据控制）状态会被归入该列表</li>
<li><code>simgr.unsat</code>：不可满足的状态列表。当创建 <code>SimulationManager</code> 时指定了 <code>save_unsat=True</code>，则被认为无法被满足的（unsatisfiable，即存在<strong>约束冲突</strong>的状态，例如在同一时刻要求输入既是<code>&quot;AAAA&quot;</code> 又是 <code>&quot;BBBB&quot;</code>）状态会被归入该列表</li>
</ul>
<p>还有一种不是 stash 的状态列表——<code>errored</code>，若在执行中产生了错误，则状态与其产生的错误会被包裹在一个 <code>ErrorRecord</code> 实例中（可通过 <code>record.state</code> 与 <code>record.error</code> 访问），该 record 会被插入到 <code>errored</code> 中，我们可以通过 <code>record.debug()</code> 启动一个调试窗口</p>
<h3 id="stash-操作"><a href="#stash-操作" class="headerlink" title="stash 操作"></a>stash 操作</h3><p>我们可以使用 <code>stash.move()</code> 来在 stash 之间转移放置状态，用法如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simgr.move(from_stash = &#x27;unconstrained&#x27;, to_stash = &#x27;active&#x27;)</span><br></pre></td></tr></table></figure></div>

<p>在转移当中我们还可以通过指定 <code>filter_func</code> 参数来进行过滤：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">filter_func</span>(<span class="params">state</span>):</span><br><span class="line">    print_good_addr = <span class="number">0x424F4954</span></span><br><span class="line">    <span class="keyword">return</span> state.satisfiable(</span><br><span class="line">        extra_constraints = (state.regs.eip == print_good_addr, ))</span><br><span class="line">        </span><br><span class="line">simulation.move(from_stash = <span class="string">&#x27;unconstrained&#x27;</span>, to_stash = <span class="string">&#x27;found&#x27;</span>, filter_func = filter_func)</span><br></pre></td></tr></table></figure></div>

<p>stash 本质上是个 list，因此在初始化时可以通过字典的方式指定每个 stash 的初始内容：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state,</span><br><span class="line">                              save_unconstrained = <span class="literal">True</span>,</span><br><span class="line">                              stashes = &#123;</span><br><span class="line">                                  <span class="string">&#x27;active&#x27;</span>:[initial_state],</span><br><span class="line">                                  <span class="string">&#x27;unconstrained&#x27;</span>:[],</span><br><span class="line">                                  <span class="string">&#x27;found&#x27;</span>:[]</span><br><span class="line">                              &#125;)</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Snipaste_2024-05-11_22-24-45.png"
                      alt="nipaste_2024-05-11_22-24-4"
                ></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> angr.factory</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_func</span>(<span class="params">state</span>):</span><br><span class="line">    print_good_addr = <span class="number">0x424F4954</span></span><br><span class="line">    <span class="keyword">return</span> state.satisfiable(</span><br><span class="line">        extra_constraints = (state.regs.eip == print_good_addr, ))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    path_to_file = <span class="string">&#x27;./17_arbitrary_jump&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_file)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MySimScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmt_str, data_addr</span>):</span><br><span class="line">            data_bvs = claripy.BVS(<span class="string">&#x27;data&#x27;</span>, <span class="number">200</span> * <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span> ch <span class="keyword">in</span> data_bvs.chop(bits = <span class="number">8</span>):</span><br><span class="line">                self.state.add_constraints(ch &gt;= <span class="string">&#x27;0&#x27;</span>, ch &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">            self.state.memory.store(data_addr, data_bvs)</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>] = data_bvs</span><br><span class="line"></span><br><span class="line">    project.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())</span><br><span class="line">    <span class="comment"># create simgr that can save unconstraints</span></span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line">    simulation = project.factory.simgr(initial_state,</span><br><span class="line">                                  save_unconstrained = <span class="literal">True</span>,</span><br><span class="line">                                  stashes = &#123;</span><br><span class="line">                                      <span class="string">&#x27;active&#x27;</span>:[initial_state],</span><br><span class="line">                                      <span class="string">&#x27;unconstrained&#x27;</span>:[],</span><br><span class="line">                                      <span class="string">&#x27;found&#x27;</span>:[]</span><br><span class="line">                                  &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># simulated execution by steps</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> simulation.found:</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> simulation.active) <span class="keyword">and</span> (<span class="keyword">not</span> simulation.unconstrained):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># check for unconstrained</span></span><br><span class="line">        simulation.move(from_stash = <span class="string">&#x27;unconstrained&#x27;</span>,</span><br><span class="line">                   to_stash = <span class="string">&#x27;found&#x27;</span>,</span><br><span class="line">                   filter_func = filter_func)</span><br><span class="line">        <span class="comment"># step to next basic block</span></span><br><span class="line">        simulation.step()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;found&quot;</span>)</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state)</span><br><span class="line">        print_good_addr = <span class="number">0x424F4954</span></span><br><span class="line">        solution_state.add_constraints(solution_state.regs.eip == print_good_addr)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;password_0 ==&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(</span><br><span class="line">            solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>], cast_to = <span class="built_in">bytes</span>)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not found solution&quot;</span>)    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></div>





<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​	感觉 angr 在漏洞利用方面表现得较为单薄，尽管可能是一个简单的栈溢出，我们依然有很多要考虑的因素。但由于 angr 拥有着丰富的 API，不得不重试其在某些方面的重要性，笔者之所以这里尝试学习 angr 是因为在一次比赛中，通过简单使用 angr 的几个调用，便可以直接将题目秒掉。通过做完这些练手入门题目，发现 angr 至少在逆向这块能发挥出不错的潜能，希望后期可以在多了解 angr 的其他功能。</p>

        </div>

        
            <div class="post-copyright-info my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> angr 学习笔记</li>
        <li><strong>Author:</strong> henry</li>
        <li><strong>Created at
                :</strong> 2024-05-11 22:42:25</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-05-11 22:47:59
            </li>
        
        <li>
            <strong>Link:</strong> https://henrymartin262.github.io/2024/05/11/angr-学习笔记/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/angr/">#angr</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/05/15/winpwn-%E5%85%A5%E9%97%A8/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Windows pwn 入门</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/04/26/CorCTF2022-Corjail/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">CorCTF2022-Corjail</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container pjax">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          requiredMeta: ['nick', 'mail']
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">angr 学习笔记</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#angr-ctf-%E7%AC%94%E8%AE%B0"><span class="nav-text">angr_ctf 笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">一、环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81angr-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-text">二、angr-基本用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#factory-%E5%AE%9E%E7%94%A8%E7%B1%BB%E5%B7%A5%E5%8E%82"><span class="nav-text">factory-实用类工厂</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81angr-%E7%AC%A6%E5%8F%B7%E5%8C%96"><span class="nav-text">三、angr-符号化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Claripy-angr-%E7%9A%84%E6%B1%82%E8%A7%A3%E5%BC%95%E6%93%8E"><span class="nav-text">Claripy - angr 的求解引擎</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81angr-%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6"><span class="nav-text">四、angr-约束条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81angr-%E5%87%BD%E6%95%B0%E6%93%8D%E4%BD%9C"><span class="nav-text">五、angr-函数操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#project-hook-%E5%87%BD%E6%95%B0%E9%92%A9%E5%AD%90"><span class="nav-text">project.hook(): 函数钩子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#angr-SimProcedure-%E6%A8%A1%E6%8B%9F%E5%87%BD%E6%95%B0%EF%BC%88%E8%BF%87%E7%A8%8B%EF%BC%89"><span class="nav-text">angr.SimProcedure - 模拟函数（过程）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81angr-%E8%B7%AF%E5%BE%84%E5%90%88%E5%B9%B6"><span class="nav-text">六、angr-路径合并</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81angr-%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-text">七、angr-库操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81angr-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">八、angr-漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-angr-arbitrary-jump"><span class="nav-text">17_angr_arbitrary_jump</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#stash-%E7%B1%BB%E5%9E%8B"><span class="nav-text">stash 类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stash-%E6%93%8D%E4%BD%9C"><span class="nav-text">stash 操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">henry</a>
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.5.6</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>







<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/libs/anime.min.js"></script>

        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
